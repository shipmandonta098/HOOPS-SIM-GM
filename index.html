<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoops Sim Starter</title>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #111827;
      --panel2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --line: #243041;
      --accent: #60a5fa;
      --good: #34d399;
      --bad: #f87171;
      --warn: #fbbf24;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070a10, #0b0f17 35%, #070a10);
      color: var(--text);
    }
    a { color: inherit; text-decoration: none; }
    button {
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { border-color: #3a4a63; }
    button.primary {
      border-color: rgba(96,165,250,.45);
      background: rgba(96,165,250,.12);
    }
    button.danger {
      border-color: rgba(248,113,113,.45);
      background: rgba(248,113,113,.10);
    }
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      border-right: 1px solid var(--line);
      background: rgba(17,24,39,.65);
      backdrop-filter: blur(10px);
      padding: 18px 14px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 12px;
    }
    .brand .logo {
      width: 36px; height: 36px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.8), rgba(96,165,250,.1));
      border: 1px solid rgba(96,165,250,.35);
      box-shadow: var(--shadow);
    }
    .brand .title { font-weight: 800; letter-spacing: .3px; }
    .brand .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    .nav {
      display: grid;
      gap: 6px;
      margin-top: 12px;
    }
    .nav a {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav a.active {
      color: var(--text);
      border-color: rgba(96,165,250,.35);
      background: rgba(96,165,250,.10);
    }
    .nav a:hover { border-color: #2b3a52; color: var(--text); }

    .main {
      padding: 18px 18px 30px;
      max-width: 1200px;
    }
    .topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .topbar .left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill {
      border: 1px solid var(--line);
      background: rgba(17,24,39,.55);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .pill b { color: var(--text); }
    .grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card {
      grid-column: span 12;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,24,39,.65);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }
    .card .hd h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .card .hd .hint {
      color: var(--muted);
      font-size: 12px;
    }
    .card .bd { padding: 14px; }

    .kpis {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .kpi {
      grid-column: span 6;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(15,23,42,.6);
    }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 800; margin-top: 6px; }
    .kpi .delta { margin-top: 4px; font-size: 12px; color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid rgba(36,48,65,.8);
      font-size: 14px;
    }
    th { color: var(--muted); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: .8px; }
    tr:hover td { background: rgba(96,165,250,.06); }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(156,163,175,.25);
      color: var(--muted);
      background: rgba(15,23,42,.45);
    }
    .tag.good { border-color: rgba(52,211,153,.35); color: #a7f3d0; background: rgba(52,211,153,.08); }
    .tag.bad  { border-color: rgba(248,113,113,.35); color: #fecaca; background: rgba(248,113,113,.08); }

    .log {
      display: grid;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .log .item {
      padding: 10px 12px;
      border: 1px solid rgba(36,48,65,.9);
      border-radius: 12px;
      background: rgba(15,23,42,.55);
    }

    .two { grid-column: span 12; }
    @media (min-width: 900px) {
      .two { grid-column: span 6; }
      .kpi { grid-column: span 3; }
    }

    .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .click { color: var(--accent); cursor: pointer; }
    .click:hover { text-decoration: underline; }

    .saves-section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }
    .saves-section h3 {
      margin: 0 0 10px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      font-weight: 600;
    }
    .saves-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 250px;
      overflow-y: auto;
    }
    .save-item {
      padding: 9px 10px;
      border: 1px solid rgba(96,165,250,.25);
      background: rgba(96,165,250,.08);
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      transition: all 0.2s;
    }
    .save-item:hover {
      border-color: rgba(96,165,250,.5);
      background: rgba(96,165,250,.15);
    }
    .save-item.active {
      border-color: var(--accent);
      background: rgba(96,165,250,.2);
      font-weight: 600;
    }
    .save-item-name {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 3px;
    }
    .save-item-info {
      font-size: 11px;
      color: var(--muted);
    }
    .save-item-actions {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .save-item-actions button {
      padding: 4px 8px;
      font-size: 11px;
      flex: 1;
    }
    .saves-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .saves-actions button {
      width: 100%;
      font-size: 12px;
    }

    .banner {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .banner.warning {
      background: rgba(251,191,36,.1);
      border-color: rgba(251,191,36,.35);
      color: #fcd34d;
    }
    .banner.error {
      background: rgba(248,113,113,.1);
      border-color: rgba(248,113,113,.35);
      color: #fecaca;
    }
    .banner.success {
      background: rgba(52,211,153,.1);
      border-color: rgba(52,211,153,.35);
      color: #a7f3d0;
    }

    /* Title Screen */
    #titleScreen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #070a10, #0b0f17 35%, #070a10);
      backdrop-filter: blur(2px);
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease-out;
    }
    #titleScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #titleScreen .card {
      width: 90%;
      max-width: 420px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,24,39,.85);
      backdrop-filter: blur(10px);
      padding: 40px 30px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    #titleScreen .logo {
      font-size: 56px;
      margin-bottom: 20px;
      display: block;
    }
    #titleScreen h1 {
      margin: 0 0 10px 0;
      font-size: 32px;
      letter-spacing: 0.5px;
    }
    #titleScreen .tagline {
      color: var(--muted);
      font-size: 16px;
      margin: 0 0 30px 0;
      line-height: 1.5;
    }
    #titleScreen .buttons {
      display: flex;
      gap: 10px;
      flex-direction: column;
      margin-bottom: 20px;
    }
    #titleScreen .buttons button {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
    }
    #titleScreen .buttons button.primary {
      width: 100%;
    }
    #titleScreen .buttons button.secondary {
      width: 100%;
    }
    #titleScreen .options {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
    }
    #titleScreen .options label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
    }
    #titleScreen .options input[type="checkbox"] {
      cursor: pointer;
      width: 14px;
      height: 14px;
    }

    /* Mobile sidebar toggle */
    .mobileToggle { display: none; }
    @media (max-width: 820px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: fixed; left: 0; top: 0; width: 290px; transform: translateX(-110%); transition: .2s; z-index: 5; }
      .sidebar.open { transform: translateX(0); }
      .mobileToggle { display: inline-flex; }
      .main { padding-top: 68px; }
      .topbar { position: fixed; top: 0; left: 0; right: 0; padding: 12px 12px; background: rgba(11,15,23,.88); backdrop-filter: blur(12px); border-bottom: 1px solid var(--line); z-index: 4; }
    }
  </style>
</head>
<body>
  <!-- Title Screen Splash -->
  <div id="titleScreen">
    <div class="card">
      <span class="logo">üèÄ</span>
      <h1>Hoops Sim</h1>
      <p class="tagline">Front office dreams, spreadsheet reality.</p>
      <div class="buttons">
        <button id="titleStart" class="primary">Start</button>
        <button id="titleNewLeague" class="danger">New League</button>
      </div>
      <div class="options">
        <label>
          <input type="checkbox" id="titleSkip">
          <span>Skip next time</span>
        </label>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Hoops Sim</div>
          <div class="sub" id="subTitle">offline prototype</div>
        </div>
      </div>

      <div class="nav" id="nav">
        <a href="#home" data-route="home" class="active"><span>üéÆ Home</span><span>‚Ä∫</span></a>
        <a href="#dashboard" data-route="dashboard"><span>üè† Dashboard</span><span>‚Ä∫</span></a>
        <a href="#league" data-route="league"><span>üåç League</span><span>‚Ä∫</span></a>
        <a href="#teams" data-route="teams"><span>üèüÔ∏è Teams</span><span>‚Ä∫</span></a>
        <a href="#players" data-route="players"><span>üßë‚Äçü¶± Players</span><span>‚Ä∫</span></a>
      </div>

      <div class="saves-section">
        <h3>üíæ Saves</h3>
        <div class="saves-list" id="savesList"></div>
        <div class="saves-actions">
          <button id="btnNewSave" class="primary">+ New Save</button>
          <button id="btnExport">Export Current</button>
          <button id="btnImport">Import Save</button>
          <input type="file" id="importFile" accept=".json" style="display:none;">
        </div>
      </div>

      <div style="margin-top:14px; padding:12px; border:1px dashed rgba(156,163,175,.25); border-radius:14px; color:var(--muted); font-size:12px; line-height:1.5;">
        This is a prototype. It‚Äôs not ‚ÄúBasketball GM,‚Äù it‚Äôs the baby version that grows into it.
        Start small: data ‚Üí UI ‚Üí sim.
      </div>
    </aside>

    <main class="main">
      <div id="bannerContainer"></div>
      <div class="topbar">
        <div class="left">
          <button class="mobileToggle" id="toggleSidebar">‚ò∞ Menu</button>
          <div class="pill">üìÖ Day <b id="dayLabel">1</b> <span class="muted">/</span> <span id="seasonLabel">Season 2026</span></div>
          <div class="pill">üíæ Save: <b id="saveStatus">Loading...</b></div>
        </div>
        <div class="row-actions">
          <button id="sim1" class="primary">Sim 1 Day</button>
          <button id="sim7">Sim 1 Week</button>
          <button id="newLeague" class="danger">Reset Save</button>
        </div>
      </div>

      <div id="view"></div>
    </main>
  </div>

  <script>
    /**********************
     * 0) Dexie DB Setup
     **********************/
    let db = null;
    let dbError = false;
    let dbErrorMsg = "";

    class HoopsDB extends Dexie {
      constructor() {
        super("hoops_sim_db");
        this.version(1).stores({
          saves: "id, name, updatedAt",
          leagues: "id"
        });
      }
    }

    async function initDB() {
      try {
        db = new HoopsDB();
        await db.open();
        return true;
      } catch (err) {
        console.warn("IndexedDB unavailable (private mode?), using in-memory storage:", err);
        dbError = true;
        dbErrorMsg = "üìµ Storage failed: using in-memory. Reload to keep data.";
        // Create fake in-memory db
        db = {
          saves: { toArray: async () => inMemorySaves, add: async (s) => { inMemorySaves.push(s); }, update: async () => {}, delete: async () => {} },
          leagues: { where: () => ({ first: async () => null }), add: async () => {}, update: async () => {} }
        };
        return false;
      }
    }

    const CURRENT_SCHEMA_VERSION = 1;
    const inMemorySaves = [];
    const inMemoryLeagues = {};

    /**********************
     * 1) Data + Utilities
     **********************/
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }
    function uuid() {
      return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + randInt(1000, 9999);
    }

    function defaultLeague() {
      const teams = [
        { id: uuid(), name: "New York Knights", abbrev: "NYK", wins: 0, losses: 0, cash: 50_000_000 },
        { id: uuid(), name: "Chicago Comets",  abbrev: "CHI", wins: 0, losses: 0, cash: 50_000_000 },
        { id: uuid(), name: "LA Starlight",    abbrev: "LAS", wins: 0, losses: 0, cash: 50_000_000 },
        { id: uuid(), name: "Miami Tide",      abbrev: "MIA", wins: 0, losses: 0, cash: 50_000_000 },
      ];

      const names = [
        ["Jalen", "Cross"], ["Malik", "Hughes"], ["Theo", "Navarro"], ["Darius", "Cole"],
        ["Andre", "Vaughn"], ["Zion", "Parker"], ["Marcus", "Reed"], ["Kyrie", "Santos"],
        ["Noah", "Okafor"], ["Devin", "Price"], ["Evan", "Knight"], ["Jordan", "Kim"],
      ];

      const positions = ["PG", "SG", "SF", "PF", "C"];

      const players = names.map((n, i) => {
        const team = teams[i % teams.length];
        const ovr = randInt(50, 85);
        const pot = clamp(ovr + randInt(-5, 12), 45, 95);
        const age = randInt(19, 34);
        const salary = randInt(2, 30) * 1_000_000;
        return {
          id: uuid(),
          firstName: n[0],
          lastName: n[1],
          pos: positions[i % positions.length],
          age,
          teamId: team.id,
          ovr,
          pot,
          salary,
          mood: randInt(40, 90),
          stamina: randInt(70, 100),
          stats: { gp: 0, pts: 0, reb: 0, ast: 0 }
        };
      });

      return {
        meta: {
          name: "My League",
          season: 2026,
          day: 1,
          phase: "REGULAR_SEASON",
        },
        teams,
        players,
        log: ["League created."]
      };
    }

    /**********************
     * 2) Schema Migration
     **********************/
    function migrateLeague(league, fromVersion) {
      let version = fromVersion || 0;
      if (version < 1) {
        // Migration to v1: ensure all fields exist
        if (!league.meta) league.meta = { name: "Imported League", season: 2026, day: 1, phase: "REGULAR_SEASON" };
        if (!league.teams) league.teams = [];
        if (!league.players) league.players = [];
        if (!league.log) league.log = [];
        version = 1;
      }
      return league;
    }

    /**********************
     * 3) DB Operations
     **********************/
    async function listSaves() {
      try {
        if (Array.isArray(db.saves.toArray)) {
          return await db.saves.toArray();
        }
        // In-memory fallback
        return inMemorySaves;
      } catch (e) {
        console.error("Error listing saves:", e);
        return [];
      }
    }

    async function createSave(name) {
      const id = uuid();
      const now = Date.now();
      const saveRecord = { id, name, createdAt: now, updatedAt: now, lastOpenedAt: null };
      const league = defaultLeague();
      league.meta.name = name;

      try {
        if (db.saves.add) await db.saves.add(saveRecord);
        if (db.leagues.add) await db.leagues.add({ id, blob: league, schemaVersion: CURRENT_SCHEMA_VERSION });
        if (inMemorySaves && !dbError) inMemorySaves.push(saveRecord);
        if (inMemoryLeagues && dbError) inMemoryLeagues[id] = { id, blob: league, schemaVersion: CURRENT_SCHEMA_VERSION };
      } catch (e) {
        console.error("Error creating save:", e);
        showBanner("error", "‚ùå Failed to create save: " + e.message);
        return null;
      }

      localStorage.setItem("hoops_last_save_id", id);
      return id;
    }

    async function loadSave(id) {
      try {
        let leagueRecord;
        if (db.leagues.where && typeof db.leagues.where === "function") {
          leagueRecord = await db.leagues.where("id").equals(id).first();
        } else if (dbError) {
          leagueRecord = inMemoryLeagues[id];
        }

        if (!leagueRecord) return null;

        let league = leagueRecord.blob;
        const fromVersion = leagueRecord.schemaVersion || 0;
        if (fromVersion < CURRENT_SCHEMA_VERSION) {
          league = migrateLeague(league, fromVersion);
        }

        // Update lastOpenedAt
        const now = Date.now();
        if (db.saves.update) {
          await db.saves.update(id, { lastOpenedAt: now, updatedAt: now });
        } else if (dbError) {
          const save = inMemorySaves.find(s => s.id === id);
          if (save) {
            save.lastOpenedAt = now;
            save.updatedAt = now;
          }
        }

        localStorage.setItem("hoops_last_save_id", id);
        return league;
      } catch (e) {
        console.error("Error loading save:", e);
        showBanner("error", "‚ùå Failed to load save: " + e.message);
        return null;
      }
    }

    async function saveCurrentLeague() {
      if (!state.currentSaveId) return;
      try {
        const now = Date.now();
        if (db.leagues.update) {
          await db.leagues.update(state.currentSaveId, {
            blob: state.league,
            schemaVersion: CURRENT_SCHEMA_VERSION
          });
        } else if (dbError) {
          inMemoryLeagues[state.currentSaveId] = {
            id: state.currentSaveId,
            blob: state.league,
            schemaVersion: CURRENT_SCHEMA_VERSION
          };
        }

        if (db.saves.update) {
          await db.saves.update(state.currentSaveId, { updatedAt: now });
        } else if (dbError) {
          const save = inMemorySaves.find(s => s.id === state.currentSaveId);
          if (save) save.updatedAt = now;
        }

        setSaveStatus("Saved");
        clearTimeout(saveCurrentLeague._t);
        saveCurrentLeague._t = setTimeout(() => setSaveStatus("Loaded"), 900);
      } catch (e) {
        console.error("Error saving league:", e);
        showBanner("error", "‚ùå Auto-save failed: " + e.message);
      }
    }

    async function deleteSave(id) {
      if (!confirm(`Delete save "${id}"?`)) return false;
      try {
        if (db.saves.delete) await db.saves.delete(id);
        if (db.leagues.delete) await db.leagues.delete(id);
        if (dbError) {
          const idx = inMemorySaves.findIndex(s => s.id === id);
          if (idx >= 0) inMemorySaves.splice(idx, 1);
          delete inMemoryLeagues[id];
        }
        showBanner("success", "‚úì Save deleted");
        return true;
      } catch (e) {
        console.error("Error deleting save:", e);
        showBanner("error", "‚ùå Failed to delete save: " + e.message);
        return false;
      }
    }

    async function duplicateSave(id) {
      try {
        const league = await loadSave(id);
        if (!league) return null;
        const saveName = await promptFor("New save name:", `Copy of ${league.meta.name}`);
        if (!saveName) return null;
        const newId = await createSave(saveName);
        if (newId) {
          const deepCopy = JSON.parse(JSON.stringify(league));
          if (db.leagues.update) {
            await db.leagues.update(newId, { blob: deepCopy, schemaVersion: CURRENT_SCHEMA_VERSION });
          } else if (dbError) {
            inMemoryLeagues[newId] = { id: newId, blob: deepCopy, schemaVersion: CURRENT_SCHEMA_VERSION };
          }
          showBanner("success", "‚úì Save duplicated");
        }
        return newId;
      } catch (e) {
        console.error("Error duplicating save:", e);
        showBanner("error", "‚ùå Failed to duplicate save: " + e.message);
        return null;
      }
    }

    /**********************
     * 4) Export / Import
     **********************/
    function exportCurrentLeague() {
      if (!state.league) return;
      const data = {
        name: state.league.meta.name,
        schemaVersion: CURRENT_SCHEMA_VERSION,
        league: state.league,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `hoops-${data.name.replace(/\s+/g, "-")}-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showBanner("success", "‚úì League exported");
    }

    function promptFor(label, defaultVal) {
      return new Promise(resolve => {
        const val = prompt(label, defaultVal);
        resolve(val);
      });
    }

    async function importLeagueFromFile() {
      return new Promise((resolve) => {
        const input = document.getElementById("importFile");
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return resolve(null);
          const reader = new FileReader();
          reader.onload = async (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              let league = data.league || data;
              const fromV = data.schemaVersion || 0;
              league = migrateLeague(league, fromV);

              const saveName = await promptFor("Save name:", data.name || "Imported League");
              if (!saveName) return resolve(null);

              const newId = await createSave(saveName);
              if (newId) {
                if (db.leagues.update) {
                  await db.leagues.update(newId, { blob: league, schemaVersion: CURRENT_SCHEMA_VERSION });
                } else if (dbError) {
                  inMemoryLeagues[newId] = { id: newId, blob: league, schemaVersion: CURRENT_SCHEMA_VERSION };
                }
                showBanner("success", "‚úì League imported");
                input.value = "";
                resolve(newId);
              } else {
                resolve(null);
              }
            } catch (err) {
              console.error("Import error:", err);
              showBanner("error", "‚ùå Invalid file: " + err.message);
              input.value = "";
              resolve(null);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });
    }

    /**********************
     * 5) State + UI Helpers
     **********************/
    const state = {
      route: "dashboard",
      league: null,
      currentSaveId: null,
      selectedTeamId: null,
      selectedPlayerId: null,
      saves: []
    };

    function setSaveStatus(text) {
      document.getElementById("saveStatus").textContent = text;
    }

    function showBanner(type, message) {
      const container = document.getElementById("bannerContainer");
      if (!container) return;
      const banner = document.createElement("div");
      banner.className = `banner ${type}`;
      banner.innerHTML = `
        <span>${message}</span>
        <button style="background:none;border:none;color:inherit;cursor:pointer;font-size:16px;" onclick="this.parentElement.style.display='none';">‚úï</button>
      `;
      container.appendChild(banner);
      setTimeout(() => {
        if (banner.parentElement) banner.style.display = "none";
      }, 4000);
    }

    /**********************
     * 6) Sim Logic
     **********************/
    function teamPower(teamId) {
      const roster = state.league.players.filter(p => p.teamId === teamId);
      const sorted = [...roster].sort((a,b) => b.ovr - a.ovr);
      const top = sorted.slice(0, 3);
      const rest = sorted.slice(3);
      const topAvg = top.length ? top.reduce((s,p)=>s+p.ovr,0)/top.length : 0;
      const restAvg = rest.length ? rest.reduce((s,p)=>s+p.ovr,0)/rest.length : topAvg;
      return (topAvg * 0.65) + (restAvg * 0.35);
    }

    function simulateOneGame(teamA, teamB) {
      const aPow = teamPower(teamA.id) + randInt(-6, 6);
      const bPow = teamPower(teamB.id) + randInt(-6, 6);
      const aPts = clamp(Math.round(95 + (aPow - 60) * 1.2 + randInt(-10, 10)), 70, 145);
      const bPts = clamp(Math.round(95 + (bPow - 60) * 1.2 + randInt(-10, 10)), 70, 145);

      let winner = teamA, loser = teamB, wPts = aPts, lPts = bPts;
      if (bPts > aPts) { winner = teamB; loser = teamA; wPts = bPts; lPts = aPts; }
      if (bPts === aPts) {
        if (Math.random() < 0.5) { winner = teamB; loser = teamA; wPts = bPts + 1; lPts = aPts; }
        else { wPts = aPts + 1; lPts = bPts; }
      }

      winner.wins += 1;
      loser.losses += 1;
      distributeStats(winner.id, true);
      distributeStats(loser.id, false);

      return `${winner.abbrev} ${wPts} ‚Äî ${loser.abbrev} ${lPts}`;
    }

    function distributeStats(teamId, won) {
      const roster = state.league.players.filter(p => p.teamId === teamId).sort((a,b) => b.ovr - a.ovr);
      const top = roster.slice(0, 3);
      const others = roster.slice(3);
      const teamPts = randInt(90, 130);

      function addLine(p) {
        const shareMin = top.includes(p) ? 18 : 10;
        const shareMax = top.includes(p) ? 30 : 18;
        const pts = clamp(Math.round(teamPts * (randInt(shareMin, shareMax)/100)), 6, 45);
        p.stats.gp += 1;
        p.stats.pts += pts;
        p.stats.reb += randInt(1, 12);
        p.stats.ast += randInt(0, 11);
        p.mood = clamp(p.mood + (won ? randInt(0,2) : -randInt(0,2)), 0, 100);
        p.stamina = clamp(p.stamina - randInt(2, 6), 0, 100);
      }

      top.forEach(p => addLine(p));
      others.slice(0, 2).forEach(p => addLine(p));
    }

    function simDay() {
      const { meta, teams } = state.league;
      state.league.players.forEach(p => {
        p.stamina = clamp(p.stamina + randInt(1, 4), 0, 100);
      });

      const shuffled = [...teams].sort(() => Math.random() - 0.5);
      const games = [];
      for (let i = 0; i + 1 < shuffled.length; i += 2) {
        games.push(simulateOneGame(shuffled[i], shuffled[i+1]));
      }

      meta.day += 1;
      if (meta.day > 112) {
        meta.day = 1;
        meta.season += 1;
        teams.forEach(t => { t.wins = 0; t.losses = 0; });
        state.league.log.unshift(`Season advanced to ${meta.season}. Records reset.`);
      }

      state.league.log.unshift(`Day simmed: ${games.join(" | ")}`);
      if (state.league.log.length > 25) state.league.log.length = 25;

      debounceAutoSave();
      render();
    }

    // Debounced autosave
    function debounceAutoSave() {
      clearTimeout(debounceAutoSave._t);
      debounceAutoSave._t = setTimeout(() => saveCurrentLeague(), 300);
    }

    /**********************
     * 4) Views
     **********************/
    function money(n) {
      return "$" + Math.round(n).toLocaleString();
    }
    function playerName(p) {
      return `${p.firstName} ${p.lastName}`;
    }
    function teamById(id) {
      return state.league.teams.find(t => t.id === id);
    }

    function viewHome() {
      if (!state.league) {
        return `
          <div class="grid">
            <div class="card" style="grid-column: span 12; min-height: 200px; display: flex; align-items: center; justify-content: center;">
              <div style="text-align: center;">
                <h1 style="margin: 0 0 10px 0;">üèÄ Hoops Sim</h1>
                <p style="color: var(--muted); margin: 0 0 20px 0; font-size: 16px;">Front office dreams, spreadsheet reality.</p>
                <button id="homeLoadSave" class="primary" style="padding: 12px 24px; margin: 0 10px;">Load Save</button>
                <button id="homeNewSave" class="primary" style="padding: 12px 24px; margin: 0 10px;">New Save</button>
              </div>
            </div>
          </div>
        `;
      }

      const { meta, teams, players, log } = state.league;
      const totalPayroll = players.reduce((s,p)=>s+p.salary,0);
      const bestTeam = [...teams].sort((a,b) => (b.wins-b.losses) - (a.wins-a.losses))[0];
      const topPlayer = [...players].sort((a,b) => b.ovr - a.ovr)[0];

      return `
        <div class="grid">
          <div class="card" style="grid-column: span 12;">
            <div class="bd" style="text-align: center; padding: 24px;">
              <h1 style="margin: 0 0 10px 0; font-size: 32px;">üèÄ Hoops Sim</h1>
              <p style="color: var(--muted); margin: 0 0 20px 0; font-size: 16px;">Front office dreams, spreadsheet reality.</p>
              <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="homeContinue" class="primary" style="padding: 12px 20px;">Continue</button>
                <button id="homeNewLeague" class="danger" style="padding: 12px 20px;">New League</button>
                <button id="homeLoadSave" style="padding: 12px 20px;">Load League</button>
                <button id="homeExport" style="padding: 12px 20px;">Export</button>
                <button id="homeImport" style="padding: 12px 20px;">Import</button>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>Current Save</h2>
              <div class="hint">${escapeHtml(meta.name)}</div>
            </div>
            <div class="bd">
              <div class="kpis">
                <div class="kpi">
                  <div class="label">Season</div>
                  <div class="value">${meta.season}</div>
                  <div class="delta">Day ${meta.day}</div>
                </div>
                <div class="kpi">
                  <div class="label">Teams</div>
                  <div class="value">${teams.length}</div>
                  <div class="delta">Franchises</div>
                </div>
                <div class="kpi">
                  <div class="label">Players</div>
                  <div class="value">${players.length}</div>
                  <div class="delta">Roster spots</div>
                </div>
                <div class="kpi">
                  <div class="label">Payroll</div>
                  <div class="value">${money(totalPayroll)}</div>
                  <div class="delta">Total spend</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>At a Glance</h2>
              <div class="hint">Best team & top player</div>
            </div>
            <div class="bd">
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 6px;">Best Team</div>
                <div style="font-size: 14px;">
                  <b>${escapeHtml(bestTeam.name)}</b> <span class="tag">${bestTeam.abbrev}</span>
                  <span class="muted" style="display: block; margin-top: 4px;">${bestTeam.wins}‚Äì${bestTeam.losses} ¬∑ Power: ${teamPower(bestTeam.id).toFixed(1)}</span>
                </div>
              </div>
              <hr style="border: none; border-top: 1px solid var(--line); margin: 12px 0;">
              <div>
                <div style="font-weight: 600; margin-bottom: 6px;">Top Player</div>
                <div style="font-size: 14px;">
                  <b>${escapeHtml(playerName(topPlayer))}</b> <span class="tag">${topPlayer.pos}</span>
                  <div class="muted" style="margin-top: 4px; font-size: 13px;">
                    ${escapeHtml(teamById(topPlayer.teamId).name)} ¬∑ OVR ${topPlayer.ovr} / POT ${topPlayer.pot}
                    <br/>Salary: ${money(topPlayer.salary)} ¬∑ Mood: ${topPlayer.mood} ¬∑ Stam: ${topPlayer.stamina}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>Recent Log</h2>
              <div class="hint">Last 8 events</div>
            </div>
            <div class="bd">
              <div class="log">
                ${log.slice(0, 8).map(x => `<div class="item">üìù ${escapeHtml(x)}</div>`).join("") || `<div class="item">No events yet.</div>`}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function viewDashboard() {
      const { meta, teams, players, log } = state.league;

      const totalPayroll = players.reduce((s,p)=>s+p.salary,0);
      const bestTeam = [...teams].sort((a,b) => (b.wins-b.losses) - (a.wins-a.losses))[0];
      const topPlayer = [...players].sort((a,b) => b.ovr - a.ovr)[0];

      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>League Snapshot</h2>
              <div class="hint">The ‚Äústart simple‚Äù era.</div>
            </div>
            <div class="bd">
              <div class="kpis">
                <div class="kpi">
                  <div class="label">League</div>
                  <div class="value">${meta.name}</div>
                  <div class="delta">Phase: ${meta.phase}</div>
                </div>
                <div class="kpi">
                  <div class="label">Teams</div>
                  <div class="value">${teams.length}</div>
                  <div class="delta">Tiny league for a tiny prototype</div>
                </div>
                <div class="kpi">
                  <div class="label">Players</div>
                  <div class="value">${players.length}</div>
                  <div class="delta">Enough to test rosters</div>
                </div>
                <div class="kpi">
                  <div class="label">Total Payroll</div>
                  <div class="value">${money(totalPayroll)}</div>
                  <div class="delta">A very fake economy</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>Standings</h2>
              <div class="hint">Click a team on the Teams page for details.</div>
            </div>
            <div class="bd">
              ${standingsTable()}
              <div class="muted" style="margin-top:10px;">
                Best team right now: <b>${bestTeam.name}</b>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>Top Player</h2>
              <div class="hint">Because we all worship at the altar of OVR.</div>
            </div>
            <div class="bd">
              <div style="font-size:18px; font-weight:800;">${playerName(topPlayer)} <span class="tag">${topPlayer.pos}</span></div>
              <div class="muted" style="margin-top:6px;">
                Team: <b>${teamById(topPlayer.teamId).name}</b><br/>
                OVR: <b>${topPlayer.ovr}</b> ¬∑ POT: <b>${topPlayer.pot}</b> ¬∑ Age: <b>${topPlayer.age}</b><br/>
                Salary: <b>${money(topPlayer.salary)}</b> ¬∑ Mood: <b>${topPlayer.mood}</b> ¬∑ Stamina: <b>${topPlayer.stamina}</b>
              </div>
              <div class="muted" style="margin-top:10px;">
                Stats (total): ${topPlayer.stats.gp} GP ¬∑ ${topPlayer.stats.pts} PTS ¬∑ ${topPlayer.stats.reb} REB ¬∑ ${topPlayer.stats.ast} AST
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>League Log</h2>
              <div class="hint">Most recent on top</div>
            </div>
            <div class="bd">
              <div class="log">
                ${log.map(x => `<div class="item">üìù ${escapeHtml(x)}</div>`).join("") || `<div class="item">No events yet.</div>`}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function standingsTable() {
      const teams = [...state.league.teams].sort((a,b) => b.wins - a.wins || a.losses - b.losses);
      return `
        <table>
          <thead>
            <tr><th>Team</th><th>W</th><th>L</th><th>Power</th></tr>
          </thead>
          <tbody>
            ${teams.map(t => `
              <tr>
                <td><span class="click" data-team="${t.id}">${escapeHtml(t.name)}</span> <span class="tag">${t.abbrev}</span></td>
                <td>${t.wins}</td>
                <td>${t.losses}</td>
                <td>${teamPower(t.id).toFixed(1)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function viewLeague() {
      const { meta } = state.league;
      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>League Settings</h2>
              <div class="hint">Editable settings come later (after we don‚Äôt crash).</div>
            </div>
            <div class="bd">
              <div class="muted" style="line-height:1.7;">
                <b>Name:</b> ${escapeHtml(meta.name)}<br/>
                <b>Season:</b> ${meta.season}<br/>
                <b>Day:</b> ${meta.day}<br/>
                <b>Phase:</b> ${meta.phase}<br/><br/>
                Roadmap idea: Draft ‚Üí Contracts ‚Üí Trades ‚Üí Free Agency ‚Üí Playoffs.
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function viewTeams() {
      const teams = [...state.league.teams].sort((a,b)=>a.name.localeCompare(b.name));
      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>Teams</h2>
              <div class="hint">Click a team name to see roster</div>
            </div>
            <div class="bd">
              <table>
                <thead>
                  <tr><th>Team</th><th>Record</th><th>Payroll</th><th>Cash</th></tr>
                </thead>
                <tbody>
                  ${teams.map(t => {
                    const payroll = state.league.players.filter(p=>p.teamId===t.id).reduce((s,p)=>s+p.salary,0);
                    return `
                      <tr>
                        <td><span class="click" data-team="${t.id}">${escapeHtml(t.name)}</span> <span class="tag">${t.abbrev}</span></td>
                        <td>${t.wins}-${t.losses}</td>
                        <td>${money(payroll)}</td>
                        <td>${money(t.cash)}</td>
                      </tr>
                    `;
                  }).join("")}
                </tbody>
              </table>
            </div>
          </div>

          ${state.selectedTeamId ? teamDetailCard(state.selectedTeamId) : `
            <div class="card">
              <div class="hd"><h2>Team Detail</h2><div class="hint">Select a team above</div></div>
              <div class="bd"><span class="muted">No team selected.</span></div>
            </div>
          `}
        </div>
      `;
    }

    function teamDetailCard(teamId) {
      const t = teamById(teamId);
      if (!t) return "";
      const roster = state.league.players.filter(p=>p.teamId===teamId).sort((a,b)=>b.ovr-a.ovr);
      const payroll = roster.reduce((s,p)=>s+p.salary,0);

      return `
        <div class="card">
          <div class="hd">
            <h2>${escapeHtml(t.name)} Roster</h2>
            <div class="hint">Power: ${teamPower(teamId).toFixed(1)} ¬∑ Payroll: ${money(payroll)}</div>
          </div>
          <div class="bd">
            <table>
              <thead>
                <tr><th>Player</th><th>Pos</th><th>Age</th><th>OVR</th><th>POT</th><th>Salary</th><th>Mood</th><th>Stam</th></tr>
              </thead>
              <tbody>
                ${roster.map(p => `
                  <tr>
                    <td><span class="click" data-player="${p.id}">${escapeHtml(playerName(p))}</span></td>
                    <td>${p.pos}</td>
                    <td>${p.age}</td>
                    <td>${p.ovr}</td>
                    <td>${p.pot}</td>
                    <td>${money(p.salary)}</td>
                    <td><span class="tag ${p.mood >= 60 ? "good" : "bad"}">${p.mood}</span></td>
                    <td>${p.stamina}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function viewPlayers() {
      const players = [...state.league.players].sort((a,b)=>b.ovr-a.ovr);
      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>Players</h2>
              <div class="hint">Click a player for detail</div>
            </div>
            <div class="bd">
              <table>
                <thead>
                  <tr><th>Player</th><th>Team</th><th>Pos</th><th>Age</th><th>OVR</th><th>POT</th><th>Salary</th><th>GP</th><th>PTS</th></tr>
                </thead>
                <tbody>
                  ${players.map(p => {
                    const t = teamById(p.teamId);
                    return `
                      <tr>
                        <td><span class="click" data-player="${p.id}">${escapeHtml(playerName(p))}</span></td>
                        <td>${escapeHtml(t.name)} <span class="tag">${t.abbrev}</span></td>
                        <td>${p.pos}</td>
                        <td>${p.age}</td>
                        <td>${p.ovr}</td>
                        <td>${p.pot}</td>
                        <td>${money(p.salary)}</td>
                        <td>${p.stats.gp}</td>
                        <td>${p.stats.pts}</td>
                      </tr>
                    `;
                  }).join("")}
                </tbody>
              </table>
            </div>
          </div>

          ${state.selectedPlayerId ? playerDetailCard(state.selectedPlayerId) : `
            <div class="card">
              <div class="hd"><h2>Player Detail</h2><div class="hint">Select a player above</div></div>
              <div class="bd"><span class="muted">No player selected.</span></div>
            </div>
          `}
        </div>
      `;
    }

    function playerDetailCard(playerId) {
      const p = state.league.players.find(x => x.id === playerId);
      if (!p) return "";
      const t = teamById(p.teamId);
      return `
        <div class="card">
          <div class="hd">
            <h2>${escapeHtml(playerName(p))} <span class="tag">${p.pos}</span></h2>
            <div class="hint">${escapeHtml(t.name)} ¬∑ Salary ${money(p.salary)}</div>
          </div>
          <div class="bd">
            <div class="kpis">
              <div class="kpi"><div class="label">OVR</div><div class="value">${p.ovr}</div><div class="delta">Overall rating</div></div>
              <div class="kpi"><div class="label">POT</div><div class="value">${p.pot}</div><div class="delta">Potential</div></div>
              <div class="kpi"><div class="label">Mood</div><div class="value">${p.mood}</div><div class="delta">0‚Äì100</div></div>
              <div class="kpi"><div class="label">Stamina</div><div class="value">${p.stamina}</div><div class="delta">0‚Äì100</div></div>
            </div>

            <div style="margin-top:14px; line-height:1.7;" class="muted">
              Age: <b>${p.age}</b><br/>
              Games: <b>${p.stats.gp}</b><br/>
              Totals: <b>${p.stats.pts}</b> PTS ¬∑ <b>${p.stats.reb}</b> REB ¬∑ <b>${p.stats.ast}</b> AST<br/>
              (Later you‚Äôll want per-game stats + advanced stats.)
            </div>
          </div>
        </div>
      `;
    }

    /**********************
     * 8) Rendering + Router
     **********************/
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[s]));
    }

    function setRoute(route) {
      state.route = route;
      document.querySelectorAll("#nav a").forEach(a => {
        a.classList.toggle("active", a.dataset.route === route);
      });
      render();
    }

    function render() {
      // Home screen can render without a league
      if (state.route !== "home" && !state.league) return;
      
      const view = document.getElementById("view");
      
      if (state.route === "home") {
        view.innerHTML = viewHome();
      } else {
        const { meta } = state.league;
        document.getElementById("dayLabel").textContent = meta.day;
        document.getElementById("seasonLabel").textContent = `Season ${meta.season}`;
        document.getElementById("subTitle").textContent = `${meta.name.toLowerCase()} ¬∑ v0.1`;
        
        if (state.route === "dashboard") view.innerHTML = viewDashboard();
        else if (state.route === "league") view.innerHTML = viewLeague();
        else if (state.route === "teams") view.innerHTML = viewTeams();
        else if (state.route === "players") view.innerHTML = viewPlayers();
        else view.innerHTML = `<div class="card"><div class="bd">Unknown route.</div></div>`;
      }

      // Add event listeners for home screen
      if (state.route === "home") {
        const continueBtn = document.getElementById("homeContinue");
        const newLeagueBtn = document.getElementById("homeNewLeague");
        const loadSaveBtn = document.getElementById("homeLoadSave");
        const exportBtn = document.getElementById("homeExport");
        const importBtn = document.getElementById("homeImport");
        const newSaveBtn = document.getElementById("homeNewSave");

        if (continueBtn) continueBtn.addEventListener("click", () => setRoute("dashboard"));
        if (newLeagueBtn) newLeagueBtn.addEventListener("click", homeResetLeague);
        if (loadSaveBtn) loadSaveBtn.addEventListener("click", homeLoadSave);
        if (exportBtn) exportBtn.addEventListener("click", homeExport);
        if (importBtn) importBtn.addEventListener("click", homeImport);
        if (newSaveBtn) newSaveBtn.addEventListener("click", homeNewSave);
      }

      // wire click handlers inside rendered content
      view.querySelectorAll("[data-team]").forEach(el => {
        el.addEventListener("click", () => {
          state.selectedTeamId = el.dataset.team;
          state.route = "teams";
          setRoute("teams");
        });
      });
      view.querySelectorAll("[data-player]").forEach(el => {
        el.addEventListener("click", () => {
          state.selectedPlayerId = el.dataset.player;
          state.route = "players";
          setRoute("players");
        });
      });
    }

    // Home screen event handlers
    async function homeResetLeague() {
      if (!state.currentSaveId) {
        showBanner("error", "‚ùå No save open");
        return;
      }
      if (!confirm("Reset this save's league?")) return;
      state.league = defaultLeague();
      state.league.meta.name = (await listSaves()).find(s => s.id === state.currentSaveId)?.name || "League";
      state.selectedTeamId = null;
      state.selectedPlayerId = null;
      await saveCurrentLeague();
      render();
      showBanner("success", "‚úì League reset");
    }

    async function homeLoadSave() {
      const saves = await listSaves();
      if (!saves.length) {
        showBanner("error", "‚ùå No saves found");
        return;
      }
      // For now, just navigate to sidebar - user can click in saves list
      // Alternatively, we can show a modal, but keeping it simple
      setRoute("dashboard");
    }

    function homeExport() {
      if (!state.league) {
        showBanner("error", "‚ùå No league to export");
        return;
      }
      exportCurrentLeague();
    }

    async function homeImport() {
      const newId = await importLeagueFromFile();
      if (newId) {
        const league = await loadSave(newId);
        if (league) {
          state.league = league;
          state.currentSaveId = newId;
          setSaveStatus("Loaded");
          render();
          await refillSavesList();
        }
      }
    }

    async function homeNewSave() {
      const name = await promptFor("Save name:", "New League");
      if (!name) return;
      const id = await createSave(name);
      if (id) {
        state.league = defaultLeague();
        state.league.meta.name = name;
        state.currentSaveId = id;
        setSaveStatus("Loaded");
        render();
        await refillSavesList();
      }
    }

    async function refillSavesList() {
      const savesList = document.getElementById("savesList");
      if (!savesList) return;
      const saves = await listSaves();
      saves.sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));

      savesList.innerHTML = saves.map(s => {
        const active = s.id === state.currentSaveId ? "active" : "";
        const date = s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : "?";
        return `
          <div class="save-item ${active}" data-save-id="${s.id}">
            <div class="save-item-name">${escapeHtml(s.name)}</div>
            <div class="save-item-info">${date}</div>
            <div class="save-item-actions">
              <button data-action="load" title="Load">üìÇ</button>
              <button data-action="dup" title="Duplicate">üìã</button>
              <button data-action="del" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join("");

      savesList.querySelectorAll(".save-item").forEach(item => {
        const saveId = item.dataset.saveId;
        item.querySelector("[data-action='load']").onclick = async (e) => {
          e.stopPropagation();
          const league = await loadSave(saveId);
          if (league) {
            state.league = league;
            state.currentSaveId = saveId;
            setSaveStatus("Loaded");
            render();
            refillSavesList();
          }
        };
        item.querySelector("[data-action='dup']").onclick = async (e) => {
          e.stopPropagation();
          const newId = await duplicateSave(saveId);
          if (newId) refillSavesList();
        };
        item.querySelector("[data-action='del']").onclick = async (e) => {
          e.stopPropagation();
          const ok = await deleteSave(saveId);
          if (ok) {
            if (state.currentSaveId === saveId) {
              state.currentSaveId = null;
              state.league = null;
              setSaveStatus("No save");
              render();
            }
            refillSavesList();
          }
        };
      });
    }

    /**********************
     * 9) UI Events
     **********************/
    document.getElementById("nav").addEventListener("click", (e) => {
      const a = e.target.closest("a[data-route]");
      if (!a) return;
      e.preventDefault();
      setRoute(a.dataset.route);
      document.getElementById("sidebar").classList.remove("open");
    });

    document.getElementById("sim1").addEventListener("click", simDay);
    document.getElementById("sim7").addEventListener("click", () => { for (let i=0;i<7;i++) simDay(); });

    document.getElementById("newLeague").addEventListener("click", async () => {
      if (!state.currentSaveId) {
        showBanner("error", "‚ùå No save open");
        return;
      }
      if (!confirm("Reset this save's league?")) return;
      state.league = defaultLeague();
      state.league.meta.name = (await listSaves()).find(s => s.id === state.currentSaveId)?.name || "League";
      state.selectedTeamId = null;
      state.selectedPlayerId = null;
      await saveCurrentLeague();
      render();
      showBanner("success", "‚úì League reset");
    });

    document.getElementById("toggleSidebar").addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("open");
    });

    document.getElementById("btnNewSave").addEventListener("click", async () => {
      const name = await promptFor("Save name:", "New League");
      if (!name) return;
      const id = await createSave(name);
      if (id) {
        state.league = defaultLeague();
        state.league.meta.name = name;
        state.currentSaveId = id;
        setSaveStatus("Loaded");
        render();
        await refillSavesList();
      }
    });

    document.getElementById("btnExport").addEventListener("click", () => {
      if (!state.league) {
        showBanner("error", "‚ùå No save open");
        return;
      }
      exportCurrentLeague();
    });

    document.getElementById("btnImport").addEventListener("click", async () => {
      const newId = await importLeagueFromFile();
      if (newId) {
        const league = await loadSave(newId);
        if (league) {
          state.league = league;
          state.currentSaveId = newId;
          setSaveStatus("Loaded");
          render();
          await refillSavesList();
        }
      }
    });

    // Hash routing
    window.addEventListener("hashchange", () => {
      const route = (location.hash || "#home").replace("#","").trim();
      const known = ["home","dashboard","league","teams","players"];
      setRoute(known.includes(route) ? route : "home");
    });

    // Title Screen Logic
    function hideTitleScreen() {
      const titleScreen = document.getElementById("titleScreen");
      if (titleScreen) {
        titleScreen.classList.add("hidden");
        setTimeout(() => {
          titleScreen.style.display = "none";
        }, 300);
      }
    }

    // Initialization
    (async () => {
      // Check if user wants to skip title screen
      const skipTitle = localStorage.getItem("hoops_skip_title") === "1";
      
      setSaveStatus("Loading...");
      await initDB();
      
      if (dbError) {
        showBanner("warning", dbErrorMsg);
      }

      // Try to load last opened save
      let lastId = localStorage.getItem("hoops_last_save_id");
      let saves = await listSaves();
      
      if (!saves.length) {
        // First run: create default save
        lastId = await createSave("My League");
      }

      if (lastId && saves.find(s => s.id === lastId)) {
        const league = await loadSave(lastId);
        if (league) {
          state.league = league;
          state.currentSaveId = lastId;
          setSaveStatus("Loaded");
        }
      } else if (saves.length > 0) {
        // Load the most recent save
        saves.sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        const league = await loadSave(saves[0].id);
        if (league) {
          state.league = league;
          state.currentSaveId = saves[0].id;
          setSaveStatus("Loaded");
        }
      }

      if (!state.league) {
        showBanner("error", "‚ùå Failed to load league");
        state.league = defaultLeague();
        setSaveStatus("Offline mode");
      }

      await refillSavesList();

      // Set up title screen buttons
      const titleStart = document.getElementById("titleStart");
      const titleNewLeague = document.getElementById("titleNewLeague");
      const titleSkipCheckbox = document.getElementById("titleSkip");

      if (titleStart) {
        titleStart.addEventListener("click", () => {
          // Save skip preference
          if (titleSkipCheckbox && titleSkipCheckbox.checked) {
            localStorage.setItem("hoops_skip_title", "1");
          }
          hideTitleScreen();
          // Route to home
          const route = (location.hash || "#home").replace("#","").trim();
          const known = ["home","dashboard","league","teams","players"];
          setRoute(known.includes(route) ? route : "home");
        });
      }

      if (titleNewLeague) {
        titleNewLeague.addEventListener("click", async () => {
          if (titleSkipCheckbox && titleSkipCheckbox.checked) {
            localStorage.setItem("hoops_skip_title", "1");
          }
          // Create new save
          const name = await promptFor("Save name:", "New League");
          if (name) {
            const newId = await createSave(name);
            if (newId) {
              state.league = defaultLeague();
              state.league.meta.name = name;
              state.currentSaveId = newId;
              setSaveStatus("Loaded");
              await refillSavesList();
              hideTitleScreen();
              setRoute("home");
            }
          }
        });
      }

      // If user wants to skip title screen, hide it immediately
      if (skipTitle) {
        hideTitleScreen();
      }

      // Initial route
      const route = (location.hash || "#home").replace("#","").trim();
      const known = ["home","dashboard","league","teams","players"];
      setRoute(known.includes(route) ? route : "home");
    })();
  </script>
</body>
</html>
