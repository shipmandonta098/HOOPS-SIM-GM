<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoops Sim Starter</title>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #111827;
      --panel2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --line: #243041;
      --accent: #60a5fa;
      --good: #34d399;
      --bad: #f87171;
      --warn: #fbbf24;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070a10, #0b0f17 35%, #070a10);
      color: var(--text);
    }
    a { color: inherit; text-decoration: none; }
    button {
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { border-color: #3a4a63; }
    button.primary {
      border-color: rgba(96,165,250,.45);
      background: rgba(96,165,250,.12);
    }
    button.danger {
      border-color: rgba(248,113,113,.45);
      background: rgba(248,113,113,.10);
    }
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      border-right: 1px solid var(--line);
      background: rgba(17,24,39,.65);
      backdrop-filter: blur(10px);
      padding: 18px 14px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 12px;
    }
    .brand .logo {
      width: 36px; height: 36px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.8), rgba(96,165,250,.1));
      border: 1px solid rgba(96,165,250,.35);
      box-shadow: var(--shadow);
    }
    .brand .title { font-weight: 800; letter-spacing: .3px; }
    .brand .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    .nav {
      display: grid;
      gap: 6px;
      margin-top: 12px;
    }
    .nav a {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav a.active {
      color: var(--text);
      border-color: rgba(96,165,250,.35);
      background: rgba(96,165,250,.10);
    }
    .nav a:hover { border-color: #2b3a52; color: var(--text); }

    .main {
      padding: 18px 18px 30px;
      max-width: 1200px;
    }
    .topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .topbar .left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill {
      border: 1px solid var(--line);
      background: rgba(17,24,39,.55);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .pill b { color: var(--text); }
    .grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card {
      grid-column: span 12;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,24,39,.65);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }
    .card .hd h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .card .hd .hint {
      color: var(--muted);
      font-size: 12px;
    }
    .card .bd { padding: 14px; }

    .kpis {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .kpi {
      grid-column: span 6;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(15,23,42,.6);
    }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 800; margin-top: 6px; }
    .kpi .delta { margin-top: 4px; font-size: 12px; color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid rgba(36,48,65,.8);
      font-size: 14px;
    }
    th { color: var(--muted); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: .8px; }
    tr:hover td { background: rgba(96,165,250,.06); }

    svg {
      vertical-align: middle;
      display: inline-block;
      margin-right: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(156,163,175,.25);
      color: var(--muted);
      background: rgba(15,23,42,.45);
    }
    .tag.good { border-color: rgba(52,211,153,.35); color: #a7f3d0; background: rgba(52,211,153,.08); }
    .tag.bad  { border-color: rgba(248,113,113,.35); color: #fecaca; background: rgba(248,113,113,.08); }

    .log {
      display: grid;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .log .item {
      padding: 10px 12px;
      border: 1px solid rgba(36,48,65,.9);
      border-radius: 12px;
      background: rgba(15,23,42,.55);
    }

    .two { grid-column: span 12; }
    @media (min-width: 900px) {
      .two { grid-column: span 6; }
      .kpi { grid-column: span 3; }
    }

    .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .click { color: var(--accent); cursor: pointer; }
    .click:hover { text-decoration: underline; }

    .saves-section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }
    .saves-section h3 {
      margin: 0 0 10px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      font-weight: 600;
    }
    .saves-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 250px;
      overflow-y: auto;
    }
    .save-item {
      padding: 9px 10px;
      border: 1px solid rgba(96,165,250,.25);
      background: rgba(96,165,250,.08);
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      transition: all 0.2s;
    }
    .save-item:hover {
      border-color: rgba(96,165,250,.5);
      background: rgba(96,165,250,.15);
    }
    .save-item.active {
      border-color: var(--accent);
      background: rgba(96,165,250,.2);
      font-weight: 600;
    }
    .save-item-name {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 3px;
    }
    .save-item-info {
      font-size: 11px;
      color: var(--muted);
    }
    .save-item-actions {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .save-item-actions button {
      padding: 4px 8px;
      font-size: 11px;
      flex: 1;
    }
    .saves-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .saves-actions button {
      width: 100%;
      font-size: 12px;
    }

    .banner {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .banner.warning {
      background: rgba(251,191,36,.1);
      border-color: rgba(251,191,36,.35);
      color: #fcd34d;
    }
    .banner.error {
      background: rgba(248,113,113,.1);
      border-color: rgba(248,113,113,.35);
      color: #fecaca;
    }
    .banner.success {
      background: rgba(52,211,153,.1);
      border-color: rgba(52,211,153,.35);
      color: #a7f3d0;
    }

    /* Title Screen */
    /* Full-Screen Immersive Title Screen */
    #titleScreen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease-out;
      overflow: hidden;
    }

    #titleScreen::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 40%, rgba(96, 165, 250, 0.15), transparent 60%),
                  linear-gradient(135deg, #070a10 0%, #0b0f17 35%, #0a0d15 70%, #050608 100%);
      z-index: 1;
    }

    #titleScreen::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.6) 100%);
      z-index: 1;
      pointer-events: none;
    }

    #titleScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #titleScreen .content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: min(720px, 88vw);
      padding: 40px 20px;
      text-align: center;
    }

    #titleScreen .title-stack {
      margin-bottom: 24px;
    }

    #titleScreen .title-word {
      font-size: clamp(52px, 8vw, 110px);
      font-weight: 900;
      line-height: 1;
      letter-spacing: -1px;
      margin: 0;
      background: linear-gradient(135deg, #60a5fa 0%, #93c5fd 50%, #60a5fa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(96, 165, 250, 0.3);
    }

    #titleScreen .subtitle {
      font-size: clamp(16px, 2.2vw, 24px);
      color: rgba(229, 231, 235, 0.7);
      margin: 32px 0 60px 0;
      font-weight: 400;
      letter-spacing: 0.3px;
      line-height: 1.6;
    }

    #titleScreen .cta-button {
      width: min(560px, 88vw);
      height: 70px;
      border: none;
      border-radius: 22px;
      font-size: clamp(18px, 2.5vw, 24px);
      font-weight: 700;
      letter-spacing: 0.5px;
      cursor: pointer;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 0 40px rgba(96, 165, 250, 0.5),
                  0 20px 40px rgba(96, 165, 250, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    #titleScreen .cta-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }

    #titleScreen .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 60px rgba(96, 165, 250, 0.7),
                  0 30px 50px rgba(96, 165, 250, 0.4),
                  inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    #titleScreen .cta-button:hover::before {
      left: 100%;
    }

    #titleScreen .cta-button:active {
      transform: translateY(-1px);
    }

    #titleScreen .skip-section {
      margin-top: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #titleScreen .skip-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      color: rgba(229, 231, 235, 0.5);
      transition: color 0.2s ease;
    }

    #titleScreen .skip-label:hover {
      color: rgba(229, 231, 235, 0.7);
    }

    #titleScreen .skip-label input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: #60a5fa;
    }

    /* Front Office Menu */
    #frontOfficeMenu {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #070a10, #0b0f17 35%, #070a10);
      backdrop-filter: blur(2px);
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease-out;
    }
    #frontOfficeMenu.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #frontOfficeMenu .card {
      width: 90%;
      max-width: 480px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,24,39,.85);
      backdrop-filter: blur(10px);
      padding: 40px 30px;
      box-shadow: var(--shadow);
    }
    #frontOfficeMenu h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      letter-spacing: 0.5px;
    }
    #frontOfficeMenu .subtext {
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 30px 0;
    }
    #frontOfficeMenu .main-buttons {
      display: flex;
      gap: 10px;
      flex-direction: column;
      margin-bottom: 20px;
    }
    #frontOfficeMenu .main-buttons button {
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 600;
      width: 100%;
    }
    #frontOfficeMenu .secondary-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    #frontOfficeMenu .secondary-buttons button {
      padding: 10px 12px;
      font-size: 12px;
    }
    #frontOfficeMenu #foLoadLeague {
      display: none;
    }
    #frontOfficeMenu .save-preview {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 14px;
      background: rgba(15,23,42,.6);
      margin-top: 20px;
    }
    #frontOfficeMenu .save-preview h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
    }
    #frontOfficeMenu .save-preview .info {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    #frontOfficeMenu .saves-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
      max-height: 350px;
      overflow-y: auto;
    }
    #frontOfficeMenu .saves-list .save-preview {
      margin: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
    }
    #frontOfficeMenu .saves-list .save-preview:hover {
      background: rgba(96, 165, 250, 0.15);
      border-color: #60a5fa;
    }
    #frontOfficeMenu .saves-list .save-preview.latest {
      border-color: #60a5fa;
      background: rgba(96, 165, 250, 0.1);
    }
    #frontOfficeMenu .saves-list .save-preview h4 {
      margin: 0;
      flex: 1;
    }
    #frontOfficeMenu .saves-list .save-preview p {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }
    #frontOfficeMenu .saves-list .continue-btn {
      padding: 8px 14px;
      font-size: 11px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Create League Modal */
    /* Full-Screen Create League Modal */
    #createLeagueModal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 1;
      transition: opacity 0.3s ease-out;
      overflow: hidden;
    }

    #createLeagueModal::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 30%, rgba(96, 165, 250, 0.1), transparent 50%),
                  linear-gradient(135deg, #070a10 0%, #0b0f17 35%, #0a0d15 70%, #050608 100%);
      z-index: 1;
    }

    #createLeagueModal::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.5) 100%);
      z-index: 1;
      pointer-events: none;
    }

    #createLeagueModal.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #createLeagueModal .card {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      max-width: 100%;
      border: none;
      border-radius: 0;
      background: transparent;
      backdrop-filter: none;
      padding: 40px 20px;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #createLeagueModal h3 {
      margin: 0 0 8px 0;
      font-size: clamp(24px, 5vw, 40px);
      font-weight: 900;
      color: var(--text);
      text-align: center;
      letter-spacing: -0.5px;
    }

    #createLeagueModal .form-subtitle {
      text-align: center;
      color: rgba(229, 231, 235, 0.6);
      font-size: 14px;
      margin-bottom: 32px;
    }

    #createLeagueModal .form-container {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    #createLeagueModal .form-group {
      margin-bottom: 20px;
    }

    #createLeagueModal label {
      display: block;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    #createLeagueModal input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.7);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    #createLeagueModal input:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.6);
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 0 16px rgba(96, 165, 250, 0.2);
    }

    #createLeagueModal .form-buttons {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      justify-content: center;
    }

    #createLeagueModal .form-buttons button {
      padding: 12px 32px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 10px;
      min-width: 120px;
    }

    #createLeagueModal .form-buttons #createLeagueBtn {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #1d4ed8 100%);
      color: white;
      border: none;
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
    }

    #createLeagueModal .form-buttons #createLeagueBtn:hover {
      box-shadow: 0 0 30px rgba(96, 165, 250, 0.6);
      transform: translateY(-2px);
    }

    /* Create League: Team Selection Grid */
    #createLeagueModal .team-selection {
      margin-top: 32px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    #createLeagueModal .team-selection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    #createLeagueModal .team-selection-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }

    #createLeagueModal .team-selection-header .counter {
      font-size: 13px;
      color: #60a5fa;
      font-weight: 600;
    }

    #createLeagueModal .quick-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    #createLeagueModal .quick-actions button {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #createLeagueModal .quick-actions button:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.5);
    }

    #createLeagueModal .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      overflow-y: auto;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid var(--line);
      flex-grow: 1;
    }

    #createLeagueModal .team-card {
      padding: 10px;
      border-radius: 8px;
      border: 2px solid rgba(96, 165, 250, 0.2);
      background: rgba(17, 24, 39, 0.6);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100px;
    }

    #createLeagueModal .team-card:hover {
      border-color: rgba(96, 165, 250, 0.5);
      background: rgba(30, 58, 97, 0.4);
      transform: translateY(-2px);
    }

    #createLeagueModal .team-card.selected {
      border-color: #60a5fa;
      background: rgba(96, 165, 250, 0.15);
      box-shadow: 0 0 12px rgba(96, 165, 250, 0.3), inset 0 0 8px rgba(96, 165, 250, 0.1);
    }

    #createLeagueModal .team-card .team-name {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.2;
    }

    #createLeagueModal .team-card .team-logo {
      margin-bottom: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #createLeagueModal .team-card .team-abbrev {
      font-size: 10px;
      font-weight: 700;
      color: #60a5fa;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }

    #createLeagueModal .team-card .team-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 8px;
      color: var(--muted);
    }

    #createLeagueModal .team-card .team-info span {
      line-height: 1;
    }

    /* Managed Team Selection */
    #createLeagueModal .managed-team-section {
      margin-top: 32px;
    }

    #createLeagueModal .managed-team-section h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }

    #createLeagueModal .managed-team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }

    #createLeagueModal .managed-team-card {
      padding: 12px 8px;
      border-radius: 8px;
      border: 2px solid rgba(96, 165, 250, 0.2);
      background: rgba(17, 24, 39, 0.6);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      font-size: 11px;
    }

    #createLeagueModal .managed-team-card:hover {
      border-color: rgba(96, 165, 250, 0.5);
      background: rgba(30, 58, 97, 0.4);
    }

    #createLeagueModal .managed-team-card.selected {
      border-color: #34d399;
      background: rgba(52, 211, 153, 0.15);
      box-shadow: 0 0 12px rgba(52, 211, 153, 0.3);
    }

    #createLeagueModal .managed-team-label {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    #createLeagueModal .managed-team-logo {
      margin-bottom: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #createLeagueModal .managed-team-abbrev {
      font-weight: 700;
      color: #34d399;
      font-size: 10px;
      margin-bottom: 4px;
    }

    #createLeagueModal .managed-team-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 8px;
      color: var(--muted);
    }

    #createLeagueModal .managed-team-info span {
      line-height: 1;
    }

    #createLeagueModal .league-size-selector {
      margin-bottom: 20px;
      padding: 14px 0;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
    }

    #createLeagueModal .league-size-selector label {
      display: block;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
    }

    #createLeagueModal .size-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #createLeagueModal .size-btn {
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 6px;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #createLeagueModal .size-btn:hover {
      border-color: #60a5fa;
      background: rgba(96, 165, 250, 0.1);
    }

    #createLeagueModal .size-btn.selected {
      border-color: #60a5fa;
      background: rgba(96, 165, 250, 0.2);
      color: #60a5fa;
      font-weight: 700;
      box-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
    }

    /* Hide app chrome during startup menu flow */
    .app.in-startup-menu .sidebar,
    .app.in-startup-menu .topbar {
      display: none !important;
    }

    /* Mobile sidebar toggle */
    .mobileToggle { display: none; }
    @media (max-width: 820px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: fixed; left: 0; top: 0; width: 290px; transform: translateX(-110%); transition: .2s; z-index: 5; }
      .sidebar.open { transform: translateX(0); }
      .mobileToggle { display: inline-flex; }
      .main { padding-top: 68px; }
      .topbar { position: fixed; top: 0; left: 0; right: 0; padding: 12px 12px; background: rgba(11,15,23,.88); backdrop-filter: blur(12px); border-bottom: 1px solid var(--line); z-index: 4; }
    }
  </style>
</head>
<body>
  <!-- Title Screen: Enter Front Office -->
  <div id="titleScreen">
    <div class="content">
      <div class="title-stack">
        <h1 class="title-word">Hoops</h1>
        <h1 class="title-word">Dynasty</h1>
        <h1 class="title-word">GM</h1>
      </div>
      <p class="subtitle">Run the front office. Build a dynasty.</p>
      <button id="titleEnter" class="cta-button">Enter Front Office</button>
      <div class="skip-section">
        <label class="skip-label">
          <input type="checkbox" id="titleSkip">
          <span>Skip next time</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Front Office Menu -->
  <div id="frontOfficeMenu" class="hidden">
    <div class="card">
      <h2>Front Office</h2>
      <p class="subtext">Choose a league to manage.</p>
      <div class="main-buttons">
        <button id="foCreateLeague" class="primary">Create League</button>
        <button id="foContinue">Continue</button>
      </div>
      <div class="secondary-buttons">
        <button id="foLoadLeague">Load League</button>
        <button id="foImport">Import</button>
        <button id="foExport">Export</button>
      </div>
      <div id="foSavePreview"></div>
    </div>
  </div>

  <!-- Create League Modal -->
  <div id="createLeagueModal" class="hidden">
    <div class="card">
      <h3>Create League</h3>
      <p class="form-subtitle">Configure your dynasty</p>

      <div class="form-container">
        <div class="form-group">
          <label>League Name</label>
          <input type="text" id="createLeagueName" placeholder="e.g., My Dynasty" value="My League">
        </div>
        
        <div class="form-group">
          <label>Starting Season</label>
          <input type="number" id="createLeagueYear" min="1900" max="2500" value="2026">
        </div>

        <div class="form-group league-size-selector">
          <label for="leagueSize">League Size</label>
          <div class="size-buttons">
            <button type="button" class="size-btn" data-size="8">8</button>
            <button type="button" class="size-btn" data-size="10">10</button>
            <button type="button" class="size-btn" data-size="12">12</button>
            <button type="button" class="size-btn" data-size="16">16</button>
            <button type="button" class="size-btn" data-size="20">20</button>
            <button type="button" class="size-btn" data-size="24">24</button>
            <button type="button" class="size-btn selected" data-size="30">30</button>
          </div>
          <div id="leagueSizeError" style="display: none; color: #f87171; font-size: 12px; margin-top: 8px;"></div>
        </div>

        <div class="form-group team-selection">
          <div class="team-selection-header">
            <h4><span id="teamSelectionTitle">Select 30 Teams</span></h4>
            <span class="counter" id="teamCounter">Selected: 30/30</span>
          </div>
          <div class="quick-actions">
            <button id="selectAllTeams" type="button">Select All</button>
            <button id="selectNoTeams" type="button">Select None</button>
          </div>
          <div class="team-grid" id="teamGrid"></div>
        </div>

        <div class="managed-team-section">
          <h4>Select Team to Manage üë®‚Äçüíº</h4>
          <div class="managed-team-grid" id="managedTeamGrid"></div>
          <div id="managedTeamError" style="display: none; color: #f87171; font-size: 12px; margin-top: 12px;">
            ‚ùå You must select exactly 1 team to manage
          </div>
        </div>

        <div id="teamValidationError" style="display: none; color: #f87171; font-size: 12px; margin-top: 12px;">
          ‚ùå All 30 teams must be selected
        </div>
        
        <div class="form-buttons">
          <button id="createLeagueBtn" class="primary">Create League</button>
          <button id="createLeagueCancel">Back</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Hoops Sim</div>
          <div class="sub" id="subTitle">offline prototype</div>
        </div>
      </div>

      <div class="nav" id="nav">
        <a href="#home" data-route="home" class="active"><span>üéÆ Home</span><span>‚Ä∫</span></a>
        <a href="#dashboard" data-route="dashboard"><span>üè† Dashboard</span><span>‚Ä∫</span></a>
        <a href="#league" data-route="league"><span>üåç League</span><span>‚Ä∫</span></a>
        <a href="#standings" data-route="standings"><span>üìä Standings</span><span>‚Ä∫</span></a>
        <a href="#teams" data-route="teams"><span>üèüÔ∏è Teams</span><span>‚Ä∫</span></a>
        <a href="#rotations" data-route="rotations"><span>üß© Rotations</span><span>‚Ä∫</span></a>
        <a href="#schedule" data-route="schedule"><span>üóìÔ∏è Schedule</span><span>‚Ä∫</span></a>
        <a href="#players" data-route="players"><span>üßë‚Äçü¶± Players</span><span>‚Ä∫</span></a>
      </div>

      <div class="saves-section">
        <h3>üíæ Saves</h3>
        <div class="saves-list" id="savesList"></div>
        <div class="saves-actions">
          <button id="btnNewSave" class="primary">+ New Save</button>
          <button id="btnExport">Export Current</button>
          <button id="btnImport">Import Save</button>
          <input type="file" id="importFile" accept=".json" style="display:none;">
        </div>
      </div>

      <div style="margin-top:14px; padding:12px; border:1px dashed rgba(156,163,175,.25); border-radius:14px; color:var(--muted); font-size:12px; line-height:1.5;">
        This is a prototype. It‚Äôs not ‚ÄúBasketball GM,‚Äù it‚Äôs the baby version that grows into it.
        Start small: data ‚Üí UI ‚Üí sim.
      </div>
    </aside>

    <main class="main">
      <div id="bannerContainer"></div>
      <div class="topbar">
        <div class="left">
          <button class="mobileToggle" id="toggleSidebar">‚ò∞ Menu</button>
          <div class="pill">üìÖ Day <b id="dayLabel">1</b> <span class="muted">/</span> <span id="seasonLabel">Season 2026</span></div>
          <div class="pill">üíæ Save: <b id="saveStatus">Loading...</b></div>
        </div>
        <div class="row-actions">
          <button id="sim1" class="primary">Sim 1 Day</button>
          <button id="sim7">Sim 1 Week</button>
          <button id="newLeague" class="danger">Reset Save</button>
        </div>
      </div>

      <div id="view"></div>
    </main>
  </div>

  <script>
    /**********************
     * 0) Dexie DB Setup
     **********************/
    let db = null;
    let dbError = false;
    let dbErrorMsg = "";

    class HoopsDB extends Dexie {
      constructor() {
        super("hoops_sim_db");
        this.version(1).stores({
          saves: "id, name, updatedAt",
          leagues: "id"
        });
      }
    }

    async function initDB() {
      try {
        db = new HoopsDB();
        await db.open();
        return true;
      } catch (err) {
        console.warn("IndexedDB unavailable (private mode?), using in-memory storage:", err);
        dbError = true;
        dbErrorMsg = "üìµ Storage failed: using in-memory. Reload to keep data.";
        // Create fake in-memory db
        db = {
          saves: { toArray: async () => inMemorySaves, add: async (s) => { inMemorySaves.push(s); }, update: async () => {}, delete: async () => {} },
          leagues: { where: () => ({ first: async () => null }), add: async () => {}, update: async () => {} }
        };
        return false;
      }
    }

    /**********************
     * Schema Versioning System
     * 
     * Every league object must include:
     *   league.schemaVersion (number)
     * 
     * When updating league structure:
     *   1. Increment CURRENT_SCHEMA_VERSION
     *   2. Add migration logic in migrateLeague() function
     *   3. All existing leagues auto-upgrade on load
     *   4. Migrations are non-destructive (preserve unknown properties)
     *
     * Schema Version History:
     *   v0: Original - implicit version if schemaVersion missing
     *   v1: Core structure (meta, teams, players, log)
     **********************/
    const CURRENT_SCHEMA_VERSION = 10;
    const inMemorySaves = [];
    const inMemoryLeagues = {};

    /**********************
     * 1) Data + Utilities
     **********************/
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }
    function uuid() {
      return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + randInt(1000, 9999);
    }

    // Bio generation data
    const US_CITIES = [
      "New York, NY", "Los Angeles, CA", "Chicago, IL", "Houston, TX", "Phoenix, AZ",
      "Philadelphia, PA", "San Antonio, TX", "San Diego, CA", "Dallas, TX", "San Jose, CA",
      "Austin, TX", "Jacksonville, FL", "Memphis, TN", "Boston, MA", "Nashville, TN",
      "Baltimore, MD", "Louisville, KY", "Portland, OR", "Las Vegas, NV", "Detroit, MI",
      "Oklahoma City, OK", "Albuquerque, NM", "Tucson, AZ", "Fresno, CA", "Mesa, AZ",
      "Sacramento, CA", "Atlanta, GA", "Kansas City, MO", "Miami, FL", "Denver, CO",
      "Minneapolis, MN", "Cleveland, OH", "New Orleans, LA", "Arlington, TX", "Bakersfield, CA",
      "Tampa, FL", "Aurora, CO", "Anaheim, CA", "Santa Ana, CA", "Saint Louis, MO",
      "Riverside, CA", "Corpus Christi, TX", "Pittsburgh, PA", "Lexington, KY", "Cincinnati, OH",
      "Washington, DC", "Long Beach, CA", "Irvine, CA", "Stockton, CA", "Chula Vista, CA",
      "Toledo, OH", "Plano, TX", "Norfolk, VA", "Garland, TX", "Laredo, TX",
      "Chandler, AZ", "Chesapeake, VA", "Irving, TX", "Scottsdale, AZ", "Raleigh, NC"
    ];

    const INTERNATIONAL_CITIES = {
      "Canada": ["Toronto, Ontario", "Vancouver, BC", "Montreal, Quebec", "Calgary, Alberta", "Ottawa, Ontario"],
      "France": ["Paris", "Marseille", "Lyon", "Toulouse", "Nice"],
      "Spain": ["Madrid", "Barcelona", "Valencia", "Seville", "Malaga"],
      "Serbia": ["Belgrade", "Nis", "Novi Sad", "Zemun", "Vranje"],
      "Slovenia": ["Ljubljana", "Maribor", "Celje", "Kranj", "Novo Mesto"],
      "Lithuania": ["Vilnius", "Kaunas", "Klaipeda", "Siauliai", "Panevezys"],
      "Australia": ["Sydney, NSW", "Melbourne, VIC", "Brisbane, QLD", "Perth, WA", "Adelaide, SA"],
      "Nigeria": ["Lagos", "Abuja", "Kano", "Ibadan", "Benin City"],
      "Argentina": ["Buenos Aires", "Cordoba", "Rosario", "Mendoza", "La Plata"],
      "Brazil": ["Sao Paulo", "Rio de Janeiro", "Salvador", "Brasilia", "Fortaleza"]
    };

    const NCAA_COLLEGES = [
      "Duke", "North Carolina", "Kentucky", "Kansas", "Louisville", "Michigan State",
      "UCLA", "Georgetown", "Arizona", "Indiana", "Syracuse", "Florida",
      "Texas", "Ohio State", "Villanova", "Maryland", "Virginia", "Gonzaga",
      "Oklahoma", "Connecticut", "Providence", "Miami", "Memphis", "Marquette",
      "Iowa State", "Creighton", "San Diego State", "Purdue", "Wisconsin", "Baylor",
      "Texas Tech", "LSU", "Dayton", "VCU", "Temple", "Xavier",
      "DePaul", "St. John's", "Western Kentucky", "Bradley", "Wichita State", "Northern Iowa"
    ];

    const INTL_ACADEMIES = [
      "Mega Basket", "INSEP", "Sydney Institute", "Real Madrid Academy", "FC Barcelona Academy",
      "Brose Bamberg", "Partizan Belgrade", "Olimpija Ljubljana", "BC Zalgiris",
      "Virtus Bologna", "AEK Athens", "Fenerbahce", "CSKA Moscow", "Maccabi Tel Aviv"
    ];

    const ALT_PATHS = ["G League Ignite", "Overseas Academy", "Prep-to-Pro", "Independent"];

    // Country-specific name pools (first and last names for each country)
    const NAME_POOLS = {
      USA: {
        first: ["James", "Michael", "Christopher", "David", "Robert", "Kevin", "Jason", "Ryan", "Brandon", "Tony", "Derek", "Kyle", "Steve", "Mark", "Scott", "Brad", "Chad", "Eric", "Justin", "Trent", "Blake", "Zach", "Dean", "Lane", "Grant"],
        last: ["Johnson", "Smith", "Williams", "Brown", "Jones", "Garcia", "Martinez", "Anderson", "Taylor", "Thomas", "Moore", "Jackson", "Martin", "White", "Harris", "Sanchez", "Clark", "Lewis", "Robinson", "Lee", "Walker", "Hall", "Young", "King", "Wright"]
      },
      Canada: {
        first: ["Justin", "Alexandre", "Marc", "Laurent", "Philippe", "Andre", "Daniel", "Nicolas", "Claude", "Simon", "Mathieu", "Patrick", "Robert", "Paul", "Etienne", "Yannick", "Steve", "Erick", "Matt", "Tyler", "Chris", "Adam"],
        last: ["Marchand", "Bergeron", "Brodeur", "Plante", "MacDonald", "Campbell", "McKenzie", "Morrison", "Sullivan", "Murray", "Malone", "MacTavish", "Connor", "Harvey", "Messier", "Lemieux", "Lafleur", "Moreau", "Gagne", "Howe"]
      },
      France: {
        first: ["Thierry", "Olivier", "Laurent", "Philippe", "Jean", "Marc", "Christophe", "Stephane", "Nicolas", "Michel", "Francois", "Pierre", "Benoit", "Antoine", "Vincent", "Yannick", "Mathieu", "Didier", "Cedric", "Fabrice"],
        last: ["Dupont", "Moreau", "Leblanc", "Martin", "Bernard", "Blanc", "Renard", "Mercier", "Roux", "Lefevre", "Leclerc", "Fabre", "Arnaud", "Girard", "Bonnet", "Fontaine", "Marchand", "Dubois", "Rousseau", "Laurent"]
      },
      Spain: {
        first: ["Carlos", "Diego", "Juan", "Miguel", "Fernando", "Roberto", "Javier", "Antonio", "Roger", "Pablo", "Sergio", "Raul", "Andres", "Luis", "Angel", "Manuel", "Enrique", "Rafael", "Eduardo", "Salvador"],
        last: ["Garcia", "Hernandez", "Martinez", "Rodriguez", "Sanchez", "Lopez", "Gonzalez", "Fernandez", "Torres", "Navarro", "Ramirez", "Morales", "Espinoza", "Vargas", "Valdez", "Delgado", "Castillo", "Ruiz", "Ortiz", "Dominguez"]
      },
      Serbia: {
        first: ["Nikola", "Vladimir", "Marko", "Stefan", "Goran", "Dejan", "Aleksandar", "Vlade", "Zoran", "Nenad", "Miodrag", "Srdjan", "Vladan", "Dragan", "Branko", "Milan", "Uros", "Milos", "Ivan", "Slobodan"],
        last: ["Jokic", "Milic", "Ivanovic", "Markovic", "Pavlovic", "Mitrovic", "Djordjevic", "Nikolic", "Radinovic", "Popovic", "Tomanovic", "Savic", "Bosic", "Stankovic", "Simovic", "Nemanja", "Petrovic", "Vucevic", "Bogdanovic", "Teodosic"]
      },
      Slovenia: {
        first: ["Goran", "Marko", "Jure", "Ales", "Uros", "Aleksandar", "Milan", "Bostjan", "Franc", "Sasa", "Damir", "Ivo", "Alen", "Samo", "Matjaz", "Stevo", "Dusan", "Tomislav"],
        last: ["Dragic", "Radosevic", "Bislimovic", "Munic", "Peric", "Tomic", "Ilijas", "Novak", "Milic", "Banic", "Grabnar", "Golic", "Podkrajsek", "Dimec", "Jurca", "Jelovcan"]
      },
      Lithuania: {
        first: ["Donatas", "Sarunas", "Arvydas", "Mindaugas", "Gintaras", "Mantas", "Virgilijus", "Darius", "Valdemaras", "Andrius", "Vidas", "Rimantas", "Povilas", "Audrius", "Remigijus", "Raimondas"],
        last: ["Sabonis", "Marciulionis", "Petraitis", "Jankauskas", "Ilgunas", "Zizinskas", "Vidikis", "Kuzminskas", "Korzovas", "Masalskis", "Pocas", "Milasius", "Valinskas", "Adomaitis", "Bartusevicus", "Siskus"]
      },
      Australia: {
        first: ["Andrew", "Jason", "Mark", "David", "Chris", "Shane", "Brett", "Steve", "Robert", "Paul", "Peter", "Michael", "Anthony", "Danny", "Ryan", "Aaron", "Kevin", "Craig", "Greg", "Wayne"],
        last: ["Samson", "Heal", "Longley", "Maher", "Bradtke", "Brislane", "Jackson", "Murphy", "Williams", "Campbell", "Davidson", "Barrett", "Sullivan", "Morrison", "Thomson", "MacLeod", "Patterson", "McDonald"]
      },
      Nigeria: {
        first: ["Tosin", "Chukwu", "Emeka", "Oluwaseun", "Jamal", "Ibrahim", "Tamir", "Nnamdi", "Kabir", "Femi", "Okafor", "Kofi", "Ebube", "Damien", "Maxwell", "Ade", "Kojo", "Kwame", "Sekou"],
        last: ["Adebayo", "Okafor", "Ejiofor", "Nwankwo", "Chukwu", "Ezeoke", "Agbakoba", "Okoro", "Onyekwere", "Azeez", "Balogun", "Obi", "Okonkwo", "Udeh", "Eze", "Nwosu", "Mba", "Anyanwu"]
      },
      Argentina: {
        first: ["Gabriel", "Juan", "Carlos", "Martin", "Diego", "Lucas", "Ruben", "Roberto", "Jorge", "Manuel", "Sergio", "Alejandro", "Gustavo", "Hector", "Ricardo", "Pablo", "Oscar", "Andres"],
        last: ["Campazzo", "Vassel", "Nocioni", "Oberto", "Scola", "Causeur", "Lopez", "Hernandez", "Montoya", "Bernacha", "Patino", "Bassi", "Pereyra", "Trevino", "Araujo", "Fontana", "Dominguez"]
      },
      Brazil: {
        first: ["Anderson", "Jefferson", "Ricardo", "Marcelo", "Leandro", "Mauro", "Gustavo", "Paulo", "Fabricio", "Raul", "Marcelinho", "Diego", "Roberto", "Nando", "Jamal", "Douglas", "Djalma"],
        last: ["Varejao", "Barbosa", "Splitter", "Machado", "Felicio", "Turu", "Dias", "Silva", "Santos", "Oliveira", "Martins", "Neves", "Lourenco", "Brandao", "Correa", "Sousa", "Alves"]
      }
    };

    function randomFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function generateNameForCountry(country) {
      const pool = NAME_POOLS[country] || NAME_POOLS["USA"];
      const firstName = randomFrom(pool.first);
      const lastName = randomFrom(pool.last);
      return { firstName, lastName };
    }

    /**********************
     * Regional Tendencies
     **********************/
    
    /**
     * Map country to region for position/physical weighting
     */
    function regionForCountry(country) {
      const regionMap = {
        // North America
        "USA": "NA",
        "Canada": "NA",
        // Europe
        "France": "EUROPE",
        "Spain": "EUROPE",
        "Serbia": "EUROPE",
        "Slovenia": "EUROPE",
        "Lithuania": "EUROPE",
        // Africa
        "Nigeria": "AFRICA",
        // Latin America
        "Argentina": "LATAM",
        "Brazil": "LATAM",
        // Oceania
        "Australia": "OCEANIA"
      };
      return regionMap[country] || "OTHER";
    }

    /**
     * Position distribution weights by region
     * Higher numbers = more likely in that region
     */
    const POSITION_WEIGHTS = {
      NA: { PG: 0.26, SG: 0.24, SF: 0.20, PF: 0.16, C: 0.14 },
      EUROPE: { PG: 0.20, SG: 0.22, SF: 0.22, PF: 0.18, C: 0.18 },
      AFRICA: { PG: 0.16, SG: 0.20, SF: 0.22, PF: 0.20, C: 0.22 },
      LATAM: { PG: 0.22, SG: 0.22, SF: 0.20, PF: 0.18, C: 0.18 },
      OCEANIA: { PG: 0.20, SG: 0.22, SF: 0.20, PF: 0.18, C: 0.20 },
      OTHER: { PG: 0.22, SG: 0.22, SF: 0.20, PF: 0.18, C: 0.18 }
    };

    /**
     * Height offset by region (in inches) - applied to all positions
     */
    const REGION_HEIGHT_OFFSET = {
      NA: 0,
      EUROPE: 1,
      AFRICA: 2,
      LATAM: 0,
      OCEANIA: 1,
      OTHER: 0
    };

    /**
     * Pick a key from a weights object using weighted random selection
     * weights: { key1: 0.5, key2: 0.3, key3: 0.2 }
     */
    function weightedPick(weights) {
      const keys = Object.keys(weights);
      const values = keys.map(k => weights[k]);
      const total = values.reduce((a, b) => a + b, 0);
      
      let rand = Math.random() * total;
      for (let i = 0; i < keys.length; i++) {
        rand -= values[i];
        if (rand <= 0) {
          return keys[i];
        }
      }
      return keys[keys.length - 1]; // fallback
    }

    /**
     * Pick position based on region tendencies
     */
    function pickPositionByRegion(region) {
      const weights = POSITION_WEIGHTS[region] || POSITION_WEIGHTS["OTHER"];
      return weightedPick(weights);
    }

    /**
     * Generate height/weight/wingspan with region tendencies
     */
    function makeHeightWeightWingspanWithRegion(pos, region) {
      const offset = REGION_HEIGHT_OFFSET[region] || 0;
      let heightIn, weightLb;

      if (pos === "PG") {
        heightIn = randInt(69, 76) + offset + randInt(-1, 1);
        heightIn = clamp(heightIn, 68, 79);
        weightLb = randInt(160, 210);
      } else if (pos === "SG") {
        heightIn = randInt(73, 79) + offset + randInt(-1, 1);
        heightIn = clamp(heightIn, 72, 82);
        weightLb = randInt(170, 225);
        if (region === "AFRICA") weightLb += randInt(-5, 10);
      } else if (pos === "SF") {
        heightIn = randInt(75, 82) + offset + randInt(-1, 1);
        heightIn = clamp(heightIn, 74, 85);
        weightLb = randInt(190, 245);
        if (region === "AFRICA") weightLb += randInt(-5, 10);
        else if (region === "EUROPE") weightLb += randInt(0, 10);
      } else if (pos === "PF") {
        heightIn = randInt(78, 84) + offset + randInt(-1, 1);
        heightIn = clamp(heightIn, 77, 87);
        weightLb = randInt(210, 265);
        if (region === "AFRICA") weightLb += randInt(-5, 10);
        else if (region === "EUROPE") weightLb += randInt(0, 10);
      } else { // C
        heightIn = randInt(81, 88) + offset + randInt(-1, 1);
        heightIn = clamp(heightIn, 80, 91);
        weightLb = randInt(230, 290);
        if (region === "AFRICA") weightLb += randInt(-5, 10);
        else if (region === "EUROPE") weightLb += randInt(0, 10);
      }

      // Wingspan: slightly more extension in Africa
      const wingspanBase = region === "AFRICA" ? randInt(3, 11) : randInt(2, 10);
      const wingspanIn = heightIn + wingspanBase;

      return { heightIn, weightLb, wingspanIn };
    }

    function makeHeightWeightWingspan(pos) {
      // Legacy function for backward compatibility - uses NA defaults
      return makeHeightWeightWingspanWithRegion(pos, "NA");
    }

    /**********************
     * Player Ratings & Archetypes
     **********************/

    /**
     * Generate realistic ratings for a player based on position and overall rating
     * All ratings are 0-100, position-weighted for realism
     */
    function generateRatings(pos, ovr, pot, region = "NA") {
      // Base variance: higher overall players have less variance
      const variance = Math.max(8, 20 - (ovr / 10));
      
      // Helper to roll rating around a target
      function rollRating(target, variance = 8) {
        const rolled = target + randInt(-variance, variance);
        return clamp(rolled, 20, 100);
      }

      // Position-specific rating generation
      let ratings = {};

      if (pos === "PG") {
        // Playmakers: drb, pas, spd high; inD, blk low
        ratings.ath = rollRating(ovr - 2, variance);
        ratings.spd = rollRating(ovr + 3, variance);
        ratings.str = rollRating(ovr - 5, variance);
        ratings.stam = rollRating(ovr - 1, variance);
        ratings.iq = rollRating(ovr + 2, variance);
        ratings.drb = rollRating(ovr + 5, variance);
        ratings.pas = rollRating(ovr + 6, variance);
        ratings.fin = rollRating(ovr - 2, variance);
        ratings.mid = rollRating(ovr - 3, variance);
        ratings.tp = rollRating(ovr - 2, variance);
        ratings.ft = rollRating(ovr - 1, variance);
        ratings.perD = rollRating(ovr + 1, variance);
        ratings.inD = rollRating(ovr - 10, variance);
        ratings.reb = rollRating(ovr - 12, variance);
        ratings.blk = rollRating(ovr - 15, variance);
        ratings.stl = rollRating(ovr + 2, variance);
      } else if (pos === "SG") {
        // Scorers: tp, spd, perD high; reb, inD low
        ratings.ath = rollRating(ovr, variance);
        ratings.spd = rollRating(ovr + 2, variance);
        ratings.str = rollRating(ovr - 3, variance);
        ratings.stam = rollRating(ovr, variance);
        ratings.iq = rollRating(ovr, variance);
        ratings.drb = rollRating(ovr + 2, variance);
        ratings.pas = rollRating(ovr - 3, variance);
        ratings.fin = rollRating(ovr + 3, variance);
        ratings.mid = rollRating(ovr + 2, variance);
        ratings.tp = rollRating(ovr + 4, variance);
        ratings.ft = rollRating(ovr + 1, variance);
        ratings.perD = rollRating(ovr + 3, variance);
        ratings.inD = rollRating(ovr - 8, variance);
        ratings.reb = rollRating(ovr - 10, variance);
        ratings.blk = rollRating(ovr - 12, variance);
        ratings.stl = rollRating(ovr + 1, variance);
      } else if (pos === "SF") {
        // Wings: balanced but good at volume scoring and defense
        ratings.ath = rollRating(ovr + 1, variance);
        ratings.spd = rollRating(ovr + 1, variance);
        ratings.str = rollRating(ovr - 1, variance);
        ratings.stam = rollRating(ovr, variance);
        ratings.iq = rollRating(ovr + 1, variance);
        ratings.drb = rollRating(ovr, variance);
        ratings.pas = rollRating(ovr - 1, variance);
        ratings.fin = rollRating(ovr + 2, variance);
        ratings.mid = rollRating(ovr + 1, variance);
        ratings.tp = rollRating(ovr + 1, variance);
        ratings.ft = rollRating(ovr, variance);
        ratings.perD = rollRating(ovr + 2, variance);
        ratings.inD = rollRating(ovr - 2, variance);
        ratings.reb = rollRating(ovr - 3, variance);
        ratings.blk = rollRating(ovr - 5, variance);
        ratings.stl = rollRating(ovr + 1, variance);
      } else if (pos === "PF") {
        // Forwards: reb, str, inD high; drb, tp lower
        ratings.ath = rollRating(ovr - 1, variance);
        ratings.spd = rollRating(ovr - 2, variance);
        ratings.str = rollRating(ovr + 4, variance);
        ratings.stam = rollRating(ovr, variance);
        ratings.iq = rollRating(ovr - 1, variance);
        ratings.drb = rollRating(ovr - 5, variance);
        ratings.pas = rollRating(ovr - 4, variance);
        ratings.fin = rollRating(ovr + 1, variance);
        ratings.mid = rollRating(ovr + 2, variance);
        ratings.tp = rollRating(ovr - 3, variance);
        ratings.ft = rollRating(ovr, variance);
        ratings.perD = rollRating(ovr + 1, variance);
        ratings.inD = rollRating(ovr + 4, variance);
        ratings.reb = rollRating(ovr + 6, variance);
        ratings.blk = rollRating(ovr + 2, variance);
        ratings.stl = rollRating(ovr - 1, variance);
      } else { // C
        // Centers: inD, blk, reb, str very high; tp lower
        ratings.ath = rollRating(ovr - 2, variance);
        ratings.spd = rollRating(ovr - 4, variance);
        ratings.str = rollRating(ovr + 5, variance);
        ratings.stam = rollRating(ovr - 1, variance);
        ratings.iq = rollRating(ovr - 1, variance);
        ratings.drb = rollRating(ovr - 8, variance);
        ratings.pas = rollRating(ovr - 5, variance);
        ratings.fin = rollRating(ovr + 2, variance);
        ratings.mid = rollRating(ovr + 1, variance);
        ratings.tp = rollRating(ovr - 6, variance);
        ratings.ft = rollRating(ovr, variance);
        ratings.perD = rollRating(ovr, variance);
        ratings.inD = rollRating(ovr + 6, variance);
        ratings.reb = rollRating(ovr + 7, variance);
        ratings.blk = rollRating(ovr + 6, variance);
        ratings.stl = rollRating(ovr - 3, variance);
      }

      // Ensure all ratings are in valid range
      for (let key in ratings) {
        ratings[key] = clamp(ratings[key], 20, 100);
      }

      return ratings;
    }

    /**
     * Compute overall rating from individual ratings
     * Position-weighted to ensure OVR aligns with player quality
     */
    function computeOVR(p) {
      if (!p.ratings) return p.ovr || 75; // fallback

      const r = p.ratings;
      let weighted = 0;

      if (p.pos === "PG") {
        weighted = (r.drb * 0.25 + r.pas * 0.25 + r.spd * 0.15 + r.perD * 0.15 + r.iq * 0.10 + r.tp * 0.10);
      } else if (p.pos === "SG") {
        weighted = (r.tp * 0.25 + r.fin * 0.20 + r.perD * 0.20 + r.spd * 0.15 + r.mid * 0.10 + r.drb * 0.10);
      } else if (p.pos === "SF") {
        weighted = (r.fin * 0.20 + r.tp * 0.20 + r.perD * 0.20 + r.ath * 0.15 + r.reb * 0.10 + r.iq * 0.10 + r.inD * 0.05);
      } else if (p.pos === "PF") {
        weighted = (r.reb * 0.25 + r.inD * 0.25 + r.str * 0.15 + r.fin * 0.15 + r.ath * 0.10 + r.mid * 0.10);
      } else { // C
        weighted = (r.inD * 0.25 + r.blk * 0.25 + r.reb * 0.25 + r.str * 0.15 + r.fin * 0.10);
      }

      return clamp(Math.round(weighted), 40, 99);
    }

    /**
     * Derive archetype from ratings and position
     */
    function computeArchetype(p) {
      if (!p.ratings) return { primary: "Prospect", tags: [] };

      const r = p.ratings;
      const pos = p.pos;
      const tags = [];
      let primary = "Balanced";

      if (pos === "PG" || pos === "SG") {
        // Guards
        if (r.pas >= 80 && r.drb >= 75) {
          primary = "Playmaker";
          if (r.perD >= 75) tags.push("Defender");
        } else if (r.tp >= 85 && r.mid >= 75) {
          primary = "Sharpshooter";
          if (r.perD >= 78) tags.push("Lockdown");
        } else if (r.tp >= 78 && r.perD >= 78) {
          primary = "3&D Guard";
        } else if (r.perD >= 85 && r.stl >= 80) {
          primary = "Defensive Pest";
          if (r.stam >= 75) tags.push("Energy");
        } else if (r.drb >= 78 && r.fin >= 78) {
          primary = "Shot Creator";
        } else {
          primary = "Balanced Guard";
          if (r.tp >= 75) tags.push("Scorer");
          if (r.perD >= 75) tags.push("Defender");
        }
      } else if (pos === "SF" || pos === "PF") {
        // Wings
        if (r.tp >= 75 && r.perD >= 78 && r.fin >= 72) {
          primary = "Two-Way Wing";
        } else if (r.fin >= 82 && r.ath >= 78 && r.spd >= 75) {
          primary = "Slasher";
        } else if (r.pas >= 78 && r.iq >= 75) {
          primary = "Point Forward";
        } else if (r.reb >= 80 && r.str >= 78) {
          primary = "Rebounder";
        } else if (r.tp >= 78 && r.mid >= 75 && r.reb >= 70) {
          primary = "Stretch Wing";
        } else {
          primary = "Balanced Wing";
          if (r.perD >= 75) tags.push("Defender");
          if (r.fin >= 75) tags.push("Scorer");
        }
      } else { // C
        if (r.blk >= 85 && r.inD >= 80) {
          primary = "Rim Protector";
        } else if (r.reb >= 85 && r.str >= 78) {
          primary = "Glass Cleaner";
        } else if (r.tp >= 78 && r.reb >= 70) {
          primary = "Stretch Big";
        } else if (r.fin >= 80 && r.str >= 80) {
          primary = "Post Scorer";
        } else if (r.inD >= 75 && r.reb >= 75) {
          primary = "Traditional Big";
          if (r.blk >= 75) tags.push("Protector");
        } else {
          primary = "Traditional Big";
          if (r.blk >= 70) tags.push("Defensive");
          if (r.reb >= 70) tags.push("Rebounder");
        }
      }

      return { primary, tags: tags.slice(0, 2) }; // max 2 tags
    }

    /**
     * Generate player personality traits
     * Returns object with 9 personality dimensions (all 0-100)
     */
    function generatePersonality(pos = "SF", region = "NA") {
      // Base baseline = 50, variance range = +/- 25
      function rollTrait(baseOffset = 0) {
        const variance = 25;
        const rolled = 50 + baseOffset + randInt(-variance, variance);
        return clamp(rolled, 0, 100);
      }

      let personality = {
        workEthic: rollTrait(0),
        loyalty: rollTrait(0),
        ambition: rollTrait(0),
        leadership: rollTrait(0),
        ego: rollTrait(0),
        temperament: rollTrait(0),
        clutch: rollTrait(0),
        durability: rollTrait(0),
        coachability: rollTrait(0)
      };

      // Position-specific bias
      if (pos === "PG" || pos === "SG") {
        // Guards: more ego, more leadership variance
        personality.ego = clamp(personality.ego + randInt(0, 15), 0, 100);
        personality.leadership = clamp(personality.leadership + randInt(0, 10), 0, 100);
      }
      if (pos === "PG") {
        personality.leadership = clamp(personality.leadership + randInt(5, 10), 0, 100);
      }
      if (pos === "SG") {
        personality.ego = clamp(personality.ego + randInt(5, 10), 0, 100);
      }
      if (pos === "PF") {
        // Power forwards: more temperament variance
        personality.temperament = clamp(personality.temperament + randInt(-10, 10), 0, 100);
      }
      if (pos === "C") {
        // Centers: more leadership
        personality.leadership = clamp(personality.leadership + randInt(5, 15), 0, 100);
      }

      // Region-specific bias
      if (region === "USA") {
        personality.ego = clamp(personality.ego + randInt(0, 8), 0, 100);
      } else if (region === "EUROPE") {
        personality.coachability = clamp(personality.coachability + randInt(5, 12), 0, 100);
      } else if (region === "AFRICA") {
        personality.durability = clamp(personality.durability + randInt(5, 15), 0, 100);
      }

      return personality;
    }

    /**
     * Compute personality tags from trait values
     * Returns array of 0-3 personality badges
     */
    function computePersonalityTags(p) {
      if (!p.personality) return [];

      const pers = p.personality;
      const tags = [];

      if (pers.workEthic > 80) tags.push("Gym Rat");
      if (pers.loyalty > 80) tags.push("Franchise Loyal");
      if (pers.ambition > 85) tags.push("Ring Chaser");
      if (pers.leadership > 80) tags.push("Locker Room Anchor");
      if (pers.ego > 85) tags.push("Ball Dominant");
      if (pers.temperament < 30) tags.push("Volatile");
      if (pers.clutch > 85) tags.push("Clutch Performer");
      if (pers.durability > 85) tags.push("Ironman");
      if (pers.coachability > 80) tags.push("System Player");

      return tags.slice(0, 3);
    }

    /**
     * Compute team chemistry from roster
     * Returns 0-100 chemistry score
     */
    function computeTeamChemistry(players) {
      if (!players || players.length === 0) return 50;

      let totalLeadership = 0;
      let totalEgo = 0;
      let volatileCount = 0;

      players.forEach(p => {
        if (p.personality) {
          totalLeadership += p.personality.leadership;
          totalEgo += p.personality.ego;
          if (p.personality.temperament < 40) volatileCount++;
        }
      });

      const avgLeadership = totalLeadership / players.length;
      const avgEgo = totalEgo / players.length;
      const volatilePenalty = volatileCount * 3;

      const chemistry = 50 + (avgLeadership * 0.4) - (avgEgo * 0.2) - volatilePenalty;
      return clamp(chemistry, 10, 100);
    }

    /**
     * Compute player morale from personality and team/individual context
     */
    function computeMorale(player, team, players, isWinning) {
      let morale = 50;

      if (player.personality) {
        const pers = player.personality;
        // Loyalty bonus/penalty
        morale += (pers.loyalty - 50) * 0.1;
        // Ambition: boost if winning, penalty if losing
        morale += (isWinning ? 1 : -1) * (pers.ambition - 50) * 0.05;
        // Ego penalty if not matching role expectation (approximated by low stats/playtime)
        if (player.stats && player.stats.gp < 10) {
          morale -= (pers.ego - 50) * 0.1;
        }
      }

      // Team leadership bonus
      const teamChemistry = computeTeamChemistry(players);
      morale += (teamChemistry - 50) * 0.1;

      return clamp(morale, 0, 100);
    }

    /**
     * Get development multiplier from personality
     * Affects offseason rating growth
     */
    function getDevelopmentMultiplier(player) {
      if (!player.personality) return 1.0;

      const pers = player.personality;
      let multiplier = 1.0;

      multiplier += (pers.workEthic - 50) * 0.005;
      multiplier += (pers.coachability - 50) * 0.003;

      return clamp(multiplier, 0.85, 1.15); // ¬±15% range
    }

    /**
     * Get contract salary multiplier from personality
     * Affects salary demands during contract negotiations
     */
    function getSalaryMultiplier(player, teamWinning) {
      if (!player.personality) return 1.0;

      const pers = player.personality;
      let multiplier = 1.0;

      // Ambition boost if team losing
      if (!teamWinning && pers.ambition > 70) {
        multiplier += 0.1;
      }

      // Ego-based demands
      multiplier += (pers.ego - 50) * 0.002;

      // Loyalty discount
      multiplier -= (pers.loyalty - 50) * 0.002;

      return clamp(multiplier, 0.8, 1.3); // ¬±20/+30% range
    }

    /**
     * Get trade value modifier from personality
     * Affects perceived value in trades
     */
    function getTradeValueModifier(player, isUnhappy = false) {
      if (!player.personality) return 1.0;

      const pers = player.personality;
      let modifier = 1.0;

      // Work ethic increases value
      modifier += (pers.workEthic - 50) * 0.001;

      // Durability increases value
      modifier += (pers.durability - 50) * 0.001;

      // High ego reduces value if unhappy
      if (isUnhappy) {
        modifier -= (pers.ego - 50) * 0.0005;
      }

      return clamp(modifier, 0.85, 1.15);
    }

    /**
     * Get injury frequency modifier from durability
     * Affects injury chance in simulations
     */
    function getInjuryModifier(player) {
      if (!player.personality) return 1.0;

      const durability = player.personality.durability;
      return clamp(1.0 - ((durability - 50) * 0.005), 0.75, 1.25); // durability reduces injury risk
    }

    /**
     * Get clutch performance boost from personality
     * Small temporary boost in late-game situations
     */
    function getClutchBoost(player) {
      if (!player.personality) return 0;

      const clutch = player.personality.clutch;
      return (clutch - 50) * 0.02; // Max +/- 1 OVR equivalent in clutch moments
    }

    /**********************
     * ROTATIONS SYSTEM
     **********************/

    /**
     * Initialize default rotations for a team
     * Called on team creation or migration
     */
    function initializeRotations(teamId, players) {
      const roster = players.filter(p => p.teamId === teamId).sort((a,b) => b.ovr - a.ovr);
      const positions = ["PG", "SG", "SF", "PF", "C"];
      
      const rotations = {
        starters: {},
        benchOrder: { PG: [], SG: [], SF: [], PF: [], C: [] },
        minutes: {},
        autoFill: true,
        coachAdjustments: false
      };

      // Pick best player by position for starters
      positions.forEach(pos => {
        const posPlayers = roster.filter(p => p.pos === pos);
        if (posPlayers.length > 0) {
          rotations.starters[pos] = posPlayers[0].id;
          rotations.minutes[posPlayers[0].id] = 32; // Starter default: 32 min
        }
      });

      // Populate bench orders by position
      positions.forEach(pos => {
        const posPlayers = roster.filter(p => p.pos === pos && p.id !== rotations.starters[pos]);
        posPlayers.forEach((p, idx) => {
          rotations.benchOrder[pos].push(p.id);
          // Bench: 20+ for top 2, 10-15 for others
          if (idx === 0) rotations.minutes[p.id] = 20;
          else if (idx === 1) rotations.minutes[p.id] = 15;
          else rotations.minutes[p.id] = 8;
        });
      });

      // Add all players with non-zero minutes (fill gaps)
      roster.forEach(p => {
        if (!rotations.minutes[p.id]) {
          rotations.minutes[p.id] = 5; // Default backup: 5 min
        }
      });

      return rotations;
    }

    /**
     * Get total minutes allocated in a rotation
     */
    function getTotalMinutes(rotations) {
      return Object.values(rotations.minutes || {}).reduce((a,b) => a+b, 0);
    }

    /**
     * Get minutes share for each player (0..1 range)
     */
    function getMinutesShare(teamId) {
      const rotations = state.league.rotations?.[teamId];
      if (!rotations || !rotations.minutes) {
        // Fallback to OVR-based distribution
        const roster = state.league.players.filter(p => p.teamId === teamId).sort((a,b) => b.ovr - a.ovr);
        const totalOvr = roster.reduce((s, p) => s + p.ovr, 0);
        const shareMap = {};
        roster.forEach(p => {
          shareMap[p.id] = (p.ovr / totalOvr) * 0.6 + 0.05; // Top heavy
        });
        return shareMap;
      }

      const totalMin = getTotalMinutes(rotations);
      const shareMap = {};
      Object.entries(rotations.minutes).forEach(([playerId, min]) => {
        shareMap[playerId] = min / 240; // 240 total minutes in game
      });
      return shareMap;
    }

    /**
     * Validate rotation assignment (no duplicate starters)
     */
    function validateRotation(rotations) {
      const starterIds = Object.values(rotations.starters || {});
      const seen = new Set();
      for (let id of starterIds) {
        if (seen.has(id)) return false;
        seen.add(id);
      }
      return true;
    }

    /**
     * Generate diagnostics for rotation (warnings/issues)
     */
    function getRotationDiagnostics(teamId) {
      const rotations = state.league.rotations?.[teamId];
      if (!rotations) return { errors: [], warnings: [] };

      const errors = [], warnings = [];
      const roster = state.league.players.filter(p => p.teamId === teamId);
      const totalMin = getTotalMinutes(rotations);

      if (totalMin < 240) warnings.push(`You have ${240 - totalMin} unassigned minutes.`);
      else if (totalMin > 240) warnings.push(`You are ${totalMin - 240} minutes over.`);

      // Check for unassigned players
      const assigned = new Set();
      Object.values(rotations.starters || {}).forEach(id => assigned.add(id));
      Object.values(rotations.benchOrder || {}).forEach(arr => arr.forEach(id => assigned.add(id)));
      Object.keys(rotations.minutes || {}).forEach(id => {
        if (rotations.minutes[id] > 0 && !assigned.has(id)) {
          warnings.push(`Player ${id.slice(0,8)} has minutes but no position slot.`);
        }
      });

      // Validate no duplicate starters
      if (!validateRotation(rotations)) {
        errors.push("Duplicate starter assignment detected.");
      }

      return { errors, warnings };
    }

    /**
     * Auto-fix minutes to equal 240 total
     */
    function autoFixMinutes(teamId) {
      const rotations = state.league.rotations?.[teamId];
      if (!rotations) return;

      const currentTotal = getTotalMinutes(rotations);
      if (currentTotal === 0) return;

      const scale = 240 / currentTotal;
      Object.keys(rotations.minutes).forEach(playerId => {
        rotations.minutes[playerId] = Math.round(rotations.minutes[playerId] * scale);
      });

      // Ensure exact 240
      const newTotal = getTotalMinutes(rotations);
      const diff = 240 - newTotal;
      if (diff !== 0) {
        const starters = Object.values(rotations.starters || {});
        if (starters.length > 0) {
          rotations.minutes[starters[0]] = (rotations.minutes[starters[0]] || 0) + diff;
        }
      }
    }

    /**********************
     * SCHEDULE SYSTEM
     **********************/

    /**
     * Assign conferences and divisions deterministically
     */
    function assignConferencesAndDivisions(league) {
      const teams = [...league.teams].sort((a,b) => a.name.localeCompare(b.name));
      
      // East: first 15, West: last 15
      const east = teams.slice(0, 15);
      const west = teams.slice(15, 30);
      
      // Assign divisions
      const divisions = ["1", "2", "3"];
      
      // East divisions
      east.forEach((team, idx) => {
        team.conf = "East";
        team.div = `East-${divisions[Math.floor(idx / 5)]}`;
      });
      
      // West divisions
      west.forEach((team, idx) => {
        team.conf = "West";
        team.div = `West-${divisions[Math.floor(idx / 5)]}`;
      });
    }

    /**
     * Get division teams (excluding self)
     */
    function getDivisionOpponents(team, league) {
      return league.teams.filter(t => t.div === team.div && t.id !== team.id);
    }

    /**
     * Get conference opponents in other divisions
     */
    function getConferenceNonDivisionOpponents(team, league) {
      return league.teams.filter(t => t.conf === team.conf && t.div !== team.div);
    }

    /**
     * Get inter-conference opponents
     */
    function getInterConferenceOpponents(team, league) {
      return league.teams.filter(t => t.conf !== team.conf);
    }

    /**
     * Generate 82-game schedule
     */
    function generateSchedule(league) {
      const teams = league.teams;
      const season = league.meta.season;
      const games = [];

      // DIVISION GAMES: Process each division once
      teams.forEach(team => {
        const divisionOpponents = getDivisionOpponents(team, league);
        divisionOpponents.forEach(opp => {
          // Only process if this team ID is less than opponent ID (canonical direction)
          if (team.id < opp.id) {
            // 2 home + 2 away games
            games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: opp.id, played: false });
            games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: opp.id, played: false });
            games.push({ id: uuid(), season, day: 0, homeTid: opp.id, awayTid: team.id, played: false });
            games.push({ id: uuid(), season, day: 0, homeTid: opp.id, awayTid: team.id, played: false });
          }
        });
      });

      // INTER-CONFERENCE AND INTRA-CONF NON-DIV GAMES
      // Process only one direction for each pair to avoid duplicates
      for (let i = 0; i < teams.length; i++) {
        const team = teams[i];
        const interConfOpponents = getInterConferenceOpponents(team, league);
        const confNonDivOpponents = getConferenceNonDivisionOpponents(team, league);

        // Inter-conference: 1 home, 1 away per opponent
        interConfOpponents.forEach(opp => {
          if (team.id < opp.id) {
            games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: opp.id, played: false });
            games.push({ id: uuid(), season, day: 0, homeTid: opp.id, awayTid: team.id, played: false });
          }
        });

        // Intra-conf non-division: 36 total per team
        const confNonDivIds = confNonDivOpponents.map(t => t.id).sort();
        if (confNonDivIds.length > 0) {
          const offset = (season % confNonDivIds.length);
          const rotated = [...confNonDivIds.slice(offset), ...confNonDivIds.slice(0, offset)];
          
          const playFourTimes = rotated.slice(0, 6);
          const playThreeTimes = rotated.slice(6, 10);

          playFourTimes.forEach(oppId => {
            if (team.id < oppId) {
              // 2 home, 2 away
              games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: oppId, played: false });
              games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: oppId, played: false });
              games.push({ id: uuid(), season, day: 0, homeTid: oppId, awayTid: team.id, played: false });
              games.push({ id: uuid(), season, day: 0, homeTid: oppId, awayTid: team.id, played: false });
            }
          });

          playThreeTimes.forEach((oppId, idx) => {
            if (team.id < oppId) {
              if (idx % 2 === 0) {
                // 2 home, 1 away
                games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: oppId, played: false });
                games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: oppId, played: false });
                games.push({ id: uuid(), season, day: 0, homeTid: oppId, awayTid: team.id, played: false });
              } else {
                // 1 home, 2 away
                games.push({ id: uuid(), season, day: 0, homeTid: team.id, awayTid: oppId, played: false });
                games.push({ id: uuid(), season, day: 0, homeTid: oppId, awayTid: team.id, played: false });
                games.push({ id: uuid(), season, day: 0, homeTid: oppId, awayTid: team.id, played: false });
              }
            }
          });
        }
      }

      // Assign games to days using greedy scheduling
      const maxDays = 175;
      const byTeam = {};
      teams.forEach(t => byTeam[t.id] = []);

      const unscheduled = [...games];
      
      for (let day = 1; day <= maxDays && unscheduled.length > 0; day++) {
        const dayTeams = new Set();
        const toRemove = [];

        // Find feasible games for this day
        for (let i = 0; i < unscheduled.length; i++) {
          const game = unscheduled[i];
          if (!dayTeams.has(game.homeTid) && !dayTeams.has(game.awayTid)) {
            game.day = day;
            dayTeams.add(game.homeTid);
            dayTeams.add(game.awayTid);
            toRemove.push(i);
            if (dayTeams.size >= 28) break; // ~14 games max per day
          }
        }

        // Remove scheduled games (in reverse to maintain indices)
        for (let i = toRemove.length - 1; i >= 0; i--) {
          unscheduled.splice(toRemove[i], 1);
        }
      }

      // Assign remaining games if any
      unscheduled.forEach((game, idx) => {
        game.day = Math.floor(idx / 15) + maxDays + 1;
      });

      // Build byTeam index
      games.forEach(game => {
        byTeam[game.homeTid].push(game.id);
        byTeam[game.awayTid].push(game.id);
      });

      // Sort each team's games by day
      Object.keys(byTeam).forEach(tid => {
        byTeam[tid].sort((a, b) => {
          const dayA = games.find(g => g.id === a).day;
          const dayB = games.find(g => g.id === b).day;
          return dayA - dayB;
        });
      });

      return {
        season,
        games,
        byTeam,
        maxDays: Math.max(...games.map(g => g.day))
      };
    }

    /**
     * Generate player bio (nationality, hometown, college)
     */
    function generateBio(pos) {
      // Determine nationality: 70% USA, 30% International
      const isUSA = Math.random() < 0.7;
      let country, hometown, college;

      if (isUSA) {
        country = "USA";
        hometown = randomFrom(US_CITIES);
        // College choice for USA players: 80% NCAA, 20% alt paths
        if (Math.random() < 0.8) {
          college = randomFrom(NCAA_COLLEGES);
        } else {
          college = randomFrom(ALT_PATHS);
        }
      } else {
        // International player
        const countries = Object.keys(INTERNATIONAL_CITIES);
        country = randomFrom(countries);
        hometown = randomFrom(INTERNATIONAL_CITIES[country]);
        // College choice for international: 60% generic "International", 40% specific academies
        if (Math.random() < 0.6) {
          college = "International";
        } else {
          college = randomFrom(INTL_ACADEMIES);
        }
      }

      return { country, hometown, college };
    }

    /**
     * ensurePlayerIdentity: Single source of truth for player bio validity
     * Ensures player has legitimate (non-placeholder) values for all identity fields.
     * If fields are missing or placeholders, regenerates them with name-nationality coupling.
     * Never overwrites legitimate non-placeholder values.
     */
    function ensurePlayerIdentity(p, league, teams) {
      if (!p) return p;

      // Helper: check if a value is a placeholder
      function isPlaceholder(value, fallback) {
        if (value === undefined || value === null || value === "") return true;
        if (value === fallback) return true;
        // Empty string or whitespace-only
        if (typeof value === "string" && value.trim() === "") return true;
        return false;
      }

      // Define clear placeholder values
      const PLACEHOLDER_HOMETOWN = "Unknown";
      const PLACEHOLDER_COUNTRY = "USA";
      const PLACEHOLDER_COLLEGE = "International";

      // Check bio fields
      const hasValidHometown = !isPlaceholder(p.hometown, PLACEHOLDER_HOMETOWN);
      const hasValidCountry = !isPlaceholder(p.country, PLACEHOLDER_COUNTRY);
      const hasValidCollege = !isPlaceholder(p.college, PLACEHOLDER_COLLEGE);
      
      // Check physical fields
      const hasValidHeight = p.heightIn && p.heightIn > 0 && p.heightIn > 50 && p.heightIn < 95;
      const hasValidWeight = p.weightLb && p.weightLb > 0 && p.weightLb > 100 && p.weightLb < 350;
      const hasValidWingspan = p.wingspanIn && p.wingspanIn > 0 && p.wingspanIn > 50 && p.wingspanIn < 100;

      // Determine if player needs identity renewal
      // If ANY bio field is invalid, regenerate ALL bio fields
      const needsBioRenewal = !hasValidHometown || !hasValidCountry || !hasValidCollege;
      const needsPhysicalRenewal = !hasValidHeight || !hasValidWeight || !hasValidWingspan;

      if (needsBioRenewal) {
        // Regenerate complete bio with country + hometown + college
        const bio = generateBio(p.pos || "SF");
        p.country = bio.country;
        p.hometown = bio.hometown;
        p.college = bio.college;

        // Regenerate names matching the new country
        const playerName = generateNameForCountry(bio.country);
        p.firstName = playerName.firstName;
        p.lastName = playerName.lastName;
      }

      if (needsPhysicalRenewal) {
        // Regenerate physicals matching position and region
        const region = regionForCountry(p.country || "USA");
        const phys = makeHeightWeightWingspanWithRegion(p.pos || "SF", region);
        p.heightIn = phys.heightIn;
        p.weightLb = phys.weightLb;
        p.wingspanIn = phys.wingspanIn;
      }

      // Ensure names exist and are not empty (even if bios were valid)
      if (!p.firstName || typeof p.firstName !== "string" || p.firstName.trim() === "") {
        const playerName = generateNameForCountry(p.country || "USA");
        p.firstName = playerName.firstName;
      }
      if (!p.lastName || typeof p.lastName !== "string" || p.lastName.trim() === "") {
        const playerName = generateNameForCountry(p.country || "USA");
        p.lastName = playerName.lastName;
      }

      return p;
    }

    /**
     * ensureLeaguePlayersHaveIdentity: Apply ensurePlayerIdentity to all players in a league
     * Used as a safety pass to guarantee all players have valid identities after loading
     */
    function ensureLeaguePlayersHaveIdentity(league) {
      if (!league || !league.players || league.players.length === 0) {
        return league;
      }

      league.players.forEach(p => {
        ensurePlayerIdentity(p, league, league.teams);
      });

      return league;
    }
    function generateTeamLogo(abbrev, color, size = 32) {
      const svg = `
        <svg width="${size}" height="${size}" viewBox="0 0 40 40" style="display: inline-block; vertical-align: middle;">
          <circle cx="20" cy="20" r="19" fill="${color}" />
          <circle cx="20" cy="20" r="17" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1" />
          <text x="20" y="24" font-size="16" font-weight="bold" fill="white" text-anchor="middle" font-family="Arial, sans-serif">
            ${abbrev.substring(0, 2)}
          </text>
        </svg>
      `.trim();
      return svg;
    }

    // Generate inline logo HTML string
    function getTeamLogoHtml(abbrev, color, size = 32) {
      return generateTeamLogo(abbrev, color, size);
    }

    // 30 U.S. City-Based Basketball Teams (Original Nicknames, Not NBA)
    const FICTIONAL_TEAMS = [
      { name: "Austin Vipers", abbrev: "AUS", market_size: "Medium", conference: "Western", division: "Southwest", color: "#9c27b0" },
      { name: "Boston Royals", abbrev: "BOS", market_size: "Large", conference: "Eastern", division: "Atlantic", color: "#d4af37" },
      { name: "Charlotte Dynasty", abbrev: "CHN", market_size: "Small", conference: "Eastern", division: "Southeast", color: "#e91e63" },
      { name: "Chicago Wolves", abbrev: "CHW", market_size: "Large", conference: "Eastern", division: "Central", color: "#ff6f00" },
      { name: "Cleveland Titans", abbrev: "CLT", market_size: "Small", conference: "Eastern", division: "Central", color: "#0097a7" },
      { name: "Dallas Outlaws", abbrev: "DAL", market_size: "Large", conference: "Western", division: "Southwest", color: "#c41c3b" },
      { name: "Denver Avalanche", abbrev: "DEN", market_size: "Medium", conference: "Western", division: "Southwest", color: "#0066cc" },
      { name: "Detroit Motors", abbrev: "DET", market_size: "Small", conference: "Eastern", division: "Central", color: "#003d7a" },
      { name: "Houston Crusaders", abbrev: "HOU", market_size: "Large", conference: "Western", division: "Southwest", color: "#eb6e1f" },
      { name: "Indianapolis Patriots", abbrev: "IND", market_size: "Medium", conference: "Eastern", division: "Southeast", color: "#002d62" },
      { name: "Kansas City Royalty", abbrev: "KCR", market_size: "Small", conference: "Western", division: "Mountain", color: "#bd3039" },
      { name: "Las Vegas Outliers", abbrev: "LVE", market_size: "Small", conference: "Western", division: "Mountain", color: "#333333" },
      { name: "Los Angeles Radiance", abbrev: "LAR", market_size: "Large", conference: "Western", division: "Pacific", color: "#fdb827" },
      { name: "Memphis Legends", abbrev: "MEM", market_size: "Small", conference: "Eastern", division: "Southeast", color: "#12173f" },
      { name: "Miami Dolphins", abbrev: "MIA", market_size: "Large", conference: "Eastern", division: "Southeast", color: "#00b4d6" },
      { name: "Milwaukee Craftsmen", abbrev: "MIL", market_size: "Small", conference: "Eastern", division: "Central", color: "#12173f" },
      { name: "Minneapolis Tempest", abbrev: "MIN", market_size: "Medium", conference: "Eastern", division: "Central", color: "#0c2340" },
      { name: "New Orleans Legends", abbrev: "NOL", market_size: "Small", conference: "Eastern", division: "Southeast", color: "#0014bc" },
      { name: "New York Emperors", abbrev: "NYE", market_size: "Large", conference: "Eastern", division: "Atlantic", color: "#006bb6" },
      { name: "Philadelphia Rebels", abbrev: "PHI", market_size: "Large", conference: "Eastern", division: "Atlantic", color: "#ed174c" },
      { name: "Phoenix Scorpions", abbrev: "PHX", market_size: "Medium", conference: "Western", division: "Mountain", color: "#1d1160" },
      { name: "Portland Fury", abbrev: "POR", market_size: "Medium", conference: "Western", division: "Pacific", color: "#e03c3c" },
      { name: "Sacramento Sovereigns", abbrev: "SAC", market_size: "Small", conference: "Western", division: "Mountain", color: "#6f2da8" },
      { name: "San Antonio Silver", abbrev: "SAS", market_size: "Medium", conference: "Western", division: "Southwest", color: "#c4ced4" },
      { name: "San Diego Explorers", abbrev: "SDI", market_size: "Medium", conference: "Western", division: "Pacific", color: "#2f3e70" },
      { name: "San Francisco Dynasty", abbrev: "SFD", market_size: "Large", conference: "Western", division: "Pacific", color: "#1d428a" },
      { name: "Seattle Tempests", abbrev: "SEA", market_size: "Medium", conference: "Western", division: "Pacific", color: "#00471b" },
      { name: "Tampa Bay Raiders", abbrev: "TAM", market_size: "Small", conference: "Western", division: "Mountain", color: "#092c5e" },
      { name: "Toronto Legends", abbrev: "TOR", market_size: "Large", conference: "Eastern", division: "Atlantic", color: "#ce1141" },
      { name: "Washington Dynasty", abbrev: "WAS", market_size: "Medium", conference: "Eastern", division: "Atlantic", color: "#002b5c" },
    ];

    function generatePlayersForTeams(teams, playersPerTeam = 8) {
      const players = [];

      let playerIdx = 0;
      teams.forEach(team => {
        for (let i = 0; i < playersPerTeam; i++) {
          const ovr = randInt(50, 85);
          const pot = clamp(ovr + randInt(-5, 12), 45, 95);
          const age = randInt(19, 34);
          const salary = randInt(2, 30) * 1_000_000;
          
          // Generate bio (country/hometown/college)
          const bio = generateBio("SF");
          const region = regionForCountry(bio.country);
          
          // Pick position based on region tendencies
          const pos = pickPositionByRegion(region);
          
          // Generate physicals with region tendencies
          const phys = makeHeightWeightWingspanWithRegion(pos, region);
          const playerName = generateNameForCountry(bio.country);
          
          const draftYear = 2026 - (age - 19);
          
          // Generate ratings based on position and overall rating
          const ratings = generateRatings(pos, ovr, pot, region);

          const player = {
            id: uuid(),
            firstName: playerName.firstName,
            lastName: playerName.lastName,
            pos,
            age,
            teamId: team.id,
            ovr,
            pot,
            salary,
            mood: randInt(40, 90),
            stamina: randInt(70, 100),
            stats: { gp: 0, pts: 0, reb: 0, ast: 0 },
            // Bio fields
            heightIn: phys.heightIn,
            weightLb: phys.weightLb,
            wingspanIn: phys.wingspanIn,
            ...bio,
            draftYear,
            draftRound: randInt(1, 2),
            draftPick: randInt(1, 30),
            draftedByTid: team.id,
            // Contract
            contract: { amount: salary, years: randInt(2, 5), startSeason: draftYear + 1 },
            // Ratings and archetype
            ratings,
          };
          
          // Derive archetype from ratings
          const archetype = computeArchetype(player);
          player.archetype = archetype.primary;
          player.archetypeTags = archetype.tags;

          // Generate personality
          player.personality = generatePersonality(player.pos, region);
          player.personalityTags = computePersonalityTags(player);
          
          // Initialize morale
          player.morale = computeMorale(player, team, [], true);

          players.push(player);
          playerIdx++;
        }
      });

      return players;
    }

    function defaultLeague() {
      // Full NBA-style 30-team league
      const teams = [
        // EAST DIVISION 1
        { id: uuid(), name: "Atlanta Hawks", abbrev: "ATL", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Boston Celtics", abbrev: "BOS", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Charlotte Hornets", abbrev: "CHA", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Miami Heat", abbrev: "MIA", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Washington Wizards", abbrev: "WAS", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        // EAST DIVISION 2
        { id: uuid(), name: "Chicago Bulls", abbrev: "CHI", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Cleveland Cavaliers", abbrev: "CLE", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Detroit Pistons", abbrev: "DET", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Indianapolis Pacers", abbrev: "IND", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Milwaukee Bucks", abbrev: "MIL", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        // EAST DIVISION 3
        { id: uuid(), name: "Brooklyn Nets", abbrev: "BRK", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "New York Knicks", abbrev: "NYK", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Philadelphia 76ers", abbrev: "PHI", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Toronto Raptors", abbrev: "TOR", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Orlando Magic", abbrev: "ORL", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        // WEST DIVISION 1
        { id: uuid(), name: "Denver Nuggets", abbrev: "DEN", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Minnesota Timberwolves", abbrev: "MIN", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Oklahoma City Thunder", abbrev: "OKC", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Portland Trail Blazers", abbrev: "POR", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Utah Jazz", abbrev: "UTA", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        // WEST DIVISION 2
        { id: uuid(), name: "Golden State Warriors", abbrev: "GSW", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "LA Clippers", abbrev: "LAC", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "LA Lakers", abbrev: "LAL", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Phoenix Suns", abbrev: "PHX", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Sacramento Kings", abbrev: "SAC", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        // WEST DIVISION 3
        { id: uuid(), name: "Dallas Mavericks", abbrev: "DAL", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Houston Rockets", abbrev: "HOU", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "Memphis Grizzlies", abbrev: "MEM", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "New Orleans Pelicans", abbrev: "NOP", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
        { id: uuid(), name: "San Antonio Spurs", abbrev: "SAS", wins: 0, losses: 0, cash: 50_000_000, conf: "", div: "", confWins: 0, confLosses: 0, homeWins: 0, homeLosses: 0, roadWins: 0, roadLosses: 0, last10: [], streakType: "‚Äî", streakLen: 0 },
      ];

      const names = [
        ["Jalen", "Cross"], ["Malik", "Hughes"], ["Theo", "Navarro"], ["Darius", "Cole"],
        ["Andre", "Vaughn"], ["Zion", "Parker"], ["Marcus", "Reed"], ["Kyrie", "Santos"],
        ["Noah", "Okafor"], ["Devin", "Price"], ["Evan", "Knight"], ["Jordan", "Kim"],
      ];

      const players = names.map((n, i) => {
        const team = teams[i % teams.length];
        const ovr = randInt(50, 85);
        const pot = clamp(ovr + randInt(-5, 12), 45, 95);
        const age = randInt(19, 34);
        const salary = randInt(2, 30) * 1_000_000;
        
        // Generate realistic bio data
        const bio = generateBio("SF");  // Start with a position-neutral call
        const region = regionForCountry(bio.country);
        
        // Pick position based on region tendencies
        const pos = pickPositionByRegion(region);
        
        // Generate physicals with region tendencies
        const phys = makeHeightWeightWingspanWithRegion(pos, region);
        const playerName = generateNameForCountry(bio.country);
        
        const draftYear = 2026 - (age - 19);
        const draftRound = randInt(1, 2);
        const draftPick = randInt(1, 30);
        
        // Generate ratings based on position and overall rating
        const ratings = generateRatings(pos, ovr, pot, region);
        
        const player = {
          id: uuid(),
          firstName: playerName.firstName,
          lastName: playerName.lastName,
          pos,
          age,
          teamId: team.id,
          ovr,
          pot,
          salary,
          mood: randInt(40, 90),
          stamina: randInt(70, 100),
          stats: { gp: 0, pts: 0, reb: 0, ast: 0 },
          // Bio fields
          heightIn: phys.heightIn,
          weightLb: phys.weightLb,
          wingspanIn: phys.wingspanIn,
          ...bio,
          draftYear,
          draftRound,
          draftPick,
          draftedByTid: team.id,
          // Contract
          contract: { amount: salary, years: randInt(2, 5), startSeason: draftYear + 1 },
          // Ratings and archetype
          ratings,
        };
        
        // Derive archetype from ratings
        const archetype = computeArchetype(player);
        player.archetype = archetype.primary;
        player.archetypeTags = archetype.tags;
        
        // Generate personality
        player.personality = generatePersonality(player.pos, region);
        player.personalityTags = computePersonalityTags(player);
        
        // Initialize morale
        player.morale = 50;
        
        // Ensure player identity is valid (final safety check)
        ensurePlayerIdentity(player, null, teams);
        
        return player;
      });

      const league = {
        meta: {
          name: "My League",
          season: 2026,
          day: 1,
          phase: "REGULAR_SEASON",
        },
        teams,
        players,
        log: ["League created."],
        rotations: (() => {
          const rot = {};
          teams.forEach(team => {
            rot[team.id] = initializeRotations(team.id, players);
          });
          return rot;
        })(),
        schemaVersion: CURRENT_SCHEMA_VERSION
      };

      // Assign conferences/divisions and generate schedule
      assignConferencesAndDivisions(league);
      league.schedule = generateSchedule(league);

      return league;
    }

    /**********************
     * 2) Schema Migration
     **********************/
    function migrateLeague(league) {
      try {
        // Determine starting version
        let v = league.schemaVersion || 0;
        
        if (v >= CURRENT_SCHEMA_VERSION) {
          // Already at latest version
          return league;
        }

        console.log(`[Migration] Starting league migration from v${v} ‚Üí v${CURRENT_SCHEMA_VERSION}`);

        // Migration loop: incrementally apply each version upgrade
        while (v < CURRENT_SCHEMA_VERSION) {
          
          if (v === 0) {
            // v0 ‚Üí v1: Ensure all core fields exist
            console.log("[Migration] Applying v0 ‚Üí v1: Ensuring all core fields exist");
            
            league.meta = league.meta || {};
            league.meta.name = league.meta.name || "Imported League";
            league.meta.season = league.meta.season || 2026;
            league.meta.day = league.meta.day || 1;
            league.meta.phase = league.meta.phase || "REGULAR_SEASON";
            league.meta.userTeamId = league.meta.userTeamId || null;
            
            league.teams = league.teams || [];
            league.players = league.players || [];
            league.log = league.log || [];
            
            v = 1;
            league.schemaVersion = 1;
            console.log("[Migration] ‚úì v0 ‚Üí v1 complete");
          
          } else if (v === 1) {
            // v1 ‚Üí v2: Add team tracking fields for standings
            console.log("[Migration] Applying v1 ‚Üí v2: Adding team tracking fields");
            
            league.teams.forEach((team, idx) => {
              // Assign conferences: first half East, second half West
              team.conf = idx < Math.ceil(league.teams.length / 2) ? "East" : "West";
              team.confWins = team.confWins || 0;
              team.confLosses = team.confLosses || 0;
              team.homeWins = team.homeWins || 0;
              team.homeLosses = team.homeLosses || 0;
              team.roadWins = team.roadWins || 0;
              team.roadLosses = team.roadLosses || 0;
              team.last10 = team.last10 || [];
              team.streakType = team.streakType || "‚Äî";
              team.streakLen = team.streakLen || 0;
            });
            
            v = 2;
            league.schemaVersion = 2;
            console.log("[Migration] ‚úì v1 ‚Üí v2 complete");
          
          } else if (v === 2) {
            // v2 ‚Üí v3: Add player bio and contract fields
            console.log("[Migration] Applying v2 ‚Üí v3: Adding player bio and contract fields");
            
            const positions = ["PG", "SG", "SF", "PF", "C"];
            league.players = league.players || [];
            
            league.players.forEach(player => {
              // Default bio fields if missing
              if (!player.heightIn) {
                const pos = player.pos || "SF";
                let heightIn, weightLb;
                if (pos === "PG") {
                  heightIn = randInt(69, 76);
                  weightLb = randInt(170, 210);
                } else if (pos === "SG") {
                  heightIn = randInt(73, 79);
                  weightLb = randInt(190, 230);
                } else if (pos === "SF") {
                  heightIn = randInt(75, 82);
                  weightLb = randInt(210, 250);
                } else if (pos === "PF") {
                  heightIn = randInt(78, 84);
                  weightLb = randInt(230, 280);
                } else { // C
                  heightIn = randInt(80, 88);
                  weightLb = randInt(250, 310);
                }
                player.heightIn = heightIn;
                player.weightLb = weightLb;
                player.wingspanIn = heightIn + randInt(2, 10);
              }
              
              // Set initial bio placeholders (will be properly generated by ensurePlayerIdentity later)
              // Don't override existing values
              if (!player.hometown) player.hometown = "Unknown";
              if (!player.country) player.country = "USA";
              if (!player.college) player.college = "International";
              
              // Default draft fields if missing
              if (!player.draftYear) {
                const draftYear = league.meta.season - (player.age - 19);
                player.draftYear = draftYear;
                player.draftRound = player.draftRound || randInt(1, 2);
                player.draftPick = player.draftPick || randInt(1, 30);
                player.draftedByTid = player.draftedByTid || player.teamId;
              }
              
              // Default contract if missing
              if (!player.contract) {
                player.contract = {
                  amount: player.salary || 0,
                  years: randInt(2, 5),
                  startSeason: (league.meta.season || 2026) - 2
                };
              }
            });
            
            v = 3;
            league.schemaVersion = 3;
            console.log("[Migration] ‚úì v2 ‚Üí v3 complete");
          
          } else if (v === 3) {
            // v3 ‚Üí v4: Backfill placeholder bios with realistic data
            console.log("[Migration] Applying v3 ‚Üí v4: Backfilling placeholder bios with realistic data");
            
            league.players = league.players || [];
            
            league.players.forEach(player => {
              // Determine if this player has a placeholder bio that needs replacement
              const hasPlaceholderHometown = !player.hometown || player.hometown === "Unknown";
              const hasPlaceholderCollege = !player.college || player.college === "International";
              const hasPlaceholderCountry = !player.country || player.country === "USA";
              
              // Replace if: hometown is missing/Unknown OR college is missing/International
              // OR country is missing (conservative replacement strategy)
              if (hasPlaceholderHometown || hasPlaceholderCollege || (!player.country)) {
                const bio = generateBio(player.pos || "SF");
                player.hometown = bio.hometown;
                player.country = bio.country;
                player.college = bio.college;
              }
              
              // Ensure physical attributes exist and are reasonable
              if (!player.heightIn || player.heightIn === 0) {
                const phys = makeHeightWeightWingspan(player.pos || "SF");
                player.heightIn = phys.heightIn;
                player.weightLb = phys.weightLb;
                player.wingspanIn = phys.wingspanIn;
              } else if (!player.weightLb || player.weightLb === 0) {
                const phys = makeHeightWeightWingspan(player.pos || "SF");
                player.weightLb = phys.weightLb;
              }
              if (!player.wingspanIn || player.wingspanIn === 0) {
                player.wingspanIn = player.heightIn + randInt(2, 10);
              }
              
              // Ensure draft info exists
              if (!player.draftYear || player.draftYear === 0) {
                player.draftYear = league.meta.season - (player.age - 19);
              }
              if (!player.draftRound || player.draftRound === 0) {
                player.draftRound = randInt(1, 2);
              }
              if (!player.draftPick || player.draftPick === 0) {
                player.draftPick = randInt(1, 30);
              }
              if (!player.draftedByTid) {
                player.draftedByTid = player.teamId;
              }
            });
            
            v = 4;
            league.schemaVersion = 4;
            console.log("[Migration] ‚úì v3 ‚Üí v4 complete");
          
          } else if (v === 4) {
            // v4 ‚Üí v5: Couple player names to nationality
            console.log("[Migration] Applying v4 ‚Üí v5: Coupling player names to nationality");
            
            league.players = league.players || [];
            
            league.players.forEach(player => {
              // Determine if this player has a placeholder bio that needs updating
              const hasPlaceholderBio = 
                !player.hometown || player.hometown === "Unknown" ||
                !player.college || player.college === "International";
              
              if (hasPlaceholderBio) {
                // Regenerate full bio with country, hometown, college
                const bio = generateBio(player.pos || "SF");
                
                // Regenerate names matching the new country
                const playerName = generateNameForCountry(bio.country);
                
                // Update player fields with new bio and names
                player.firstName = playerName.firstName;
                player.lastName = playerName.lastName;
                player.country = bio.country;
                player.hometown = bio.hometown;
                player.college = bio.college;
              }
            });
            
            v = 5;
            league.schemaVersion = 5;
            console.log("[Migration] ‚úì v4 ‚Üí v5 complete");
          
          } else if (v === 5) {
            // v5 ‚Üí v6: Apply ensurePlayerIdentity to guarantee all players have valid bios
            // This is a comprehensive safety pass using the new ensurePlayerIdentity function
            console.log("[Migration] Applying v5 ‚Üí v6: Ensuring all players have valid identities");
            
            league.players = league.players || [];
            league = ensureLeaguePlayersHaveIdentity(league);
            
            v = 6;
            league.schemaVersion = 6;
            console.log("[Migration] ‚úì v5 ‚Üí v6 complete");
          
          } else if (v === 6) {
            // v6 ‚Üí v7: Generate ratings and archetypes for all players
            console.log("[Migration] Applying v6 ‚Üí v7: Generating player ratings and archetypes");
            
            league.players = league.players || [];
            
            league.players.forEach(player => {
              // Only generate if missing - don't overwrite existing ratings
              if (!player.ratings) {
                player.ratings = generateRatings(player.pos || "SF", player.ovr || 75, player.pot || 85, regionForCountry(player.country || "USA"));
              }
              
              if (!player.archetype) {
                const archetype = computeArchetype(player);
                player.archetype = archetype.primary;
                player.archetypeTags = archetype.tags || [];
              }
            });
            
            v = 7;
            league.schemaVersion = 7;
            console.log("[Migration] ‚úì v6 ‚Üí v7 complete");
          
          } else if (v === 7) {
            // v7 ‚Üí v8: Generate personality for all players
            console.log("[Migration] Applying v7 ‚Üí v8: Generating player personality traits");
            
            league.players = league.players || [];
            
            league.players.forEach(player => {
              // Only generate if missing - don't overwrite existing personality
              if (!player.personality) {
                const region = regionForCountry(player.country || "USA");
                player.personality = generatePersonality(player.pos || "SF", region);
                player.personalityTags = computePersonalityTags(player);
                player.morale = 50; // Default starting morale
              }
            });
            
            v = 8;
            league.schemaVersion = 8;
            console.log("[Migration] ‚úì v7 ‚Üí v8 complete");
          
          } else if (v === 8) {
            // v8 ‚Üí v9: Initialize rotations for all teams
            console.log("[Migration] Applying v8 ‚Üí v9: Initializing rotation system");
            
            league.rotations = league.rotations || {};
            league.players = league.players || [];
            league.teams = league.teams || [];
            
            league.teams.forEach(team => {
              if (!league.rotations[team.id]) {
                league.rotations[team.id] = initializeRotations(team.id, league.players);
              }
            });
            
            v = 9;
            league.schemaVersion = 9;
            console.log("[Migration] ‚úì v8 ‚Üí v9 complete");
          
          } else if (v === 9) {
            // v9 ‚Üí v10: Assign conferences/divisions and generate schedule
            console.log("[Migration] Applying v9 ‚Üí v10: Assigning conferences/divisions and generating schedule");
            
            league.teams = league.teams || [];
            league.players = league.players || [];
            
            // Assign conf/div if missing
            league.teams.forEach(team => {
              if (!team.conf || !team.div) {
                // Will be set by assignConferencesAndDivisions
              }
            });
            assignConferencesAndDivisions(league);
            
            // Generate schedule if missing
            if (!league.schedule) {
              league.schedule = generateSchedule(league);
            }
            
            v = 10;
            league.schemaVersion = 10;
            console.log("[Migration] ‚úì v9 ‚Üí v10 complete");
          }
          
          else {
            // Safety: if we encounter an unknown version, log and break
            console.warn(`[Migration] Unknown schema version ${v}, breaking migration loop`);
            break;
          }
        }

        console.log(`[Migration] ‚úì Migration complete. League now at v${league.schemaVersion}`);
        return league;

      } catch (err) {
        console.error("[Migration] ERROR during migration:", err);
        throw err;
      }
    }

    /**********************
     * 3) DB Operations
     **********************/
    async function listSaves() {
      try {
        if (db && db.saves && typeof db.saves.toArray === 'function') {
          return await db.saves.toArray();
        }
        // In-memory fallback
        return inMemorySaves;
      } catch (e) {
        console.error("Error listing saves:", e);
        return [];
      }
    }

    async function createSave(name) {
      const id = uuid();
      const now = Date.now();
      const saveRecord = { id, name, createdAt: now, updatedAt: now, lastOpenedAt: null };
      const league = defaultLeague();
      league.meta.name = name;

      try {
        if (db.saves.add) await db.saves.add(saveRecord);
        if (db.leagues.add) await db.leagues.add({ id, blob: league, schemaVersion: CURRENT_SCHEMA_VERSION });
        if (inMemorySaves && !dbError) inMemorySaves.push(saveRecord);
        if (inMemoryLeagues && dbError) inMemoryLeagues[id] = { id, blob: league, schemaVersion: CURRENT_SCHEMA_VERSION };
      } catch (e) {
        console.error("Error creating save:", e);
        showBanner("error", "‚ùå Failed to create save: " + e.message);
        return null;
      }

      localStorage.setItem("hoops_last_save_id", id);
      return id;
    }

    async function loadSave(id) {
      try {
        let leagueRecord;
        if (db.leagues.where && typeof db.leagues.where === "function") {
          leagueRecord = await db.leagues.where("id").equals(id).first();
        } else if (dbError) {
          leagueRecord = inMemoryLeagues[id];
        }

        if (!leagueRecord) return null;

        let league = leagueRecord.blob;
        const originalVersion = league.schemaVersion || 0;
        
        // Migrate league to current schema version
        league = migrateLeague(league);
        
        // Apply safety pass to ensure all players have valid identities (catches any edge cases)
        league = ensureLeaguePlayersHaveIdentity(league);
        
        // If migration occurred, save the upgraded league back to storage
        if ((league.schemaVersion || 0) > originalVersion) {
          console.log(`[LoadSave] Saving migrated league (v${originalVersion} ‚Üí v${league.schemaVersion}) back to storage`);
          try {
            if (db.leagues.update) {
              await db.leagues.update(id, {
                blob: league,
                schemaVersion: league.schemaVersion
              });
            } else if (dbError) {
              inMemoryLeagues[id] = {
                id,
                blob: league,
                schemaVersion: league.schemaVersion
              };
            }
          } catch (saveErr) {
            console.error("[LoadSave] Warning: Could not save migrated league back to storage:", saveErr);
            // Continue anyway - we have the migrated league in memory
          }
        }

        // Update lastOpenedAt
        const now = Date.now();
        if (db.saves.update) {
          await db.saves.update(id, { lastOpenedAt: now, updatedAt: now });
        } else if (dbError) {
          const save = inMemorySaves.find(s => s.id === id);
          if (save) {
            save.lastOpenedAt = now;
            save.updatedAt = now;
          }
        }

        localStorage.setItem("hoops_last_save_id", id);
        return league;
      } catch (e) {
        console.error("Error loading save:", e);
        showBanner("error", "‚ùå Failed to load save: " + e.message);
        return null;
      }
    }

    async function saveCurrentLeague() {
      if (!state.currentSaveId) return;
      try {
        // Ensure league has schemaVersion
        if (!state.league.schemaVersion) {
          state.league.schemaVersion = CURRENT_SCHEMA_VERSION;
        }
        
        const now = Date.now();
        if (db.leagues.update) {
          await db.leagues.update(state.currentSaveId, {
            blob: state.league,
            schemaVersion: state.league.schemaVersion
          });
        } else if (dbError) {
          inMemoryLeagues[state.currentSaveId] = {
            id: state.currentSaveId,
            blob: state.league,
            schemaVersion: state.league.schemaVersion
          };
        }

        if (db.saves.update) {
          await db.saves.update(state.currentSaveId, { updatedAt: now });
        } else if (dbError) {
          const save = inMemorySaves.find(s => s.id === state.currentSaveId);
          if (save) save.updatedAt = now;
        }

        setSaveStatus("Saved");
        clearTimeout(saveCurrentLeague._t);
        saveCurrentLeague._t = setTimeout(() => setSaveStatus("Loaded"), 900);
      } catch (e) {
        console.error("Error saving league:", e);
        showBanner("error", "‚ùå Auto-save failed: " + e.message);
      }
    }

    async function deleteSave(id) {
      if (!confirm(`Delete save "${id}"?`)) return false;
      try {
        if (db.saves.delete) await db.saves.delete(id);
        if (db.leagues.delete) await db.leagues.delete(id);
        if (dbError) {
          const idx = inMemorySaves.findIndex(s => s.id === id);
          if (idx >= 0) inMemorySaves.splice(idx, 1);
          delete inMemoryLeagues[id];
        }
        showBanner("success", "‚úì Save deleted");
        return true;
      } catch (e) {
        console.error("Error deleting save:", e);
        showBanner("error", "‚ùå Failed to delete save: " + e.message);
        return false;
      }
    }

    async function duplicateSave(id) {
      try {
        const league = await loadSave(id);
        if (!league) return null;
        const saveName = await promptFor("New save name:", `Copy of ${league.meta.name}`);
        if (!saveName) return null;
        const newId = await createSave(saveName);
        if (newId) {
          const deepCopy = JSON.parse(JSON.stringify(league));
          if (db.leagues.update) {
            await db.leagues.update(newId, { blob: deepCopy, schemaVersion: CURRENT_SCHEMA_VERSION });
          } else if (dbError) {
            inMemoryLeagues[newId] = { id: newId, blob: deepCopy, schemaVersion: CURRENT_SCHEMA_VERSION };
          }
          showBanner("success", "‚úì Save duplicated");
        }
        return newId;
      } catch (e) {
        console.error("Error duplicating save:", e);
        showBanner("error", "‚ùå Failed to duplicate save: " + e.message);
        return null;
      }
    }

    /**********************
     * 4) Export / Import
     **********************/
    function exportCurrentLeague() {
      if (!state.league) return;
      const data = {
        name: state.league.meta.name,
        schemaVersion: CURRENT_SCHEMA_VERSION,
        league: state.league,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `hoops-${data.name.replace(/\s+/g, "-")}-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showBanner("success", "‚úì League exported");
    }

    function promptFor(label, defaultVal) {
      return new Promise(resolve => {
        const val = prompt(label, defaultVal);
        resolve(val);
      });
    }

    async function importLeagueFromFile() {
      return new Promise((resolve) => {
        const input = document.getElementById("importFile");
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return resolve(null);
          const reader = new FileReader();
          reader.onload = async (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              let league = data.league || data;
              
              // Run migration on imported league
              console.log("[Import] Migrating imported league");
              league = migrateLeague(league);
              
              // Apply safety pass to ensure all players have valid identities
              league = ensureLeaguePlayersHaveIdentity(league);

              const saveName = await promptFor("Save name:", data.name || "Imported League");
              if (!saveName) return resolve(null);

              const newId = await createSave(saveName);
              if (newId) {
                // Save migrated league with current schema version
                if (db.leagues.update) {
                  await db.leagues.update(newId, {
                    blob: league,
                    schemaVersion: league.schemaVersion
                  });
                } else if (dbError) {
                  inMemoryLeagues[newId] = {
                    id: newId,
                    blob: league,
                    schemaVersion: league.schemaVersion
                  };
                }
                showBanner("success", "‚úì League imported");
                console.log(`[Import] ‚úì League imported and saved with schemaVersion ${league.schemaVersion}`);
                input.value = "";
                resolve(newId);
              } else {
                resolve(null);
              }
            } catch (err) {
              console.error("Import error:", err);
              showBanner("error", "‚ùå Invalid file: " + err.message);
              input.value = "";
              resolve(null);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });
    }

    /**********************
     * 5) State + UI Helpers
     **********************/
    const state = {
      route: "dashboard",
      league: null,
      currentSaveId: null,
      selectedTeamId: null,
      selectedPlayerId: null,
      userTeamId: null,
      saves: [],
      ui: {
        playerModalOpen: false,
        playerModalId: null,
        liveGameOpen: false,
        liveGame: null
      },
      live: {
        watch: {
          gameId: null,
          isOpen: false,
          isPlaying: false,
          speed: 1,
          tickMs: 250,
          timerId: null,
          possessionsPerTick: 1,
          lastRenderAt: 0
        }
      }
    };

    function setSaveStatus(text) {
      document.getElementById("saveStatus").textContent = text;
    }

    function showBanner(type, message) {
      const container = document.getElementById("bannerContainer");
      if (!container) return;
      const banner = document.createElement("div");
      banner.className = `banner ${type}`;
      banner.innerHTML = `
        <span>${message}</span>
        <button style="background:none;border:none;color:inherit;cursor:pointer;font-size:16px;" onclick="this.parentElement.style.display='none';">‚úï</button>
      `;
      container.appendChild(banner);
      setTimeout(() => {
        if (banner.parentElement) banner.style.display = "none";
      }, 4000);
    }

    /**********************
     * 6) Sim Logic
     **********************/
    function teamPower(teamId) {
      const roster = state.league.players.filter(p => p.teamId === teamId);
      const sorted = [...roster].sort((a,b) => b.ovr - a.ovr);
      const top = sorted.slice(0, 3);
      const rest = sorted.slice(3);
      const topAvg = top.length ? top.reduce((s,p)=>s+p.ovr,0)/top.length : 0;
      const restAvg = rest.length ? rest.reduce((s,p)=>s+p.ovr,0)/rest.length : topAvg;
      return (topAvg * 0.65) + (restAvg * 0.35);
    }

    function simulateOneGame(teamHome, teamAway) {
      const aPow = teamPower(teamHome.id) + randInt(-6, 6);
      const bPow = teamPower(teamAway.id) + randInt(-6, 6);
      const aPts = clamp(Math.round(95 + (aPow - 60) * 1.2 + randInt(-10, 10)), 70, 145);
      const bPts = clamp(Math.round(95 + (bPow - 60) * 1.2 + randInt(-10, 10)), 70, 145);

      let winner = teamHome, loser = teamAway, wPts = aPts, lPts = bPts;
      let homeWon = true; // Track if home team won
      if (bPts > aPts) { winner = teamAway; loser = teamHome; wPts = bPts; lPts = aPts; homeWon = false; }
      if (bPts === aPts) {
        if (Math.random() < 0.5) { winner = teamAway; loser = teamHome; wPts = bPts + 1; lPts = aPts; homeWon = false; }
        else { wPts = aPts + 1; lPts = bPts; homeWon = true; }
      }

      winner.wins += 1;
      loser.losses += 1;
      
      // Track home/road wins/losses
      if (homeWon) {
        teamHome.homeWins += 1;
        teamAway.roadLosses += 1;
      } else {
        teamHome.homeLosses += 1;
        teamAway.roadWins += 1;
      }
      
      // Track conference wins/losses
      if (teamHome.conference === teamAway.conference) {
        if (homeWon) {
          teamHome.confWins += 1;
          teamAway.confLosses += 1;
        } else {
          teamHome.confLosses += 1;
          teamAway.confWins += 1;
        }
      }
      
      // Update last10 array and streak
      const gameResult = winner.id === teamHome.id ? "W" : "L";
      for (const team of [teamHome, teamAway]) {
        team.last10.push(team.id === winner.id ? "W" : "L");
        if (team.last10.length > 10) team.last10.shift();
        
        // Update streak
        if (team.last10.length > 0) {
          const lastGame = team.last10[team.last10.length - 1];
          if (lastGame === team.streakType || team.streakType === "‚Äî") {
            team.streakType = lastGame;
            team.streakLen += 1;
          } else {
            team.streakType = lastGame;
            team.streakLen = 1;
          }
        }
      }
      
      distributeStats(winner.id, true);
      distributeStats(loser.id, false);

      return `${winner.abbrev} ${wPts} ‚Äî ${loser.abbrev} ${lPts}`;
    }

    function distributeStats(teamId, won) {
      const roster = state.league.players.filter(p => p.teamId === teamId).sort((a,b) => b.ovr - a.ovr);
      const minutesShare = getMinutesShare(teamId);
      const teamPts = randInt(90, 130);

      // Build offensive/assist/rebound weights based on ratings and minutes
      const weights = roster.map(p => {
        const share = minutesShare[p.id] || 0.05;
        const mins = Math.max(0, Math.round(share * 240));
        const r = p.ratings || {};
        const offFactor = ((r.fin || p.ovr) + (r.mid || p.ovr) + (r.tp || p.ovr) + (r.drb || p.ovr)) / 400; // 0..1-ish
        const astFactor = ((r.pas || p.ovr) / 100);
        const rebFactor = ((r.reb || p.ovr) / 100) + (p.pos === 'C' || p.pos === 'PF' ? 0.1 : 0);
        return { id: p.id, mins, share, offFactor, astFactor, rebFactor };
      });

      const totalOff = weights.reduce((s,w) => s + (w.share * (0.6 + w.offFactor)), 0);
      const totalAst = weights.reduce((s,w) => s + (w.share * (0.5 + w.astFactor)), 0);
      const totalReb = weights.reduce((s,w) => s + (w.share * (0.5 + w.rebFactor)), 0);

      // Allocate stats proportionally
      roster.forEach(p => {
        const w = weights.find(x => x.id === p.id);
        if (!w || w.mins <= 0) return;

        // Points allocation proportional to offensive weight
        const offWeight = w.share * (0.6 + w.offFactor);
        const pts = Math.round(teamPts * (offWeight / Math.max(0.0001, totalOff)));

        // Assists and rebounds similarly
        const ast = Math.round( randInt(0, Math.max(1, 8)) * ( (w.share * (0.5 + w.astFactor)) / Math.max(0.0001, totalAst) ) );
        const reb = Math.round( randInt(0, Math.max(1, 10)) * ( (w.share * (0.5 + w.rebFactor)) / Math.max(0.0001, totalReb) ) );

        p.stats.gp += 1;
        p.stats.pts += clamp(pts, 0, 60);
        p.stats.reb += clamp(reb, 0, 30);
        p.stats.ast += clamp(ast, 0, 20);

        // Mood adjustment
        p.mood = clamp(p.mood + (won ? randInt(0,2) : -randInt(0,2)), 0, 100);

        // Stamina loss proportional to minutes
        const staminaLoss = Math.round(w.mins * 0.15) + randInt(-2, 2);
        p.stamina = clamp(p.stamina - staminaLoss, 0, 100);
      });
    }

    // Team Dashboard Helper Functions
    function getTeamOffenseRating(teamId) {
      const roster = state.league.players.filter(p => p.teamId === teamId);
      if (roster.length === 0) return 0;
      return Math.round(roster.reduce((s, p) => s + p.ovr, 0) / roster.length);
    }

    function getTeamDefenseRating(teamId) {
      // Simple model: average OVR with position bonus
      const roster = state.league.players.filter(p => p.teamId === teamId);
      if (roster.length === 0) return 0;
      let defensiveOVR = 0;
      roster.forEach(p => {
        // Big men worth more on defense
        let posBonus = (p.pos === "PF" || p.pos === "C") ? 1.1 : 0.9;
        defensiveOVR += p.ovr * posBonus;
      });
      return Math.round(defensiveOVR / roster.length);
    }

    function getTeamOverallRating(teamId) {
      // Average of top 3 players (weighted differently)
      const roster = state.league.players.filter(p => p.teamId === teamId).sort((a, b) => b.ovr - a.ovr);
      if (roster.length === 0) return 0;
      const top3 = roster.slice(0, 3);
      return Math.round(top3.reduce((s, p) => s + p.ovr, 0) / top3.length);
    }

    function getTeamSalaryInfo(teamId) {
      const roster = state.league.players.filter(p => p.teamId === teamId);
      const totalSalary = roster.reduce((s, p) => s + p.salary, 0);
      const capLimit = 120_000_000; // 120M default cap
      const capRoom = capLimit - totalSalary;
      return { totalSalary, capLimit, capRoom, isOverCap: capRoom < 0 };
    }

    function getTeamPowerRank(teamId) {
      const teams = [...state.league.teams];
      const sorted = teams.map(t => ({ ...t, power: teamPower(t.id) })).sort((a, b) => b.power - a.power);
      const rank = sorted.findIndex(t => t.id === teamId) + 1;
      return `#${rank} of ${teams.length}`;
    }

    function getTopTeamPlayers(teamId, count = 3) {
      return state.league.players
        .filter(p => p.teamId === teamId)
        .sort((a, b) => b.ovr - a.ovr)
        .slice(0, count);
    }

    /**
     * Simulate a scheduled game without play-by-play
     */
    function simulateScheduledGame(gameId) {
      const schedule = state.league.schedule;
      const game = schedule.games.find(g => g.id === gameId);
      
      if (!game || game.played) {
        showBanner("error", "‚ùå Game already played or not found");
        return;
      }

      const homeTeam = teamById(game.homeTid);
      const awayTeam = teamById(game.awayTid);
      
      // Calculate scores using team power ratings
      const aPow = teamPower(homeTeam.id) + randInt(-6, 6);
      const bPow = teamPower(awayTeam.id) + randInt(-6, 6);
      const homeScore = clamp(Math.round(95 + (aPow - 60) * 1.2 + randInt(-10, 10)), 70, 145);
      const awayScore = clamp(Math.round(95 + (bPow - 60) * 1.2 + randInt(-10, 10)), 70, 145);
      
      // Determine winner and update records
      const homeWon = homeScore > awayScore;
      
      if (homeWon) {
        homeTeam.wins += 1;
        awayTeam.losses += 1;
        homeTeam.homeWins += 1;
        awayTeam.roadLosses += 1;
      } else {
        homeTeam.losses += 1;
        awayTeam.wins += 1;
        homeTeam.homeLosses += 1;
        awayTeam.roadWins += 1;
      }

      // Conference records
      if (homeTeam.conf === awayTeam.conf) {
        if (homeWon) {
          homeTeam.confWins += 1;
          awayTeam.confLosses += 1;
        } else {
          homeTeam.confLosses += 1;
          awayTeam.confWins += 1;
        }
      }

      // Update streaks and last 10
      for (const team of [homeTeam, awayTeam]) {
        const result = (team.id === homeTeam.id && homeWon) || (team.id === awayTeam.id && !homeWon) ? 'W' : 'L';
        team.last10.push(result);
        if (team.last10.length > 10) team.last10.shift();
        
        if (team.last10.length > 0) {
          const lastGame = team.last10[team.last10.length - 1];
          if (lastGame === team.streakType || team.streakType === "‚Äî") {
            team.streakType = lastGame;
            team.streakLen += 1;
          } else {
            team.streakType = lastGame;
            team.streakLen = 1;
          }
        }
      }

      // Distribute stats
      distributeStats(homeTeam.id, homeWon);
      distributeStats(awayTeam.id, !homeWon);

      // Store result in schedule
      game.played = true;
      game.homeScore = homeScore;
      game.awayScore = awayScore;
      
      showBanner("success", `‚úì ${awayTeam.abbrev} ${awayScore} ‚Äì ${homeTeam.abbrev} ${homeScore}`);
    }

    /**
     * Initialize live game object for watching
     */
    function initLiveGame(gameId) {
      const schedule = state.league.schedule;
      const game = schedule.games.find(g => g.id === gameId);
      
      if (!game || game.played) {
        showBanner("error", "‚ùå Game already played or not found");
        return null;
      }

      const homeTeam = teamById(game.homeTid);
      const awayTeam = teamById(game.awayTid);
      
      return {
        gameId,
        season: state.league.meta.season,
        day: state.league.meta.day,
        homeTid: game.homeTid,
        awayTid: game.awayTid,
        homeTeam: homeTeam.name,
        awayTeam: awayTeam.name,
        quarter: 1,
        clock: 720, // 12 minutes = 720 seconds per quarter
        homeScore: 0,
        awayScore: 0,
        possession: Math.random() < 0.5 ? game.homeTid : game.awayTid,
        homeStats: {},
        awayStats: {},
        pbp: [],
        isFinal: false,
        isPlaying: false
      };
    }

    /**
     * Play next possession in the game
     */
    function playNextPossession(liveGame) {
      if (liveGame.isFinal) return;
      
      const offenseTid = liveGame.possession;
      const defenseTid = offenseTid === liveGame.homeTid ? liveGame.awayTid : liveGame.homeTid;
      
      const offenseTeam = teamById(offenseTid);
      const defenseTeam = teamById(defenseTid);
      
      // Get on-court rosters
      const offenseRoster = state.league.players.filter(p => p.teamId === offenseTid).sort((a,b) => b.ovr - a.ovr).slice(0, 5);
      const defenseRoster = state.league.players.filter(p => p.teamId === defenseTid).sort((a,b) => b.ovr - a.ovr).slice(0, 5);
      
      if (offenseRoster.length === 0) return;
      
      // Pick random offensive player
      const scorer = offenseRoster[randInt(0, offenseRoster.length - 1)];
      const defender = defenseRoster[randInt(0, defenseRoster.length - 1)];
      
      // Initialize player stats if needed
      if (!liveGame[offenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][scorer.id]) {
        const stats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, tov: 0, fga: 0, fgm: 0, tpa: 0, tpm: 0, fta: 0, ftm: 0 };
        liveGame[offenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][scorer.id] = stats;
      }
      if (!liveGame[defenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][defender.id]) {
        const stats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, tov: 0, fga: 0, fgm: 0, tpa: 0, tpm: 0, fta: 0, ftm: 0 };
        liveGame[defenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][defender.id] = stats;
      }

      // Determine action type weighted by player ratings
      const ratings = scorer.ratings || {};
      const rand = Math.random();
      let action = 'midrange';
      
      if (rand < 0.05) action = 'turnover';
      else if (rand < 0.15) action = 'foul';
      else if (rand < 0.30) action = '3pt';
      else if (rand < 0.55) action = 'midrange';
      else if (rand < 0.80) action = 'drive';
      else action = 'pass';

      const playerStats = liveGame[offenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][scorer.id];

      switch (action) {
        case 'turnover': {
          playerStats.tov += 1;
          const pbpTexts = [
            `${scorer.firstName} turns the ball over.`,
            `Turnover ‚Äî bad pass by ${scorer.firstName}.`,
            `${scorer.firstName} loses control of the ball.`
          ];
          liveGame.pbp.push({
            q: liveGame.quarter,
            t: formatClockTime(liveGame.clock),
            text: pbpTexts[randInt(0, pbpTexts.length - 1)]
          });
          liveGame.possession = defenseTid;
          break;
        }
        case 'foul': {
          const foulTexts = [
            `Foul on ${defender.firstName}.`,
            `${defender.firstName} fouls ${scorer.firstName}.`,
            `Personal foul on ${defender.firstName}.`
          ];
          liveGame.pbp.push({
            q: liveGame.quarter,
            t: formatClockTime(liveGame.clock),
            text: foulTexts[randInt(0, foulTexts.length - 1)] + ` Free throws.`
          });
          // Free throws
          const ftAttempts = randInt(1, 2);
          playerStats.fta += ftAttempts;
          const ftMakes = Math.random() < 0.75 ? ftAttempts : Math.max(0, ftAttempts - 1);
          playerStats.ftm += ftMakes;
          playerStats.pts += ftMakes;
          if (offenseTid === liveGame.homeTid) liveGame.homeScore += ftMakes;
          else liveGame.awayScore += ftMakes;
          liveGame.possession = defenseTid;
          break;
        }
        case '3pt': {
          playerStats.tpa += 1;
          const shooterRating = (ratings.tp || scorer.ovr) + randInt(-5, 5);
          const defenderRating = (defenseRoster.find(p => p.id === defender.id)?.ratings?.perD || defender.ovr) + randInt(-5, 5);
          const make = shooterRating + randInt(-3, 3) > defenderRating;
          
          if (make) {
            playerStats.tpm += 1;
            playerStats.fgm += 1;
            playerStats.pts += 3;
            if (offenseTid === liveGame.homeTid) liveGame.homeScore += 3;
            else liveGame.awayScore += 3;
            
            const make3pts = [
              `${scorer.firstName} nails a three!`,
              `${scorer.firstName} buries a corner three!`,
              `From deep ‚Äî ${scorer.firstName} hits a three-pointer!`,
              `${scorer.firstName} drains it from downtown!`
            ];
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: make3pts[randInt(0, make3pts.length - 1)]
            });
          } else {
            playerStats.fga += 1;
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: `${scorer.firstName} misses a three-pointer.`
            });
          }
          liveGame.possession = defenseTid;
          break;
        }
        case 'midrange': {
          playerStats.fga += 1;
          const shooterRating = (ratings.mid || scorer.ovr) + randInt(-5, 5);
          const defenderRating = (defenseRoster.find(p => p.id === defender.id)?.ratings?.perD || defender.ovr) + randInt(-5, 5);
          const make = shooterRating + randInt(-3, 3) > defenderRating;
          
          if (make) {
            playerStats.fgm += 1;
            playerStats.pts += 2;
            if (offenseTid === liveGame.homeTid) liveGame.homeScore += 2;
            else liveGame.awayScore += 2;
            
            const makeMid = [
              `${scorer.firstName} hits a pull-up jumper.`,
              `${scorer.firstName} drains the mid-range shot.`,
              `Good! ${scorer.firstName} from the mid-post.`
            ];
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: makeMid[randInt(0, makeMid.length - 1)]
            });
          } else {
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: `${scorer.firstName} misses the midrange shot.`
            });
          }
          liveGame.possession = defenseTid;
          break;
        }
        case 'drive': {
          playerStats.fga += 1;
          const driverRating = ((ratings.fin || 0) + (ratings.ath || 0) + (ratings.spd || 0)) / 300 * 100;
          const defenderRating = (defenseRoster.find(p => p.id === defender.id)?.ratings?.perD || defender.ovr) + randInt(-5, 5);
          const make = driverRating + randInt(-3, 3) > defenderRating;
          
          if (make) {
            playerStats.fgm += 1;
            playerStats.pts += 2;
            if (offenseTid === liveGame.homeTid) liveGame.homeScore += 2;
            else liveGame.awayScore += 2;
            
            const driveTexts = [
              `${scorer.firstName} drives and finishes at the rim.`,
              `${scorer.firstName} drives hard and scores!`,
              `Layup! ${scorer.firstName} with the take.`
            ];
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: driveTexts[randInt(0, driveTexts.length - 1)]
            });
          } else {
            // Possible block
            if (Math.random() < 0.3) {
              const defenderStats = liveGame[defenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][defender.id];
              defenderStats.blk += 1;
              liveGame.pbp.push({
                q: liveGame.quarter,
                t: formatClockTime(liveGame.clock),
                text: `${defender.firstName} blocks ${scorer.firstName}!`
              });
            } else {
              liveGame.pbp.push({
                q: liveGame.quarter,
                t: formatClockTime(liveGame.clock),
                text: `${scorer.firstName} misses the layup.`
              });
            }
          }
          liveGame.possession = defenseTid;
          break;
        }
        case 'pass': {
          // Pass to assist
          const passer = scorer;
          const passerStats = playerStats;
          const recipients = offenseRoster.filter(p => p.id !== passer.id);
          const recipient = recipients[randInt(0, recipients.length - 1)];
          
          if (!liveGame[offenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][recipient.id]) {
            const stats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, tov: 0, fga: 0, fgm: 0, tpa: 0, tpm: 0, fta: 0, ftm: 0 };
            liveGame[offenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][recipient.id] = stats;
          }
          
          const recipientStats = liveGame[offenseTid === liveGame.homeTid ? 'homeStats' : 'awayStats'][recipient.id];
          recipientStats.fga += 1;
          
          const shooterRating = (recipient.ratings?.fin || recipient.ovr) + randInt(-5, 5);
          const defenderRating = (defenseRoster.find(p => p.id !== defender.id)?.ratings?.perD || defenseTeam.abbrev) + randInt(-5, 5);
          const make = shooterRating + randInt(-3, 3) > defenderRating;
          
          if (make) {
            recipientStats.fgm += 1;
            recipientStats.pts += 2;
            passerStats.ast += 1;
            if (offenseTid === liveGame.homeTid) liveGame.homeScore += 2;
            else liveGame.awayScore += 2;
            
            const assistTexts = [
              `${passer.firstName} finds ${recipient.firstName} for the bucket. (Assist: ${passer.firstName})`,
              `${recipient.firstName} scores on the pass from ${passer.firstName}. (Assist: ${passer.firstName})`,
              `Good pass! ${recipient.firstName} finishes. (Assist: ${passer.firstName})`
            ];
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: assistTexts[randInt(0, assistTexts.length - 1)]
            });
          } else {
            liveGame.pbp.push({
              q: liveGame.quarter,
              t: formatClockTime(liveGame.clock),
              text: `${recipient.firstName} misses the shot.`
            });
          }
          liveGame.possession = defenseTid;
          break;
        }
      }

      // Advance clock
      liveGame.clock -= randInt(6, 24);
      
      // Check for quarter end
      if (liveGame.clock <= 0) {
        if (liveGame.quarter < 4) {
          liveGame.quarter += 1;
          liveGame.clock = 720;
          liveGame.pbp.push({
            q: liveGame.quarter,
            t: '12:00',
            text: `End of Q${liveGame.quarter - 1}. Q${liveGame.quarter} begins.`
          });
        } else {
          liveGame.isFinal = true;
          liveGame.pbp.push({
            q: 4,
            t: '00:00',
            text: `FINAL: ${liveGame.awayTeam} ${liveGame.awayScore} ‚Äì ${liveGame.homeTeam} ${liveGame.homeScore}`
          });
        }
      }

      // Cap PBP size
      if (liveGame.pbp.length > 400) {
        liveGame.pbp = liveGame.pbp.slice(-250);
      }
    }

    function formatClockTime(seconds) {
      const mins = Math.floor(Math.abs(seconds) / 60);
      const secs = Math.abs(seconds) % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    /**
     * Watch Game Loop Management
     */
    function startWatchLoop() {
      stopWatchLoop(); // Always clear first to prevent double timers
      state.live.watch.isPlaying = true;
      const baseTickMs = 250;
      const adjustedTickMs = Math.max(40, Math.round(baseTickMs / state.live.watch.speed));
      state.live.watch.timerId = setInterval(onWatchTick, adjustedTickMs);
    }

    function stopWatchLoop() {
      if (state.live.watch.timerId) {
        clearInterval(state.live.watch.timerId);
        state.live.watch.timerId = null;
      }
      state.live.watch.isPlaying = false;
    }

    function onWatchTick() {
      try {
        if (!state.live.watch.isOpen || !state.ui.liveGame) {
          stopWatchLoop();
          return;
        }

        const lg = state.ui.liveGame;
        if (lg.isFinal) {
          stopWatchLoop();
          return;
        }

        // Run multiple possessions based on speed
        const possessionsThisTick = state.live.watch.possessionsPerTick;
        for (let i = 0; i < possessionsThisTick && !lg.isFinal; i++) {
          playNextPossession(lg);
        }

        // Update UI elements incrementally (DON'T re-render entire page)
        updateWatchGameUI();
      } catch (err) {
        console.error("[Watch Tick Error]", err);
        stopWatchLoop();
        showBanner("error", "‚ùå Watch error: " + err.message);
      }
    }

    function updateWatchGameUI() {
      const lg = state.ui.liveGame;
      if (!lg) return;

      // Update score
      const scoreAwayEl = document.getElementById("watchScoreAway");
      if (scoreAwayEl) scoreAwayEl.textContent = lg.awayScore;

      const scoreHomeEl = document.getElementById("watchScoreHome");
      if (scoreHomeEl) scoreHomeEl.textContent = lg.homeScore;

      // Update clock and quarter
      const clockEl = document.getElementById("watchClock");
      if (clockEl) {
        if (lg.isFinal) {
          clockEl.textContent = "FINAL";
          clockEl.style.color = "#ef4444";
        } else {
          clockEl.textContent = `Q${lg.quarter} ¬∑ ${formatClockTime(lg.clock)}`;
          clockEl.style.color = "#eab308";
        }
      }

      // Render leaders
      updateWatchLeaders();

      // Render PBP feed
      updateWatchPBP();

      // Update control buttons
      updateWatchControls();
    }

    function updateWatchLeaders() {
      const lg = state.ui.liveGame;
      if (!lg) return;

      const homeStatKeys = Object.keys(lg.homeStats);
      const awayStatKeys = Object.keys(lg.awayStats);

      const homeLeaders = homeStatKeys.length > 0
        ? homeStatKeys
            .map(pid => ({
              ...state.league.players.find(p => p.id === pid),
              stats: lg.homeStats[pid]
            }))
            .sort((a, b) => (b.stats?.pts || 0) - (a.stats?.pts || 0))
            .slice(0, 3)
        : [];

      const awayLeaders = awayStatKeys.length > 0
        ? awayStatKeys
            .map(pid => ({
              ...state.league.players.find(p => p.id === pid),
              stats: lg.awayStats[pid]
            }))
            .sort((a, b) => (b.stats?.pts || 0) - (a.stats?.pts || 0))
            .slice(0, 3)
        : [];

      // Update away leaders
      const awayLeadersEl = document.getElementById("watchLeadersAway");
      if (awayLeadersEl) {
        awayLeadersEl.innerHTML = awayLeaders
          .map(
            p => `
              <div style="font-size: 12px; padding: 4px; color: #ccc; border-bottom: 1px solid #333;">
                ${p.firstName} ${p.lastName}: <span style="color: #60a5fa; font-weight: 600;">${p.stats.pts || 0} pts</span> ¬∑ ${p.stats.reb || 0} reb ¬∑ ${p.stats.ast || 0} ast
              </div>
            `
          )
          .join("");
      }

      // Update home leaders
      const homeLeadersEl = document.getElementById("watchLeadersHome");
      if (homeLeadersEl) {
        homeLeadersEl.innerHTML = homeLeaders
          .map(
            p => `
              <div style="font-size: 12px; padding: 4px; color: #ccc; border-bottom: 1px solid #333;">
                ${p.firstName} ${p.lastName}: <span style="color: #22c55e; font-weight: 600;">${p.stats.pts || 0} pts</span> ¬∑ ${p.stats.reb || 0} reb ¬∑ ${p.stats.ast || 0} ast
              </div>
            `
          )
          .join("");
      }
    }

    function updateWatchPBP() {
      const lg = state.ui.liveGame;
      const pbpEl = document.getElementById("watchPBPFeed");
      if (!pbpEl || !lg) return;

      // Check if user is near bottom (auto-scroll enabled)
      const nearBottom =
        pbpEl.scrollHeight - pbpEl.scrollTop - pbpEl.clientHeight < 80;

      // Cap PBP display to last 120 entries for performance
      const displayPBP = lg.pbp.slice(-120).reverse();

      pbpEl.innerHTML =
        displayPBP.length === 0
          ? `<div style="text-align: center; color: #888; font-size: 13px; padding: 40px 0;">Game starting...</div>`
          : displayPBP
              .map(
                ev => `
                  <div style="padding: 6px 0; border-bottom: 1px solid #333; font-size: 12px;">
                    <span style="color: #888; font-weight: 600;">Q${ev.q} ${ev.t}</span><br/>
                    <span style="color: #ccc;">${ev.text}</span>
                  </div>
                `
              )
              .join("");

      // Auto-scroll only if user is near bottom
      if (nearBottom) {
        pbpEl.scrollTop = pbpEl.scrollHeight;
      }
    }

    function updateWatchControls() {
      const lg = state.ui.liveGame;
      if (!lg) return;

      const playPauseBtn = document.getElementById("watchPlayPauseBtn");
      if (playPauseBtn) {
        if (lg.isFinal) {
          playPauseBtn.style.display = "none";
        } else {
          playPauseBtn.style.display = "block";
          playPauseBtn.textContent = state.live.watch.isPlaying
            ? "‚è∏ Pause"
            : "‚ñ∂ Play";
          playPauseBtn.style.background = state.live.watch.isPlaying
            ? "#ef4444"
            : "#22c55e";
          playPauseBtn.style.color = state.live.watch.isPlaying
            ? "#fff"
            : "#000";
        }
      }
    }

    function simDay() {
      const { meta, teams, schedule } = state.league;
      
      // Regenerate stamina for all players
      state.league.players.forEach(p => {
        p.stamina = clamp(p.stamina + randInt(1, 4), 0, 100);
      });

      // Get games scheduled for today
      const todayGames = schedule && schedule.games 
        ? schedule.games.filter(g => g.day === meta.day && !g.played) 
        : [];

      const gameSummaries = [];

      // Simulate each scheduled game
      todayGames.forEach(game => {
        const homeTeam = teamById(game.homeTid);
        const awayTeam = teamById(game.awayTid);
        const result = simulateOneGame(homeTeam, awayTeam);
        
        // Mark game as played and store scores
        game.played = true;
        game.homeScore = result.homeScore || 0;
        game.awayScore = result.awayScore || 0;
        
        gameSummaries.push(result);
      });

      // Advance day
      meta.day += 1;
      
      // Check if season is over (all games played or we've exceeded maxDays)
      const allGamesPlayed = schedule && schedule.games && schedule.games.every(g => g.played);
      if (allGamesPlayed || (schedule && meta.day > schedule.maxDays)) {
        meta.day = 1;
        meta.season += 1;
        
        // Reset teams for new season
        teams.forEach(t => { 
          t.wins = 0; 
          t.losses = 0; 
          t.confWins = 0;
          t.confLosses = 0;
          t.homeWins = 0;
          t.homeLosses = 0;
          t.roadWins = 0;
          t.roadLosses = 0;
          t.last10 = [];
          t.streakType = "‚Äî";
          t.streakLen = 0;
        });
        
        // Generate new schedule
        state.league.schedule = generateSchedule(state.league);
        state.league.log.unshift(`Season advanced to ${meta.season}. Records reset and new schedule generated.`);
      }

      // Log results
      if (gameSummaries.length > 0) {
        state.league.log.unshift(`Day ${meta.day - 1} simmed: ${gameSummaries.join(" | ")}`);
      } else {
        state.league.log.unshift(`Day ${meta.day - 1}: No games scheduled`);
      }
      
      if (state.league.log.length > 25) state.league.log.length = 25;

      debounceAutoSave();
      render();
    }

    // Debounced autosave
    function debounceAutoSave() {
      clearTimeout(debounceAutoSave._t);
      debounceAutoSave._t = setTimeout(() => saveCurrentLeague(), 300);
    }

    /**********************
     * 4) Views
     **********************/
    function money(n) {
      return "$" + Math.round(n).toLocaleString();
    }
    function playerName(p) {
      return `${p.firstName} ${p.lastName}`;
    }
    function teamById(id) {
      return state.league.teams.find(t => t.id === id);
    }
    
    function playerById(id) {
      return state.league.players.find(p => p.id === id);
    }

    // Player modal helpers
    function openPlayerModal(playerId) {
      state.ui.playerModalOpen = true;
      state.ui.playerModalId = playerId;
      render();
    }

    function closePlayerModal() {
      state.ui.playerModalOpen = false;
      state.ui.playerModalId = null;
      render();
    }

    // Format player bio data
    function formatHeight(inches) {
      const feet = Math.floor(inches / 12);
      const in_remainder = inches % 12;
      return `${feet}'${in_remainder}"`;
    }

    function getPlayerContractInfo(player) {
      const contract = player.contract || { amount: player.salary, years: 3, startSeason: state.league.meta.season - 1 };
      const currentSeason = state.league.meta.season;
      const startYear = contract.startSeason;
      const endYear = startYear + contract.years - 1;
      const yearsRemaining = Math.max(0, endYear - currentSeason + 1);
      const totalValue = contract.amount * contract.years;
      
      return {
        annualSalary: contract.amount,
        totalValue,
        yearsRemaining,
        startYear,
        endYear
      };
    }

    // Player detail modal view
    function viewPlayerModal(playerId) {
      const player = playerById(playerId);
      if (!player) return '';
      
      const team = teamById(player.teamId);
      const draftedByTeam = teamById(player.draftedByTid);
      const contractInfo = getPlayerContractInfo(player);
      
      return `
        <div id="playerModalBackdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9998; cursor: pointer;"></div>
        <div id="playerModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100vh; background: #0d1117; z-index: 9999; overflow-y: auto; padding: 24px;">
          
          <!-- Close button -->
          <button id="playerModalClose" style="position: fixed; top: 24px; right: 24px; background: none; border: none; color: #60a5fa; font-size: 28px; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; z-index: 10000;">‚úï</button>
          
          <!-- Content wrapper with max-width -->
          <div style="max-width: 900px; margin: 0 auto;">
          
          <!-- Header -->
          <div style="margin-bottom: 24px;">
            <div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 8px;">
              <h2 style="font-size: 32px; font-weight: 700; margin: 0; color: #fff;">${escapeHtml(playerName(player))}</h2>
              <span style="font-size: 14px; color: #888;">${player.pos} ‚Ä¢ Age ${player.age}</span>
            </div>
            <div style="display: flex; gap: 32px; margin-top: 16px;">
              <div style="background: rgba(96,165,250,0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 12px 16px; text-align: center;">
                <div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Overall</div>
                <div style="font-size: 32px; font-weight: 700; color: #60a5fa;">${player.ovr}</div>
              </div>
              <div style="background: rgba(52,211,153,0.1); border: 1px solid #34d399; border-radius: 8px; padding: 12px 16px; text-align: center;">
                <div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Potential</div>
                <div style="font-size: 32px; font-weight: 700; color: #34d399;">${player.pot}</div>
              </div>
            </div>
          </div>
          
          <!-- Player Bio Card -->
          <div style="background: rgba(96,165,250,0.05); border: 1px solid rgba(96,165,250,0.2); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; color: #60a5fa; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;">Player Bio</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; font-size: 13px;">
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Height</div>
                <div style="color: #fff; font-weight: 500;">${formatHeight(player.heightIn || 78)}</div>
              </div>
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Weight</div>
                <div style="color: #fff; font-weight: 500;">${player.weightLb || 220} lbs</div>
              </div>
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Wingspan</div>
                <div style="color: #fff; font-weight: 500;">${formatHeight(player.wingspanIn || 80)}</div>
              </div>
            </div>
            
            <div style="color: #ccc; font-size: 13px; margin-bottom: 8px;">
              <span style="color: #888;">Hometown:</span> <strong>${escapeHtml(player.hometown || 'Unknown')}</strong>
            </div>
            <div style="color: #ccc; font-size: 13px; margin-bottom: 8px;">
              <span style="color: #888;">Country:</span> <strong>${escapeHtml(player.country || 'USA')}</strong>
            </div>
            <div style="color: #ccc; font-size: 13px; margin-bottom: 8px;">
              <span style="color: #888;">College:</span> <strong>${escapeHtml(player.college || 'International')}</strong>
            </div>
            
            <div style="color: #ccc; font-size: 13px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(96,165,250,0.1);">
              <span style="color: #888;">Draft:</span> <strong>${player.draftYear || 'N/A'}</strong> ‚Ä¢ 
              <strong>Round ${player.draftRound || '‚Äì'}</strong> ‚Ä¢ 
              <strong>Pick ${player.draftPick || '‚Äì'}</strong>
            </div>
            ${draftedByTeam ? `
              <div style="color: #ccc; font-size: 13px;">
                Drafted by <strong>${escapeHtml(draftedByTeam.name)}</strong>
              </div>
            ` : ''}
          </div>
          
          <!-- Attributes & Archetype Card -->
          <div style="background: rgba(168,85,247,0.05); border: 1px solid rgba(168,85,247,0.2); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; color: #a855f7; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;">Archetype & Attributes</h3>
            
            ${player.archetype ? `
              <div style="margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: #a855f7; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${escapeHtml(player.archetype)}</span>
                ${(player.archetypeTags || []).map(tag => `<span style="background: rgba(168,85,247,0.3); color: #d8b4fe; padding: 6px 12px; border-radius: 20px; font-size: 12px;">${escapeHtml(tag)}</span>`).join('')}
              </div>
            ` : ''}
            
            ${player.ratings ? `
              <div style="font-size: 12px; line-height: 1.8;">
                <div style="margin-bottom: 8px;">
                  <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Athleticism</div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 12px;">
                    <div><span style="color: #888;">ATH:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.ath}</span></div>
                    <div><span style="color: #888;">SPD:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.spd}</span></div>
                    <div><span style="color: #888;">STR:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.str}</span></div>
                    <div><span style="color: #888;">STA:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.stam}</span></div>
                  </div>
                </div>
                
                <div style="margin-bottom: 8px;">
                  <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Offense</div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 12px;">
                    <div><span style="color: #888;">DRB:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.drb}</span></div>
                    <div><span style="color: #888;">PAS:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.pas}</span></div>
                    <div><span style="color: #888;">FIN:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.fin}</span></div>
                    <div><span style="color: #888;">MID:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.mid}</span></div>
                    <div><span style="color: #888;">3PT:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.tp}</span></div>
                    <div><span style="color: #888;">FT:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.ft}</span></div>
                  </div>
                </div>
                
                <div style="margin-bottom: 8px;">
                  <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Defense</div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 12px;">
                    <div><span style="color: #888;">PER:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.perD}</span></div>
                    <div><span style="color: #888;">INT:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.inD}</span></div>
                    <div><span style="color: #888;">REB:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.reb}</span></div>
                    <div><span style="color: #888;">BLK:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.blk}</span></div>
                    <div><span style="color: #888;">STL:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.stl}</span></div>
                  </div>
                </div>
                
                <div>
                  <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Mental</div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
                    <div><span style="color: #888;">IQ:</span> <span style="color: #fff; font-weight: 600;">${player.ratings.iq}</span></div>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
          
          <!-- Personality Card -->
          <div style="background: rgba(34,197,94,0.05); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;">Personality & Morale</h3>
            
            ${player.personality ? `
              <div style="margin-bottom: 12px;">
                <div style="color: #ccc; font-size: 13px; margin-bottom: 8px;">
                  <span style="color: #888;">Morale:</span> <strong style="color: ${player.morale > 70 ? '#22c55e' : player.morale > 40 ? '#eab308' : '#ef4444'};">${Math.round(player.morale)}/100</strong>
                </div>
                
                ${(player.personalityTags || []).length > 0 ? `
                  <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                    ${player.personalityTags.map(tag => `<span style="background: rgba(34,197,94,0.3); color: #86efac; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">${escapeHtml(tag)}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
              
              <div style="font-size: 12px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; line-height: 1.4;">
                  <div><span style="color: #888;">Work Ethic:</span> <span style="color: #fff; font-weight: 600;">${player.personality.workEthic}</span></div>
                  <div><span style="color: #888;">Loyalty:</span> <span style="color: #fff; font-weight: 600;">${player.personality.loyalty}</span></div>
                  <div><span style="color: #888;">Ambition:</span> <span style="color: #fff; font-weight: 600;">${player.personality.ambition}</span></div>
                  <div><span style="color: #888;">Leadership:</span> <span style="color: #fff; font-weight: 600;">${player.personality.leadership}</span></div>
                  <div><span style="color: #888;">Ego:</span> <span style="color: #fff; font-weight: 600;">${player.personality.ego}</span></div>
                  <div><span style="color: #888;">Temperament:</span> <span style="color: #fff; font-weight: 600;">${player.personality.temperament}</span></div>
                  <div><span style="color: #888;">Clutch:</span> <span style="color: #fff; font-weight: 600;">${player.personality.clutch}</span></div>
                  <div><span style="color: #888;">Durability:</span> <span style="color: #fff; font-weight: 600;">${player.personality.durability}</span></div>
                  <div><span style="color: #888;">Coachability:</span> <span style="color: #fff; font-weight: 600;">${player.personality.coachability}</span></div>
                </div>
              </div>
            ` : ''}
          </div>
          
          <!-- Contract Card -->
          <div style="background: rgba(52,211,153,0.05); border: 1px solid rgba(52,211,153,0.2); border-radius: 8px; padding: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; color: #34d399; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;">Contract</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; font-size: 13px;">
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Annual Salary</div>
                <div style="color: #34d399; font-weight: 600;">${money(contractInfo.annualSalary)}</div>
              </div>
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Value</div>
                <div style="color: #34d399; font-weight: 600;">${money(contractInfo.totalValue)}</div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Years Remaining</div>
                <div style="color: #fff; font-weight: 500;">${contractInfo.yearsRemaining}</div>
              </div>
              <div>
                <div style="color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Contract Period</div>
                <div style="color: #fff; font-weight: 500;">${contractInfo.startYear} - ${contractInfo.endYear}</div>
              </div>
            </div>
          </div>
          
          </div> <!-- End content wrapper -->
        </div>
      `;
    }

    function viewHome() {
      if (!state.league) {
        return `
          <div class="grid">
            <div class="card" style="grid-column: span 12; min-height: 200px; display: flex; align-items: center; justify-content: center;">
              <div style="text-align: center;">
                <h1 style="margin: 0 0 10px 0;">üèÄ Hoops Sim</h1>
                <p style="color: var(--muted); margin: 0 0 20px 0; font-size: 16px;">Front office dreams, spreadsheet reality.</p>
                <button id="homeLoadSave" class="primary" style="padding: 12px 24px; margin: 0 10px;">Load Save</button>
                <button id="homeNewSave" class="primary" style="padding: 12px 24px; margin: 0 10px;">New Save</button>
              </div>
            </div>
          </div>
        `;
      }

      const { meta, teams, players, log } = state.league;
      const totalPayroll = players.reduce((s,p)=>s+p.salary,0);
      const bestTeam = [...teams].sort((a,b) => (b.wins-b.losses) - (a.wins-a.losses))[0];
      const topPlayer = [...players].sort((a,b) => b.ovr - a.ovr)[0];

      return `
        <div class="grid">
          <div class="card two">
            <div class="hd">
              <h2>Current Save</h2>
              <div class="hint">${escapeHtml(meta.name)}</div>
            </div>
            <div class="bd">
              <div class="kpis">
                <div class="kpi">
                  <div class="label">Season</div>
                  <div class="value">${meta.season}</div>
                  <div class="delta">Day ${meta.day}</div>
                </div>
                <div class="kpi">
                  <div class="label">Teams</div>
                  <div class="value">${teams.length}</div>
                  <div class="delta">Franchises</div>
                </div>
                <div class="kpi">
                  <div class="label">Players</div>
                  <div class="value">${players.length}</div>
                  <div class="delta">Roster spots</div>
                </div>
                <div class="kpi">
                  <div class="label">Payroll</div>
                  <div class="value">${money(totalPayroll)}</div>
                  <div class="delta">Total spend</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>At a Glance</h2>
              <div class="hint">Best team & top player</div>
            </div>
            <div class="bd">
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 6px;">Best Team</div>
                <div style="font-size: 14px;">
                  <b>${escapeHtml(bestTeam.name)}</b> <span class="tag">${bestTeam.abbrev}</span>
                  <span class="muted" style="display: block; margin-top: 4px;">${bestTeam.wins}‚Äì${bestTeam.losses} ¬∑ Power: ${teamPower(bestTeam.id).toFixed(1)}</span>
                </div>
              </div>
              <hr style="border: none; border-top: 1px solid var(--line); margin: 12px 0;">
              <div>
                <div style="font-weight: 600; margin-bottom: 6px;">Top Player</div>
                <div style="font-size: 14px;">
                  <b>${escapeHtml(playerName(topPlayer))}</b> <span class="tag">${topPlayer.pos}</span>
                  <div class="muted" style="margin-top: 4px; font-size: 13px;">
                    ${escapeHtml(teamById(topPlayer.teamId).name)} ¬∑ OVR ${topPlayer.ovr} / POT ${topPlayer.pot}
                    <br/>Salary: ${money(topPlayer.salary)} ¬∑ Mood: ${topPlayer.mood} ¬∑ Stam: ${topPlayer.stamina}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>Recent Log</h2>
              <div class="hint">Last 8 events</div>
            </div>
            <div class="bd">
              <div class="log">
                ${log.slice(0, 8).map(x => `<div class="item">üìù ${escapeHtml(x)}</div>`).join("") || `<div class="item">No events yet.</div>`}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function viewDashboard() {
      const { meta, teams, players, log } = state.league;

      const totalPayroll = players.reduce((s,p)=>s+p.salary,0);
      const bestTeam = [...teams].sort((a,b) => (b.wins-b.losses) - (a.wins-a.losses))[0];
      const topPlayer = [...players].sort((a,b) => b.ovr - a.ovr)[0];

      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>League Snapshot</h2>
              <div class="hint">The ‚Äústart simple‚Äù era.</div>
            </div>
            <div class="bd">
              <div class="kpis">
                <div class="kpi">
                  <div class="label">League</div>
                  <div class="value">${meta.name}</div>
                  <div class="delta">Phase: ${meta.phase}</div>
                </div>
                <div class="kpi">
                  <div class="label">Teams</div>
                  <div class="value">${teams.length}</div>
                  <div class="delta">Tiny league for a tiny prototype</div>
                </div>
                <div class="kpi">
                  <div class="label">Players</div>
                  <div class="value">${players.length}</div>
                  <div class="delta">Enough to test rosters</div>
                </div>
                <div class="kpi">
                  <div class="label">Total Payroll</div>
                  <div class="value">${money(totalPayroll)}</div>
                  <div class="delta">A very fake economy</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>Standings</h2>
              <div class="hint">Click a team on the Teams page for details.</div>
            </div>
            <div class="bd">
              ${standingsTable()}
              <div class="muted" style="margin-top:10px;">
                Best team right now: <b>${bestTeam.name}</b>
              </div>
            </div>
          </div>

          <div class="card two">
            <div class="hd">
              <h2>Top Player</h2>
              <div class="hint">Because we all worship at the altar of OVR.</div>
            </div>
            <div class="bd">
              <div style="font-size:18px; font-weight:800;">${playerName(topPlayer)} <span class="tag">${topPlayer.pos}</span></div>
              <div class="muted" style="margin-top:6px;">
                Team: <b>${teamById(topPlayer.teamId).name}</b><br/>
                OVR: <b>${topPlayer.ovr}</b> ¬∑ POT: <b>${topPlayer.pot}</b> ¬∑ Age: <b>${topPlayer.age}</b><br/>
                Salary: <b>${money(topPlayer.salary)}</b> ¬∑ Mood: <b>${topPlayer.mood}</b> ¬∑ Stamina: <b>${topPlayer.stamina}</b>
              </div>
              <div class="muted" style="margin-top:10px;">
                Stats (total): ${topPlayer.stats.gp} GP ¬∑ ${topPlayer.stats.pts} PTS ¬∑ ${topPlayer.stats.reb} REB ¬∑ ${topPlayer.stats.ast} AST
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>League Log</h2>
              <div class="hint">Most recent on top</div>
            </div>
            <div class="bd">
              <div class="log">
                ${log.map(x => `<div class="item">üìù ${escapeHtml(x)}</div>`).join("") || `<div class="item">No events yet.</div>`}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function standingsTable() {
      const teams = [...state.league.teams].sort((a,b) => b.wins - a.wins || a.losses - b.losses);
      return `
        <table>
          <thead>
            <tr><th>Team</th><th>W</th><th>L</th><th>Power</th></tr>
          </thead>
          <tbody>
            ${teams.map(t => {
              const logoSvg = t.color ? generateTeamLogo(t.abbrev, t.color, 24) : '';
              return `
              <tr>
                <td><span>${logoSvg}</span> <span class="click" data-team="${t.id}">${escapeHtml(t.name)}</span> <span class="tag">${t.abbrev}</span></td>
                <td>${t.wins}</td>
                <td>${t.losses}</td>
                <td>${teamPower(t.id).toFixed(1)}</td>
              </tr>
            `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    function viewLeague() {
      const { meta } = state.league;
      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>League Settings</h2>
              <div class="hint">Editable settings come later (after we don‚Äôt crash).</div>
            </div>
            <div class="bd">
              <div class="muted" style="line-height:1.7;">
                <b>Name:</b> ${escapeHtml(meta.name)}<br/>
                <b>Season:</b> ${meta.season}<br/>
                <b>Day:</b> ${meta.day}<br/>
                <b>Phase:</b> ${meta.phase}<br/><br/>
                Roadmap idea: Draft ‚Üí Contracts ‚Üí Trades ‚Üí Free Agency ‚Üí Playoffs.
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function viewTeams() {
      // Determine filter mode
      const filterMode = window._teamsViewFilter || "all"; // "all" or "myteam"
      const searchQuery = (document.getElementById("teamsSearchInput")?.value || "").toLowerCase();
      
      // Get teams to display
      let teams = [...state.league.teams];
      
      // Filter by mode
      if (filterMode === "myteam" && state.userTeamId) {
        teams = teams.filter(t => t.id === state.userTeamId);
      }
      
      // Filter by search
      if (searchQuery) {
        teams = teams.filter(t => 
          t.name.toLowerCase().includes(searchQuery) || 
          t.abbrev.toLowerCase().includes(searchQuery)
        );
      }
      
      // Sort by name
      teams.sort((a,b) => a.name.localeCompare(b.name));
      
      const selectedTeam = state.selectedTeamId ? teamById(state.selectedTeamId) : null;

      return `
        <div class="grid">
          <!-- LEFT PANEL: Team List -->
          <div class="card two">
            <div class="hd">
              <h2>Teams</h2>
              <div class="hint">Browse & select</div>
            </div>
            <div class="bd">
              <!-- Filter Buttons -->
              <div style="display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;">
                <button id="teamsFilterAll" class="secondary ${filterMode === "all" ? "primary" : ""}" style="flex: 1; min-width: 100px;">All Teams</button>
                ${state.userTeamId ? `
                  <button id="teamsFilterMyTeam" class="secondary ${filterMode === "myteam" ? "primary" : ""}" style="flex: 1; min-width: 100px;">My Team</button>
                ` : `
                  <div style="color: var(--muted); font-size: 12px; padding: 8px; flex: 1;">No managed team selected.</div>
                `}
              </div>
              
              <!-- Search Box -->
              <input type="text" id="teamsSearchInput" placeholder="Search teams‚Ä¶" style="width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid var(--line); background: rgba(15,23,42,.6); color: inherit; border-radius: 6px; font-size: 13px;">
              
              <!-- Teams List -->
              <div style="max-height: 500px; overflow-y: auto;">
                <table style="width: 100%;">
                  <tbody>
                    ${teams.length > 0 ? teams.map(t => {
                      const payroll = state.league.players.filter(p=>p.teamId===t.id).reduce((s,p)=>s+p.salary,0);
                      const logoSvg = t.color ? generateTeamLogo(t.abbrev, t.color, 20) : '';
                      const isSelected = state.selectedTeamId === t.id;
                      const isUserTeam = state.userTeamId === t.id;
                      const rowBg = isSelected ? "background-color: rgba(96,165,250,.15);" : isUserTeam ? "background-color: rgba(52,211,153,.08);" : "";
                      
                      return `
                        <tr onclick="setTeamSelection('${t.id}')" style="cursor: pointer; border-bottom: 1px solid var(--line); ${rowBg} transition: background-color 0.2s;">
                          <td style="padding: 10px 6px; text-align: left;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                              <span>${logoSvg}</span>
                              <div>
                                <div style="font-weight: 500; font-size: 13px;">${escapeHtml(t.name)}</div>
                                <div style="color: var(--muted); font-size: 11px;">${t.abbrev}</div>
                              </div>
                            </div>
                          </td>
                          <td style="padding: 10px 6px; text-align: right; font-size: 12px; white-space: nowrap;">
                            ${isUserTeam ? `<span style="color: #34d399; font-weight: bold; margin-right: 8px;">MY TEAM</span>` : ''}
                            <span>${t.wins}‚Äì${t.losses}</span>
                          </td>
                        </tr>
                      `;
                    }).join("") : `
                      <tr><td style="padding: 20px; text-align: center; color: var(--muted);">No teams found</td></tr>
                    `}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- RIGHT PANEL: Roster Viewer -->
          <div class="card two">
            ${selectedTeam ? `
              <!-- Roster Header -->
              <div class="hd">
                <div>
                  <h2>${selectedTeam.color ? generateTeamLogo(selectedTeam.abbrev, selectedTeam.color, 28) : ''} ${escapeHtml(selectedTeam.name)}</h2>
                  <div class="hint">${selectedTeam.abbrev} ¬∑ ${selectedTeam.wins}‚Äì${selectedTeam.losses} ¬∑ Power: ${teamPower(selectedTeam.id).toFixed(1)}</div>
                </div>
              </div>
              <div class="bd">
                <!-- Quick Actions -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                  ${state.userTeamId === state.selectedTeamId ? `
                    <button style="flex: 1; min-width: 120px; background: #22c55e; color: #000; border: none; padding: 8px; border-radius: 4px; cursor: default; font-weight: 600;">‚úì Your Team</button>
                  ` : `
                    <button id="manageTeamBtn" class="secondary" style="flex: 1; min-width: 120px;">Manage This Team</button>
                  `}
                  ${state.userTeamId && state.userTeamId !== state.selectedTeamId ? `
                    <button id="viewMyTeamBtn" class="secondary" style="flex: 1; min-width: 120px;">View My Team</button>
                  ` : ''}
                  <button class="secondary" disabled style="color: var(--muted); flex: 1; min-width: 120px;">Compare (Coming Soon)</button>
                </div>
                
                <!-- Roster Table -->
                ${viewRosterTable(selectedTeam.id)}
              </div>
            ` : `
              <div class="hd">
                <h2>Roster</h2>
                <div class="hint">Select a team to view</div>
              </div>
              <div class="bd">
                <span class="muted">Select a team from the list to view their roster.</span>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function viewRosterTable(teamId) {
      const roster = state.league.players.filter(p=>p.teamId===teamId).sort((a,b)=>b.ovr-a.ovr);
      const payroll = roster.reduce((s,p)=>s+p.salary,0);
      
      return `
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="border-bottom: 2px solid var(--line);">
              <th style="text-align: left; padding: 8px; font-weight: bold; color: #60a5fa;">Player</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Pos</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Age</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">OVR</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">POT</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Salary</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Mood</th>
              <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Stam</th>
            </tr>
          </thead>
          <tbody>
            ${roster.map((p, idx) => `
              <tr style="border-bottom: 1px solid var(--line); ${idx % 2 === 0 ? 'background-color: rgba(15,23,42,.6);' : ''}">
                <td style="padding: 10px 8px; text-align: left;">
                  <span class="click" data-player-id="${p.id}" style="cursor: pointer;">${escapeHtml(playerName(p))}</span>
                </td>
                <td style="padding: 10px 8px; text-align: center; font-size: 12px;">${p.pos}</td>
                <td style="padding: 10px 8px; text-align: center; font-size: 12px;">${p.age}</td>
                <td style="padding: 10px 8px; text-align: center; font-size: 12px; font-weight: bold; color: #60a5fa;">${p.ovr}</td>
                <td style="padding: 10px 8px; text-align: center; font-size: 12px;">${p.pot}</td>
                <td style="padding: 10px 8px; text-align: center; font-size: 12px;">${money(p.salary)}</td>
                <td style="padding: 10px 8px; text-align: center;">
                  <span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; background-color: ${p.mood >= 60 ? 'rgba(52,211,153,.2)' : 'rgba(248,113,113,.2)'}; color: ${p.mood >= 60 ? '#34d399' : '#f87171'};">${p.mood}</span>
                </td>
                <td style="padding: 10px 8px; text-align: center; font-size: 12px;">${p.stamina}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--line); font-size: 12px; color: var(--muted);">
          Payroll: ${money(payroll)} / Salary Cap: $120,000,000
        </div>
      `;
    }

    function teamDetailCard(teamId) {
      const t = teamById(teamId);
      if (!t) return "";
      const roster = state.league.players.filter(p=>p.teamId===teamId).sort((a,b)=>b.ovr-a.ovr);
      const payroll = roster.reduce((s,p)=>s+p.salary,0);
      const logoSvg = t.color ? generateTeamLogo(t.abbrev, t.color, 32) : '';

      return `
        <div class="card">
          <div class="hd">
            <h2>${logoSvg} ${escapeHtml(t.name)} Roster</h2>
            <div class="hint">Power: ${teamPower(teamId).toFixed(1)} ¬∑ Payroll: ${money(payroll)}</div>
          </div>
          <div class="bd">
            <table>
              <thead>
                <tr><th>Player</th><th>Pos</th><th>Age</th><th>OVR</th><th>POT</th><th>Salary</th><th>Mood</th><th>Stam</th></tr>
              </thead>
              <tbody>
                ${roster.map(p => `
                  <tr>
                    <td><span class="click" data-player-id="${p.id}" style="cursor: pointer;">${escapeHtml(playerName(p))}</span></td>
                    <td>${p.pos}</td>
                    <td>${p.age}</td>
                    <td>${p.ovr}</td>
                    <td>${p.pot}</td>
                    <td>${money(p.salary)}</td>
                    <td><span class="tag ${p.mood >= 60 ? "good" : "bad"}">${p.mood}</span></td>
                    <td>${p.stamina}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function viewRotations() {
      const managedTeamId = state.userTeamId;
      if (!managedTeamId) {
        return `
          <div class="grid">
            <div class="card">
              <div class="bd" style="text-align: center; padding: 40px; color: #888;">
                <div style="font-size: 24px; margin-bottom: 12px;">üß©</div>
                <div style="font-size: 14px;">Select a team to manage to edit rotations</div>
              </div>
            </div>
          </div>
        `;
      }

      const team = state.league.teams.find(t => t.id === managedTeamId);
      const roster = state.league.players.filter(p => p.teamId === managedTeamId).sort((a,b) => b.ovr - a.ovr);
      const rotations = state.league.rotations?.[managedTeamId] || initializeRotations(managedTeamId, state.league.players);
      
      const totalMin = getTotalMinutes(rotations);
      const minDiff = 240 - totalMin;
      const diagnostics = getRotationDiagnostics(managedTeamId);
      
      const positions = ["PG", "SG", "SF", "PF", "C"];

      return `
        <div class="grid">
          <!-- Header -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd">
              <h2>Rotations ‚Äì ${escapeHtml(team.name)}</h2>
              <div class="hint">Set starters, bench order, and target minutes</div>
            </div>
            <div class="bd" style="display: flex; gap: 20px; flex-wrap: wrap;">
              <div>
                <div style="font-size: 12px; color: #888; text-transform: uppercase;">Total Minutes</div>
                <div style="font-size: 20px; font-weight: 600; color: ${minDiff === 0 ? '#22c55e' : minDiff < 0 ? '#ef4444' : '#eab308'};">${totalMin}/240</div>
                ${minDiff !== 0 ? `<div style="font-size: 11px; color: #888; margin-top: 4px;">${minDiff > 0 ? '+' : ''}${minDiff} min</div>` : ''}
              </div>
              
              ${diagnostics.warnings.length > 0 ? `
                <div>
                  <div style="font-size: 12px; color: #888; text-transform: uppercase;">Warnings</div>
                  <div style="font-size: 12px; color: #eab308; margin-top: 4px;">
                    ${diagnostics.warnings.map(w => `<div>‚ö† ${w}</div>`).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${diagnostics.errors.length > 0 ? `
                <div>
                  <div style="font-size: 12px; color: #888; text-transform: uppercase;">Errors</div>
                  <div style="font-size: 12px; color: #ef4444; margin-top: 4px;">
                    ${diagnostics.errors.map(e => `<div>‚úï ${e}</div>`).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Buttons -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="bd" style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button id="rotAutoStartersBtn" class="btn">Auto-Set Starters (Best OVR)</button>
              <button id="rotAutoBenchBtn" class="btn">Auto-Set Bench</button>
              <button id="rotAutoFixMinBtn" class="btn">Auto-Fix Minutes to 240</button>
              <button id="rotResetBtn" class="btn">Reset to Default</button>
            </div>
          </div>

          <!-- Depth Chart -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd"><h3>Depth Chart</h3></div>
            <div class="bd" style="overflow-x: auto;">
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; min-width: 800px;">
                ${positions.map(pos => {
                  const starter = rotations.starters[pos];
                  const starterPlayer = starter ? roster.find(p => p.id === starter) : null;
                  const benchIds = rotations.benchOrder[pos] || [];
                  const benchPlayers = benchIds.map(id => roster.find(p => p.id === id)).filter(p => p);
                  
                  return `
                    <div style="border: 1px solid rgba(96,165,250,0.2); border-radius: 8px; padding: 12px; background: rgba(96,165,250,0.05);">
                      <div style="font-size: 14px; font-weight: 600; color: #60a5fa; margin-bottom: 12px;">${pos}</div>
                      
                      <!-- Starter slot -->
                      <div style="margin-bottom: 12px; padding: 8px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px;">
                        <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 4px;">Starter</div>
                        <select class="rotStarter" data-pos="${pos}" style="width: 100%; padding: 8px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px;">
                          <option value="">‚Äî Pick ‚Äî</option>
                          ${roster.filter(p => p.pos === pos).map(p => `
                            <option value="${p.id}" ${p.id === starter ? 'selected' : ''}>${p.firstName} ${p.lastName} (${p.ovr})</option>
                          `).join('')}
                        </select>
                      </div>
                      
                      <!-- Bench list -->
                      <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 6px;">Bench</div>
                      <div class="rotBench" data-pos="${pos}" style="background: rgba(0,0,0,0.3); border-radius: 4px; min-height: 100px; padding: 8px;">
                        ${benchPlayers.length === 0 ? `
                          <div style="font-size: 11px; color: #666; text-align: center; padding: 20px 0;">No bench players</div>
                        ` : `
                          <div>
                            ${benchPlayers.map((p, idx) => `
                              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; background: rgba(96,165,250,0.1); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                                <span>${p.firstName.charAt(0)}. ${p.lastName} (${p.ovr})</span>
                                <button class="rotBenchRemove" data-pos="${pos}" data-id="${p.id}" style="background: #7f1d1d; border: none; color: #fca5a5; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Remove</button>
                              </div>
                            `).join('')}
                          </div>
                        `}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <!-- Minutes Editor -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd"><h3>Target Minutes</h3></div>
            <div class="bd">
              <table style="width: 100%; font-size: 13px;">
                <thead>
                  <tr style="border-bottom: 1px solid rgba(96,165,250,0.2);">
                    <th style="text-align: left; padding: 8px;">Player</th>
                    <th style="text-align: center; padding: 8px;">Pos</th>
                    <th style="text-align: center; padding: 8px;">OVR</th>
                    <th style="text-align: center; padding: 8px;">Archetype</th>
                    <th style="text-align: center; padding: 8px;">Target Min</th>
                    <th style="text-align: center; padding: 8px;">Role</th>
                  </tr>
                </thead>
                <tbody>
                  ${roster.map(p => {
                    const min = rotations.minutes[p.id] || 0;
                    const isStarter = Object.values(rotations.starters || {}).includes(p.id);
                    const isBench = Object.values(rotations.benchOrder || {}).some(arr => arr.includes(p.id));
                    const role = isStarter ? 'Starter' : isBench ? 'Bench' : 'Reserve';
                    
                    return `
                      <tr style="border-bottom: 1px solid rgba(96,165,250,0.1);">
                        <td style="padding: 8px;">${p.firstName} ${p.lastName}</td>
                        <td style="text-align: center; padding: 8px;">${p.pos}</td>
                        <td style="text-align: center; padding: 8px; color: #60a5fa; font-weight: 600;">${p.ovr}</td>
                        <td style="text-align: center; padding: 8px; font-size: 11px; color: #d8b4fe;">${p.archetype || '‚Äî'}</td>
                        <td style="text-align: center; padding: 8px;">
                          <input type="number" class="rotMinutes" data-id="${p.id}" value="${min}" min="0" max="48" style="width: 50px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 3px; text-align: center;">
                        </td>
                        <td style="text-align: center; padding: 8px; font-size: 11px;">
                          <span style="background: ${isStarter ? 'rgba(34,197,94,0.2); color: #86efac' : isBench ? 'rgba(96,165,250,0.2); color: #93c5fd' : 'rgba(107,114,128,0.2); color: #d1d5db'}; padding: 2px 8px; border-radius: 3px;">${role}</span>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Coach Settings -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd"><h3>Coach Settings</h3></div>
            <div class="bd">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="rotCoachAdj" ${rotations.coachAdjustments ? 'checked' : ''} style="width: 16px; height: 16px; cursor: pointer;">
                <span>Coach Adjustments (auto-modify minutes for stamina/morale)</span>
              </label>
              <div style="font-size: 11px; color: #888; margin-top: 8px;">
                When enabled, coach will make subtle adjustments to player minutes based on stamina levels and morale.
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function viewSchedule() {
      const schedule = state.league.schedule;
      if (!schedule || !schedule.games) {
        return `
          <div class="grid">
            <div class="card">
              <div class="bd" style="text-align: center; padding: 40px; color: #888;">
                <div style="font-size: 24px; margin-bottom: 12px;">üìÖ</div>
                <div style="font-size: 14px;">No schedule available</div>
              </div>
            </div>
          </div>
        `;
      }

      const userTeamId = state.userTeamId;
      const currentDay = state.league.meta.day;
      const season = schedule.season;

      // Get all games for the user's team
      const teamGames = schedule.games.filter(g => g.homeTid === userTeamId || g.awayTid === userTeamId);
      const todayGames = schedule.games.filter(g => g.day === currentDay);

      // Tabs state
      const currentTab = state.scheduleTab || "today";

      return `
        <div class="grid">
          <!-- Header -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd">
              <h2>Schedule ‚Äì ${season} Season</h2>
              <div class="hint">Day ${currentDay} of ${schedule.maxDays}</div>
            </div>
            <div class="bd" style="display: flex; gap: 12px; border-bottom: 1px solid #333; padding-bottom: 12px;">
              <button id="schedTabToday" class="btn" style="background: ${currentTab === 'today' ? '#3b82f6' : '#333'}; border-bottom: ${currentTab === 'today' ? '2px solid #60a5fa' : 'none'};">üìÖ Today (${todayGames.length} games)</button>
              <button id="schedTabSeason" class="btn" style="background: ${currentTab === 'season' ? '#3b82f6' : '#333'}; border-bottom: ${currentTab === 'season' ? '2px solid #60a5fa' : 'none'};">üìä ${state.userTeamId ? 'My Team' : 'All Games'}</button>
            </div>
          </div>

          <!-- Today View -->
          ${currentTab === 'today' ? `
            <div class="card" style="grid-column: 1 / -1;">
              <div class="hd"><h3>Today's Games ‚Äì Day ${currentDay}</div>
              <div class="bd">
                ${todayGames.length === 0 ? `
                  <div style="text-align: center; color: #888; padding: 40px;">
                    <div style="font-size: 14px;">No games scheduled for today</div>
                  </div>
                ` : `
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 1px solid #444;">
                        <th style="text-align: left; padding: 8px; color: #60a5fa;">Away</th>
                        <th style="text-align: center; padding: 8px; color: #60a5fa;">Score</th>
                        <th style="text-align: left; padding: 8px; color: #60a5fa;">Home</th>
                        <th style="text-align: center; padding: 8px; color: #60a5fa;">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${todayGames.map(game => {
                        const awayTeam = teamById(game.awayTid);
                        const homeTeam = teamById(game.homeTid);
                        const awayLogo = awayTeam.color ? generateTeamLogo(awayTeam.abbrev, awayTeam.color, 16) : '';
                        const homeLogo = homeTeam.color ? generateTeamLogo(homeTeam.abbrev, homeTeam.color, 16) : '';
                        const isUserTeam = game.homeTid === userTeamId || game.awayTid === userTeamId;
                        
                        return `
                          <tr style="border-bottom: 1px solid #333; ${isUserTeam ? 'background: rgba(96,165,250,0.1);' : ''}">
                            <td style="padding: 12px; text-align: left;">
                              ${awayLogo} ${escapeHtml(awayTeam.abbrev)}
                            </td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">
                              ${game.played ? `${game.awayScore || 0}-${game.homeScore || 0}` : '‚Äì'}
                            </td>
                            <td style="padding: 12px; text-align: left;">
                              ${homeLogo} ${escapeHtml(homeTeam.abbrev)}
                            </td>
                            <td style="padding: 12px; text-align: center; display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; align-items: center;">
                              ${game.played ? `
                                <span class="tag" style="background: #22c55e; color: #000;">Final</span>
                                <button class="schedBoxScore" data-game-id="${game.id}" style="padding: 4px 8px; font-size: 11px; background: #444; border: 1px solid #666; border-radius: 3px; cursor: pointer; color: #fff;">Box Score</button>
                              ` : `
                                <button class="schedSimulate" data-game-id="${game.id}" style="padding: 4px 8px; font-size: 11px; background: #22c55e; border: none; border-radius: 3px; cursor: pointer; color: #000; font-weight: 600;">Sim</button>
                                <button class="schedWatch" data-game-id="${game.id}" style="padding: 4px 8px; font-size: 11px; background: #3b82f6; border: none; border-radius: 3px; cursor: pointer; color: #fff;">Watch</button>
                              `}
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                `}
              </div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
              <div class="bd">
                <button id="simTodayBtn" class="btn" style="background: #22c55e; padding: 12px 24px; font-size: 14px; font-weight: 600;">
                  ‚ñ∂ Simulate Today (${todayGames.length} games)
                </button>
              </div>
            </div>
          ` : ''}

          <!-- Season View -->
          ${currentTab === 'season' ? `
            <div class="card" style="grid-column: 1 / -1;">
              <div class="hd"><h3>${userTeamId ? escapeHtml(teamById(userTeamId).name) + ' ‚Äì ' : ''}Full Season (${schedule.games.length} total)</h3></div>
              <div class="bd" style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                  <thead style="position: sticky; top: 0; background: #1a1a1a; border-bottom: 1px solid #444;">
                    <tr>
                      <th style="text-align: left; padding: 8px; color: #60a5fa;">Day</th>
                      <th style="text-align: left; padding: 8px; color: #60a5fa;">Away</th>
                      <th style="text-align: center; padding: 8px; color: #60a5fa;">Score</th>
                      <th style="text-align: left; padding: 8px; color: #60a5fa;">Home</th>
                      <th style="text-align: center; padding: 8px; color: #60a5fa;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(userTeamId ? teamGames : schedule.games).map(game => {
                      const awayTeam = teamById(game.awayTid);
                      const homeTeam = teamById(game.homeTid);
                      const awayLogo = awayTeam.color ? generateTeamLogo(awayTeam.abbrev, awayTeam.color, 14) : '';
                      const homeLogo = homeTeam.color ? generateTeamLogo(homeTeam.abbrev, homeTeam.color, 14) : '';
                      const isUserTeam = userTeamId && (game.homeTid === userTeamId || game.awayTid === userTeamId);
                      const isUpcoming = game.day >= currentDay;
                      
                      return `
                        <tr style="border-bottom: 1px solid #2a2a2a; ${isUserTeam ? 'background: rgba(96,165,250,0.05);' : ''}">
                          <td style="padding: 8px; color: #888; font-size: 11px;">Day ${game.day}</td>
                          <td style="padding: 8px; text-align: left;">
                            ${awayLogo} ${escapeHtml(awayTeam.abbrev)}
                          </td>
                          <td style="padding: 8px; text-align: center; font-weight: 600; color: ${game.played ? '#fff' : '#888'};">
                            ${game.played ? `${game.awayScore || 0}-${game.homeScore || 0}` : '‚Äì'}
                          </td>
                          <td style="padding: 8px; text-align: left;">
                            ${homeLogo} ${escapeHtml(homeTeam.abbrev)}
                          </td>
                          <td style="padding: 8px; text-align: center; display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                            ${game.played ? '<span class="tag" style="background: #22c55e; color: #000; font-size: 10px;">‚úì</span>' : (isUpcoming ? `
                              <button class="schedSimulate" data-game-id="${game.id}" style="padding: 2px 6px; font-size: 9px; background: #22c55e; border: none; border-radius: 2px; cursor: pointer; color: #000; font-weight: 600;">Sim</button>
                              <button class="schedWatch" data-game-id="${game.id}" style="padding: 2px 6px; font-size: 9px; background: #3b82f6; border: none; border-radius: 2px; cursor: pointer; color: #fff;">Watch</button>
                            ` : '<span class="tag" style="background: #333; color: #888; font-size: 10px;">Past</span>')}
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    /**
     * Watch Game modal view - live play-by-play
     */
    function viewWatchGame() {
      const lg = state.ui.liveGame;
      if (!lg) return '';

      const homeTeam = teamById(lg.homeTid);
      const awayTeam = teamById(lg.awayTid);
      const homeLogo = homeTeam.color ? generateTeamLogo(homeTeam.abbrev, homeTeam.color, 32) : '';
      const awayLogo = awayTeam.color ? generateTeamLogo(awayTeam.abbrev, awayTeam.color, 32) : '';

      // Get top scorers
      const homeStatKeys = Object.keys(lg.homeStats);
      const awayStatKeys = Object.keys(lg.awayStats);

      const homeLeaders = homeStatKeys.length > 0
        ? homeStatKeys
            .map(pid => ({
              ...state.league.players.find(p => p.id === pid),
              stats: lg.homeStats[pid]
            }))
            .sort((a, b) => (b.stats?.pts || 0) - (a.stats?.pts || 0))
            .slice(0, 3)
        : [];

      const awayLeaders = awayStatKeys.length > 0
        ? awayStatKeys
            .map(pid => ({
              ...state.league.players.find(p => p.id === pid),
              stats: lg.awayStats[pid]
            }))
            .sort((a, b) => (b.stats?.pts || 0) - (a.stats?.pts || 0))
            .slice(0, 3)
        : [];

      return `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow: hidden;">
          <div style="background: #0f0f0f; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; box-shadow: none;">
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #333; flex: 0 0 auto;">
              <div style="flex: 1;">
                <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px;">
                  ${awayLogo} ${awayTeam.abbrev} @ ${homeTeam.abbrev} ${homeLogo}
                </div>
                <div style="font-size: 12px; color: #888;">
                  Season ${lg.season}, Day ${lg.day}
                </div>
              </div>
              <button id="watchExitBtn" style="background: #444; border: 1px solid #666; color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">‚úï Exit</button>
            </div>

            <!-- Scoreboard and Leaders -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; border-bottom: 1px solid #333; flex: 0 0 auto;">
              
              <!-- Away Side -->
              <div>
                <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                  <div id="watchScoreAway" style="text-align: center; font-size: 64px; font-weight: 700; color: #60a5fa; margin-bottom: 6px; line-height: 1;">${lg.awayScore}</div>
                  <div style="text-align: center; font-size: 15px; font-weight: 600;">${awayTeam.name}</div>
                </div>
                <div style="font-size: 11px; color: #888; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">Leaders</div>
                <div id="watchLeadersAway">
                  ${awayLeaders
                    .map(
                      p => `
                    <div style="font-size: 11px; padding: 4px 0; color: #ccc; border-bottom: 1px solid #333;">
                      ${p.firstName} ${p.lastName}: <span style="color: #60a5fa; font-weight: 600;">${p.stats.pts || 0} pts</span> ¬∑ ${p.stats.reb || 0} reb ¬∑ ${p.stats.ast || 0} ast
                    </div>
                  `
                    )
                    .join('')}
                </div>
              </div>

              <!-- Home Side -->
              <div>
                <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                  <div id="watchScoreHome" style="text-align: center; font-size: 64px; font-weight: 700; color: #22c55e; margin-bottom: 6px; line-height: 1;">${lg.homeScore}</div>
                  <div style="text-align: center; font-size: 15px; font-weight: 600;">${homeTeam.name}</div>
                </div>
                <div style="font-size: 11px; color: #888; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">Leaders</div>
                <div id="watchLeadersHome">
                  ${homeLeaders
                    .map(
                      p => `
                    <div style="font-size: 11px; padding: 4px 0; color: #ccc; border-bottom: 1px solid #333;">
                      ${p.firstName} ${p.lastName}: <span style="color: #22c55e; font-weight: 600;">${p.stats.pts || 0} pts</span> ¬∑ ${p.stats.reb || 0} reb ¬∑ ${p.stats.ast || 0} ast
                    </div>
                  `
                    )
                    .join('')}
                </div>
              </div>
            </div>

            <!-- Game Status -->
            <div id="watchClock" style="padding: 16px; background: rgba(0,0,0,0.3); text-align: center; font-size: 24px; font-weight: 600; color: #eab308; flex: 0 0 auto;">
              Q${lg.quarter} ¬∑ ${formatClockTime(lg.clock)}
            </div>

            <!-- Controls -->
            <div style="display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid #333; flex-wrap: wrap; align-items: center; flex: 0 0 auto;">
              ${!lg.isFinal
                ? `
                <button id="watchPlayPauseBtn" style="min-width: 100px; padding: 10px 16px; font-size: 13px; background: ${state.live.watch.isPlaying ? '#ef4444' : '#22c55e'}; border: none; border-radius: 4px; cursor: pointer; color: ${state.live.watch.isPlaying ? '#fff' : '#000'}; font-weight: 600;" data-action="watch-toggle">
                  ${state.live.watch.isPlaying ? '‚è∏ Pause' : '‚ñ∂ Play'}
                </button>
                <button id="watchSimToEndBtn" style="min-width: 100px; padding: 10px 16px; font-size: 13px; background: #3b82f6; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-weight: 600;" data-action="watch-sim-end">
                  ‚è≠ Sim to End
                </button>
                <div style="display: flex; gap: 6px; align-items: center; padding: 6px;">
                  <span style="color: #888; font-size: 11px; font-weight: 700; text-transform: uppercase;">Speed:</span>
                  ${[0.5, 1, 2, 4, 8].map(sp => `
                    <button data-action="watch-speed" data-speed="${sp}" style="padding: 6px 10px; font-size: 11px; border: 1px solid ${state.live.watch.speed === sp ? '#60a5fa' : '#444'}; background: ${state.live.watch.speed === sp ? 'rgba(96,165,250,0.2)' : '#1a1a1a'}; border-radius: 3px; cursor: pointer; color: ${state.live.watch.speed === sp ? '#60a5fa' : '#888'}; font-weight: ${state.live.watch.speed === sp ? '600' : '400'};">
                      ${sp}x
                    </button>
                  `).join('')}
                </div>
              `
                : ''
              }
            </div>

            <!-- Play-by-Play -->
            <div id="watchPBPFeed" style="padding: 16px; flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2);">
              ${lg.pbp.length === 0 ? `
                <div style="text-align: center; color: #888; font-size: 13px; padding: 40px 0;">
                  Game starting...
                </div>
              ` : `
                ${lg.pbp.map(ev => `
                  <div style="padding: 6px 0; border-bottom: 1px solid #333; font-size: 12px;">
                    <span style="color: #888; font-weight: 600;">Q${ev.q} ${ev.t}</span><br/>
                    <span style="color: #ccc;">${ev.text}</span>
                  </div>
                `).reverse().join('')}
              `}
            </div>
          </div>
        </div>
      `;
    }

    function viewPlayers() {
      const players = [...state.league.players].sort((a,b)=>b.ovr-a.ovr);
      return `
        <div class="grid">
          <div class="card">
            <div class="hd">
              <h2>Players</h2>
              <div class="hint">Click a player for detail</div>
            </div>
            <div class="bd">
              <table>
                <thead>
                  <tr><th>Player</th><th>Team</th><th>Pos</th><th>Age</th><th>OVR</th><th>POT</th><th>Salary</th><th>GP</th><th>PTS</th></tr>
                </thead>
                <tbody>
                  ${players.map(p => {
                    const t = teamById(p.teamId);
                    const logoSvg = t.color ? generateTeamLogo(t.abbrev, t.color, 20) : '';
                    return `
                      <tr>
                        <td><span class="click" data-player-id="${p.id}" style="cursor: pointer;">${escapeHtml(playerName(p))}</span></td>
                        <td><span>${logoSvg}</span> ${escapeHtml(t.name)} <span class="tag">${t.abbrev}</span></td>
                        <td>${p.pos}</td>
                        <td>${p.age}</td>
                        <td>${p.ovr}</td>
                        <td>${p.pot}</td>
                        <td>${money(p.salary)}</td>
                        <td>${p.stats.gp}</td>
                        <td>${p.stats.pts}</td>
                      </tr>
                    `;
                  }).join("")}
                </tbody>
              </table>
            </div>
          </div>

          ${state.selectedPlayerId ? playerDetailCard(state.selectedPlayerId) : `
            <div class="card">
              <div class="hd"><h2>Player Detail</h2><div class="hint">Select a player above</div></div>
              <div class="bd"><span class="muted">No player selected.</span></div>
            </div>
          `}
        </div>
      `;
    }

    function playerDetailCard(playerId) {
      const p = state.league.players.find(x => x.id === playerId);
      if (!p) return "";
      const t = teamById(p.teamId);
      const logoSvg = t.color ? generateTeamLogo(t.abbrev, t.color, 28) : '';
      return `
        <div class="card">
          <div class="hd">
            <h2>${escapeHtml(playerName(p))} <span class="tag">${p.pos}</span></h2>
            <div class="hint">${logoSvg} ${escapeHtml(t.name)} ¬∑ Salary ${money(p.salary)}</div>
          </div>
          <div class="bd">
            <div class="kpis">
              <div class="kpi"><div class="label">OVR</div><div class="value">${p.ovr}</div><div class="delta">Overall rating</div></div>
              <div class="kpi"><div class="label">POT</div><div class="value">${p.pot}</div><div class="delta">Potential</div></div>
              <div class="kpi"><div class="label">Mood</div><div class="value">${p.mood}</div><div class="delta">0‚Äì100</div></div>
              <div class="kpi"><div class="label">Stamina</div><div class="value">${p.stamina}</div><div class="delta">0‚Äì100</div></div>
            </div>

            <div style="margin-top:14px; line-height:1.7;" class="muted">
              Age: <b>${p.age}</b><br/>
              Games: <b>${p.stats.gp}</b><br/>
              Totals: <b>${p.stats.pts}</b> PTS ¬∑ <b>${p.stats.reb}</b> REB ¬∑ <b>${p.stats.ast}</b> AST<br/>
              (Later you‚Äôll want per-game stats + advanced stats.)
            </div>
          </div>
        </div>
      `;
    }

    function viewTeamDashboard() {
      if (!state.league || !state.userTeamId) {
        return `<div class="card"><div class="bd"><span class="muted">Team not loaded.</span></div></div>`;
      }

      const team = teamById(state.userTeamId);
      if (!team) {
        return `<div class="card"><div class="bd"><span class="muted">Team not found.</span></div></div>`;
      }

      const logoSvg = team.color ? generateTeamLogo(team.abbrev, team.color, 40) : '';
      const record = `${team.wins}‚Äì${team.losses}`;
      const powerRank = getTeamPowerRank(state.userTeamId);
      const offenseRating = getTeamOffenseRating(state.userTeamId);
      const defenseRating = getTeamDefenseRating(state.userTeamId);
      const overallRating = getTeamOverallRating(state.userTeamId);
      const salaryInfo = getTeamSalaryInfo(state.userTeamId);
      const topPlayers = getTopTeamPlayers(state.userTeamId, 3);

      return `
        <div class="grid">
          <!-- Team Header -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div>${logoSvg}</div>
                <div>
                  <h2>${escapeHtml(team.name)}</h2>
                  <div class="hint">${team.abbrev} ¬∑ ${team.conference} ¬∑ ${team.division}</div>
                </div>
                <div style="margin-left: auto; text-align: right;">
                  <div style="font-size: 24px; font-weight: bold; color: #60a5fa;">${record}</div>
                  <div class="hint">Record</div>
                </div>
                <div style="text-align: right; padding-left: 24px;">
                  <div style="font-size: 24px; font-weight: bold; color: #34d399;">${powerRank}</div>
                  <div class="hint">Power Ranking</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Team Ratings -->
          <div class="card">
            <div class="hd"><h3>Team Ratings</h3></div>
            <div class="bd">
              <div class="kpis">
                <div class="kpi"><div class="label">Offense</div><div class="value">${offenseRating}</div><div class="delta">Avg OVR</div></div>
                <div class="kpi"><div class="label">Defense</div><div class="value">${defenseRating}</div><div class="delta">Positional</div></div>
                <div class="kpi"><div class="label">Overall</div><div class="value">${overallRating}</div><div class="delta">Top 3 Avg</div></div>
              </div>
            </div>
          </div>

          <!-- Salary Cap -->
          <div class="card">
            <div class="hd"><h3>Salary Cap</h3></div>
            <div class="bd">
              <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                  <span>${money(salaryInfo.totalSalary)}</span>
                  <span class="hint">${money(salaryInfo.capLimit)} Cap</span>
                </div>
                <div style="width: 100%; height: 8px; background: #111827; border-radius: 4px; overflow: hidden;">
                  <div style="width: ${Math.min(100, (salaryInfo.totalSalary / salaryInfo.capLimit) * 100)}%; height: 100%; background: ${salaryInfo.isOverCap ? '#ef4444' : '#34d399'};"></div>
                </div>
              </div>
              <div style="text-align: center; font-size: 12px; color: ${salaryInfo.isOverCap ? '#ef4444' : '#34d399'};">
                ${salaryInfo.isOverCap ? `Over cap by ${money(-salaryInfo.capRoom)}` : `${money(salaryInfo.capRoom)} room`}
              </div>
            </div>
          </div>

          <!-- Top Players -->
          <div class="card">
            <div class="hd"><h3>Top Players</h3></div>
            <div class="bd">
              ${topPlayers.length === 0 ? `<span class="muted">No players on roster.</span>` : `
                <table style="width: 100%;">
                  <tbody>
                    ${topPlayers.map((p, idx) => `
                      <tr style="border-bottom: 1px solid #1f2937; padding: 8px 0;">
                        <td style="padding: 8px 0;"><strong data-player-id="${p.id}" style="cursor: pointer;">${idx + 1}. ${escapeHtml(playerName(p))}</strong></td>
                        <td style="text-align: right; padding: 8px 0;"><span class="hint">${p.pos}</span></td>
                        <td style="text-align: right; padding: 8px 0; padding-left: 16px;"><strong>${p.ovr}</strong> OVR</td>
                        <td style="text-align: right; padding: 8px 0; padding-left: 16px;"><span class="hint">${p.stats.pts} PTS</span></td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              `}
            </div>
          </div>

          <!-- Next Game / Actions -->
          <div class="card">
            <div class="hd"><h3>Actions</h3></div>
            <div class="bd">
              <button id="simDayBtn" class="btn" style="width: 100%; padding: 12px; font-size: 14px;">
                ‚ñ∂ Simulate Next Day
              </button>
            </div>
          </div>

          <!-- Alerts -->
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd"><h3>Alerts</h3></div>
            <div class="bd">
              ${salaryInfo.isOverCap ? `
                <div style="padding: 8px; background: #7f1d1d; border-left: 3px solid #ef4444; margin-bottom: 8px; border-radius: 2px;">
                  <strong style="color: #fca5a5;">Over Salary Cap</strong><br/>
                  <span class="hint">You are ${money(-salaryInfo.capRoom)} over the cap. Consider trades or releasing players.</span>
                </div>
              ` : ''}
              ${salaryInfo.capRoom < 5_000_000 ? `
                <div style="padding: 8px; background: #78350f; border-left: 3px solid #f59e0b; margin-bottom: 8px; border-radius: 2px;">
                  <strong style="color: #fcd34d;">Low Salary Cap Room</strong><br/>
                  <span class="hint">Only ${money(salaryInfo.capRoom)} cap room remaining.</span>
                </div>
              ` : ''}
              ${salaryInfo.isOverCap || salaryInfo.capRoom < 5_000_000 ? '' : `
                <div style="padding: 8px; color: #34d399; text-align: center; font-size: 12px;">
                  ‚úì No salary alerts
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // Standings helper functions
    function getWinPercentage(wins, losses) {
      const total = wins + losses;
      if (total === 0) return ".000";
      const pct = wins / total;
      return "." + Math.floor(pct * 1000).toString().padStart(3, "0");
    }

    function getGamesBack(teamWins, teamLosses, leaderWins, leaderLosses) {
      const gb = ((leaderWins - teamWins) + (teamLosses - leaderLosses)) / 2;
      return gb === 0 ? "‚Äî" : gb.toFixed(1);
    }

    function getLast10Record(last10Array) {
      if (!last10Array || last10Array.length === 0) return "‚Äî";
      const wins = last10Array.filter(g => g === "W").length;
      const losses = last10Array.length - wins;
      return `${wins}-${losses}`;
    }

    function getStreakDisplay(streakType, streakLen) {
      if (streakType === "‚Äî" || streakLen === 0) return "‚Äî";
      return `${streakType}${streakLen}`;
    }

    function viewStandings() {
      // Get conference filter
      const confFilter = window._standingsFilter || "all"; // "all", "east", or "west"
      
      // Filter teams by conference
      let teams = [...state.league.teams];
      if (confFilter === "east") {
        teams = teams.filter(t => t.conference === "Eastern");
      } else if (confFilter === "west") {
        teams = teams.filter(t => t.conference === "Western");
      }
      
      // Sort by wins then losses
      teams.sort((a, b) => {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return a.losses - b.losses;
      });

      if (!teams || teams.length === 0) {
        return `<div class="card"><div class="bd"><span class="muted">No teams in league.</span></div></div>`;
      }

      const leaderWins = teams[0].wins;
      const leaderLosses = teams[0].losses;

      return `
        <div class="grid">
          <div class="card" style="grid-column: 1 / -1;">
            <div class="hd">
              <h2>Standings</h2>
              <div class="hint">W-L records, conference standings, and streaks</div>
            </div>
            <div class="bd">
              <!-- Conference Filter Buttons -->
              <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button id="standingsFilterAll" class="btn ${confFilter === 'all' ? 'active' : ''}" style="flex: 1; padding: 8px; font-size: 13px; border: 1px solid #60a5fa; background: ${confFilter === 'all' ? '#60a5fa' : 'transparent'}; color: ${confFilter === 'all' ? '#000' : '#60a5fa'}; cursor: pointer; border-radius: 4px; transition: all 0.2s;">All Conferences</button>
                <button id="standingsFilterEast" class="btn ${confFilter === 'east' ? 'active' : ''}" style="flex: 1; padding: 8px; font-size: 13px; border: 1px solid #34d399; background: ${confFilter === 'east' ? '#34d399' : 'transparent'}; color: ${confFilter === 'east' ? '#000' : '#34d399'}; cursor: pointer; border-radius: 4px; transition: all 0.2s;">Eastern</button>
                <button id="standingsFilterWest" class="btn ${confFilter === 'west' ? 'active' : ''}" style="flex: 1; padding: 8px; font-size: 13px; border: 1px solid #f87171; background: ${confFilter === 'west' ? '#f87171' : 'transparent'}; color: ${confFilter === 'west' ? '#000' : '#f87171'}; cursor: pointer; border-radius: 4px; transition: all 0.2s;">Western</button>
              </div>
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                  <tr style="border-bottom: 2px solid #60a5fa;">
                    <th style="text-align: left; padding: 8px; font-weight: bold; color: #60a5fa;">Team</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Record</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Win%</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">GB</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Conf</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Home</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Road</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">L10</th>
                    <th style="text-align: center; padding: 8px; font-weight: bold; color: #60a5fa;">Streak</th>
                  </tr>
                </thead>
                <tbody>
                  ${teams.map((team, idx) => {
                    const record = `${team.wins}‚Äì${team.losses}`;
                    const winPct = getWinPercentage(team.wins, team.losses);
                    const gb = getGamesBack(team.wins, team.losses, leaderWins, leaderLosses);
                    const confRecord = `${team.confWins}‚Äì${team.confLosses}`;
                    const homeRecord = `${team.homeWins}‚Äì${team.homeLosses}`;
                    const roadRecord = `${team.roadWins}‚Äì${team.roadLosses}`;
                    const last10 = getLast10Record(team.last10);
                    const streak = getStreakDisplay(team.streakType, team.streakLen);
                    
                    return `
                      <tr style="border-bottom: 1px solid #1a1f2e; ${idx % 2 === 0 ? 'background-color: #0d1117;' : ''}">
                        <td style="text-align: left; padding: 10px 8px;">
                          <a href="#teams" onclick="selectTeamForStandings('${team.id}')" style="color: #60a5fa; text-decoration: none; cursor: pointer; font-weight: 500;">
                            ${team.color ? generateTeamLogo(team.abbrev, team.color, 16) : ''} ${escapeHtml(team.name)}
                          </a>
                        </td>
                        <td style="text-align: center; padding: 10px 8px;">${record}</td>
                        <td style="text-align: center; padding: 10px 8px;">${winPct}</td>
                        <td style="text-align: center; padding: 10px 8px;">${gb}</td>
                        <td style="text-align: center; padding: 10px 8px;">${confRecord}</td>
                        <td style="text-align: center; padding: 10px 8px;">${homeRecord}</td>
                        <td style="text-align: center; padding: 10px 8px;">${roadRecord}</td>
                        <td style="text-align: center; padding: 10px 8px;">${last10}</td>
                        <td style="text-align: center; padding: 10px 8px; color: ${team.streakType === "W" ? "#34d399" : team.streakType === "L" ? "#f87171" : "#888"};">${streak}</td>
                      </tr>
                    `;
                  }).join("")}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    /**********************
     * 8) Rendering + Router
     **********************/
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[s]));
    }

    function setRoute(route) {
      state.route = route;
      document.querySelectorAll("#nav a").forEach(a => {
        a.classList.toggle("active", a.dataset.route === route);
      });
      render();
    }

    function render() {
      // Home screen can render without a league
      if (state.route !== "home" && !state.league) return;
      
      const view = document.getElementById("view");
      
      if (state.route === "home") {
        view.innerHTML = viewHome();
      } else {
        const { meta } = state.league;
        document.getElementById("dayLabel").textContent = meta.day;
        document.getElementById("seasonLabel").textContent = `Season ${meta.season}`;
        document.getElementById("subTitle").textContent = `${meta.name.toLowerCase()} ¬∑ v0.1`;
        
        if (state.route === "dashboard") {
          // Show Team Dashboard if a managed team is set, otherwise show league dashboard
          if (state.userTeamId) view.innerHTML = viewTeamDashboard();
          else view.innerHTML = viewDashboard();
        }
        else if (state.route === "league") view.innerHTML = viewLeague();
        else if (state.route === "standings") view.innerHTML = viewStandings();
        else if (state.route === "teams") view.innerHTML = viewTeams();
        else if (state.route === "rotations") view.innerHTML = viewRotations();
        else if (state.route === "schedule") view.innerHTML = viewSchedule();
        else if (state.route === "players") view.innerHTML = viewPlayers();
        else view.innerHTML = `<div class="card"><div class="bd">Unknown route.</div></div>`;
      }

      // Add event listeners for home screen
      if (state.route === "home") {
        const loadSaveBtn = document.getElementById("homeLoadSave");
        const newSaveBtn = document.getElementById("homeNewSave");

        if (loadSaveBtn) loadSaveBtn.addEventListener("click", homeLoadSave);
        if (newSaveBtn) newSaveBtn.addEventListener("click", homeNewSave);
      }

      // wire click handlers inside rendered content
      view.querySelectorAll("[data-team]").forEach(el => {
        el.addEventListener("click", () => {
          state.selectedTeamId = el.dataset.team;
          state.route = "teams";
          setRoute("teams");
        });
      });
      view.querySelectorAll("[data-player]").forEach(el => {
        el.addEventListener("click", () => {
          state.selectedPlayerId = el.dataset.player;
          state.route = "players";
          setRoute("players");
        });
      });

      // Team Dashboard - Sim Day button
      const simDayBtn = document.getElementById("simDayBtn");
      if (simDayBtn) {
        simDayBtn.addEventListener("click", async () => {
          simDay();
          await saveCurrentLeague();
          render();
          showBanner("success", "‚úì Day simulated");
        });
      }

      // Teams View - Filter buttons
      const teamsFilterAll = document.getElementById("teamsFilterAll");
      const teamsFilterMyTeam = document.getElementById("teamsFilterMyTeam");
      if (teamsFilterAll) {
        teamsFilterAll.addEventListener("click", () => {
          window._teamsViewFilter = "all";
          render();
        });
      }
      if (teamsFilterMyTeam) {
        teamsFilterMyTeam.addEventListener("click", () => {
          window._teamsViewFilter = "myteam";
          render();
        });
      }

      // Teams View - Search input
      const teamsSearchInput = document.getElementById("teamsSearchInput");
      if (teamsSearchInput) {
        teamsSearchInput.addEventListener("keyup", () => render());
      }

      // Standings View - Conference filter buttons
      const standingsFilterAll = document.getElementById("standingsFilterAll");
      const standingsFilterEast = document.getElementById("standingsFilterEast");
      const standingsFilterWest = document.getElementById("standingsFilterWest");
      if (standingsFilterAll) {
        standingsFilterAll.addEventListener("click", () => {
          window._standingsFilter = "all";
          render();
        });
      }
      if (standingsFilterEast) {
        standingsFilterEast.addEventListener("click", () => {
          window._standingsFilter = "east";
          render();
        });
      }
      if (standingsFilterWest) {
        standingsFilterWest.addEventListener("click", () => {
          window._standingsFilter = "west";
          render();
        });
      }

      // Teams View - View My Team button
      const viewMyTeamBtn = document.getElementById("viewMyTeamBtn");
      if (viewMyTeamBtn) {
        viewMyTeamBtn.addEventListener("click", () => {
          if (state.userTeamId) {
            state.selectedTeamId = state.userTeamId;
            render();
          }
        });
      }

      // Teams View - Manage This Team button
      const manageTeamBtn = document.getElementById("manageTeamBtn");
      if (manageTeamBtn) {
        manageTeamBtn.addEventListener("click", () => {
          if (state.selectedTeamId) {
            state.userTeamId = state.selectedTeamId;
            saveCurrentLeague();
            render();
            showBanner("success", "‚úì Managing this team");
          }
        });
      }

      // Player Detail Modal
      if (state.ui.playerModalOpen && state.ui.playerModalId) {
        const modalRoot = document.createElement("div");
        modalRoot.id = "playerModalRoot";
        modalRoot.innerHTML = viewPlayerModal(state.ui.playerModalId);
        document.body.appendChild(modalRoot);

        // Close button
        const closeBtn = document.getElementById("playerModalClose");
        if (closeBtn) {
          closeBtn.addEventListener("click", closePlayerModal);
        }

        // Backdrop click
        const backdrop = document.getElementById("playerModalBackdrop");
        if (backdrop) {
          backdrop.addEventListener("click", closePlayerModal);
        }
      } else {
        // Remove modal if it's open
        const modalRoot = document.getElementById("playerModalRoot");
        if (modalRoot) modalRoot.remove();
      }

      // Player click handlers (any element with data-player-id)
      view.querySelectorAll("[data-player-id]").forEach(el => {
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          openPlayerModal(el.dataset.playerId);
        });
      });

      // Escape key closes modal
      const handleEscape = (e) => {
        if (e.key === "Escape" && state.ui.playerModalOpen) {
          closePlayerModal();
        }
      };
      document.addEventListener("keydown", handleEscape);

      // ROTATIONS PAGE HANDLERS
      if (state.route === "rotations" && state.userTeamId) {
        const teamId = state.userTeamId;
        
        // Auto-Set Starters button
        const autoStartersBtn = document.getElementById("rotAutoStartersBtn");
        if (autoStartersBtn) {
          autoStartersBtn.addEventListener("click", () => {
            const rotations = state.league.rotations[teamId];
            if (!rotations) return;
            
            const roster = state.league.players.filter(p => p.teamId === teamId).sort((a,b) => b.ovr - a.ovr);
            const positions = ["PG", "SG", "SF", "PF", "C"];
            
            positions.forEach(pos => {
              const posPlayers = roster.filter(p => p.pos === pos);
              if (posPlayers.length > 0) {
                rotations.starters[pos] = posPlayers[0].id;
                // If already assigned minutes, keep them; otherwise set to 32
                if (!rotations.minutes[posPlayers[0].id]) {
                  rotations.minutes[posPlayers[0].id] = 32;
                }
              }
            });
            
            saveCurrentLeague();
            render();
            showBanner("success", "‚úì Starters auto-set");
          });
        }
        
        // Auto-Set Bench button
        const autoBenchBtn = document.getElementById("rotAutoBenchBtn");
        if (autoBenchBtn) {
          autoBenchBtn.addEventListener("click", () => {
            const rotations = state.league.rotations[teamId];
            if (!rotations) return;
            
            const positions = ["PG", "SG", "SF", "PF", "C"];
            const roster = state.league.players.filter(p => p.teamId === teamId);
            
            positions.forEach(pos => {
              const posPlayers = roster.filter(p => p.pos === pos).sort((a,b) => b.ovr - a.ovr);
              rotations.benchOrder[pos] = [];
              posPlayers.forEach((p, idx) => {
                if (p.id !== rotations.starters[pos]) {
                  rotations.benchOrder[pos].push(p.id);
                }
              });
            });
            
            saveCurrentLeague();
            render();
            showBanner("success", "‚úì Bench auto-ordered");
          });
        }
        
        // Auto-Fix Minutes button
        const autoFixMinBtn = document.getElementById("rotAutoFixMinBtn");
        if (autoFixMinBtn) {
          autoFixMinBtn.addEventListener("click", () => {
            autoFixMinutes(teamId);
            saveCurrentLeague();
            render();
            showBanner("success", "‚úì Minutes scaled to 240");
          });
        }
        
        // Reset to Default button
        const resetBtn = document.getElementById("rotResetBtn");
        if (resetBtn) {
          resetBtn.addEventListener("click", () => {
            if (!confirm("Reset rotations to default?")) return;
            const roster = state.league.players.filter(p => p.teamId === teamId);
            state.league.rotations[teamId] = initializeRotations(teamId, roster);
            saveCurrentLeague();
            render();
            showBanner("success", "‚úì Rotations reset");
          });
        }
        
        // Starter select dropdowns
        document.querySelectorAll(".rotStarter").forEach(sel => {
          sel.addEventListener("change", () => {
            const pos = sel.dataset.pos;
            const rotations = state.league.rotations[teamId];
            const selectedId = sel.value;
            
            if (selectedId) {
              // Check for duplicates
              Object.keys(rotations.starters).forEach(p => {
                if (p !== pos && rotations.starters[p] === selectedId) {
                  rotations.starters[p] = ""; // Clear the other position
                }
              });
              rotations.starters[pos] = selectedId;
            } else {
              rotations.starters[pos] = "";
            }
            
            saveCurrentLeague();
            render();
          });
        });
        
        // Minutes input fields
        document.querySelectorAll(".rotMinutes").forEach(input => {
          input.addEventListener("change", () => {
            const playerId = input.dataset.id;
            const minutes = parseInt(input.value) || 0;
            const rotations = state.league.rotations[teamId];
            rotations.minutes[playerId] = Math.max(0, Math.min(48, minutes)); // Clamp 0-48
            
            saveCurrentLeague();
            render();
          });
        });
        
        // Bench Remove buttons
        document.querySelectorAll(".rotBenchRemove").forEach(btn => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const pos = btn.dataset.pos;
            const playerId = btn.dataset.id;
            const rotations = state.league.rotations[teamId];
            rotations.benchOrder[pos] = rotations.benchOrder[pos].filter(id => id !== playerId);
            saveCurrentLeague();
            render();
          });
        });
        
        // Coach Adjustments checkbox
        const coachAdjCheckbox = document.getElementById("rotCoachAdj");
        if (coachAdjCheckbox) {
          coachAdjCheckbox.addEventListener("change", () => {
            state.league.rotations[teamId].coachAdjustments = coachAdjCheckbox.checked;
            saveCurrentLeague();
            showBanner("success", coachAdjCheckbox.checked ? "‚úì Coach adjustments ON" : "‚úì Coach adjustments OFF");
          });
        }
      }

      // SCHEDULE PAGE HANDLERS
      if (state.route === "schedule") {
        // Schedule tab buttons
        const schedTabToday = document.getElementById("schedTabToday");
        const schedTabSeason = document.getElementById("schedTabSeason");
        
        if (schedTabToday) {
          schedTabToday.addEventListener("click", () => {
            state.scheduleTab = "today";
            render();
          });
        }
        
        if (schedTabSeason) {
          schedTabSeason.addEventListener("click", () => {
            state.scheduleTab = "season";
            render();
          });
        }
        
        // Simulate Today button
        const simTodayBtn = document.getElementById("simTodayBtn");
        if (simTodayBtn) {
          simTodayBtn.addEventListener("click", async () => {
            simDay();
            await saveCurrentLeague();
            render();
            showBanner("success", `‚úì Simulated day ${state.league.meta.day}`);
          });
        }

        // Individual game simulate buttons
        document.querySelectorAll(".schedSimulate").forEach(btn => {
          btn.addEventListener("click", async () => {
            const gameId = btn.dataset.gameId;
            simulateScheduledGame(gameId);
            await saveCurrentLeague();
            render();
          });
        });

        // Individual game watch buttons
        document.querySelectorAll(".schedWatch").forEach(btn => {
          btn.addEventListener("click", () => {
            const gameId = btn.dataset.gameId;
            const lg = initLiveGame(gameId);
            if (lg) {
              state.ui.liveGameOpen = true;
              state.ui.liveGame = lg;
              
              // Initialize watch controller
              state.live.watch.gameId = gameId;
              state.live.watch.isOpen = true;
              state.live.watch.isPlaying = false;
              state.live.watch.speed = 1;
              state.live.watch.possessionsPerTick = 1;
              state.live.watch.timerId = null;
              
              render();
            }
          });
        });
      }

      // WATCH GAME MODAL HANDLERS (create modal once, update incrementally)
      if (state.ui.liveGameOpen && state.ui.liveGame) {
        state.live.watch.isOpen = true;
        state.live.watch.gameId = state.ui.liveGame.gameId;

        // Create modal container if not exists
        let modalRoot = document.getElementById("watchGameModalRoot");
        if (!modalRoot) {
          modalRoot = document.createElement("div");
          modalRoot.id = "watchGameModalRoot";
          document.body.appendChild(modalRoot);
        }
        
        // Render modal HTML (only once or when game changes)
        modalRoot.innerHTML = viewWatchGame();
        updateWatchGameUI();

        // EXIT BUTTON
        const exitBtn = document.getElementById("watchExitBtn");
        if (exitBtn) {
          exitBtn.addEventListener("click", async () => {
            stopWatchLoop();
            
            // Save game result to schedule
            const lg = state.ui.liveGame;
            const schedule = state.league.schedule;
            const game = schedule.games.find(g => g.id === lg.gameId);
            
            if (game) {
              game.played = true;
              game.homeScore = lg.homeScore;
              game.awayScore = lg.awayScore;
              
              // Store PBP (capped)
              if (lg.pbp.length > 250) {
                game.pbp = lg.pbp.slice(-250);
              } else {
                game.pbp = lg.pbp;
              }

              // Update team records
              const homeTeam = teamById(game.homeTid);
              const awayTeam = teamById(game.awayTid);
              
              if (lg.homeScore > lg.awayScore) {
                homeTeam.wins += 1;
                awayTeam.losses += 1;
                homeTeam.homeWins += 1;
                awayTeam.roadLosses += 1;
              } else {
                awayTeam.wins += 1;
                homeTeam.losses += 1;
                awayTeam.roadWins += 1;
                homeTeam.homeLosses += 1;
              }
              
              // Conference wins/losses
              if (homeTeam.conf === awayTeam.conf) {
                if (lg.homeScore > lg.awayScore) {
                  homeTeam.confWins += 1;
                  awayTeam.confLosses += 1;
                } else {
                  awayTeam.confWins += 1;
                  homeTeam.confLosses += 1;
                }
              }
              
              // Update last10 and streak
              for (const team of [homeTeam, awayTeam]) {
                const result = (lg.homeScore > lg.awayScore && team.id === homeTeam.id) || (lg.awayScore > lg.homeScore && team.id === awayTeam.id) ? 'W' : 'L';
                team.last10.push(result);
                if (team.last10.length > 10) team.last10.shift();
                
                if (team.last10.length > 0) {
                  const lastGame = team.last10[team.last10.length - 1];
                  if (lastGame === team.streakType || team.streakType === "‚Äî") {
                    team.streakType = lastGame;
                    team.streakLen += 1;
                  } else {
                    team.streakType = lastGame;
                    team.streakLen = 1;
                  }
                }
              }
            }

            state.ui.liveGameOpen = false;
            state.ui.liveGame = null;
            state.live.watch.isOpen = false;
            await saveCurrentLeague();
            render();
            showBanner("success", "‚úì Game saved");
          });
        }
      } else {
        // Clean up: stop timer and remove modal
        if (state.live.watch.isOpen) {
          stopWatchLoop();
          state.live.watch.isOpen = false;
        }
        const modalRoot = document.getElementById("watchGameModalRoot");
        if (modalRoot) modalRoot.remove();
      }
      
      // EVENT DELEGATION: Use bubbling for all watch controls
      // Attach once at document level in a separate handler setup
      if (!window._watchHandlersSetup) {
        window._watchHandlersSetup = true;
        
        document.addEventListener("click", (e) => {
          // Play/Pause toggle
          if (e.target.closest('[data-action="watch-toggle"]')) {
            if (state.live.watch.isPlaying) {
              stopWatchLoop();
            } else {
              startWatchLoop();
            }
            const modal = document.getElementById("watchGameModalRoot");
            if (modal) {
              updateWatchControls();
            }
          }
          
          // Speed control
          if (e.target.closest('[data-action="watch-speed"]')) {
            const btn = e.target.closest('[data-action="watch-speed"]');
            const newSpeed = parseFloat(btn.dataset.speed);
            state.live.watch.speed = newSpeed;
            state.live.watch.possessionsPerTick = Math.max(1, Math.round(newSpeed));
            
            // Restart loop with new speed if playing
            if (state.live.watch.isPlaying) {
              stopWatchLoop();
              startWatchLoop();
            }
            
            // Re-render modal to update speed buttons
            const modal = document.getElementById("watchGameModalRoot");
            if (modal) {
              modal.innerHTML = viewWatchGame();
              updateWatchGameUI();
            }
          }
          
          // Sim to End button
          if (e.target.closest('[data-action="watch-sim-end"]')) {
            const lg = state.ui.liveGame;
            if (lg) {
              stopWatchLoop();
              while (!lg.isFinal) {
                playNextPossession(lg);
              }
              updateWatchGameUI();
            }
          }
        });
      }
    }

    // Home screen event handlers
    async function homeResetLeague() {
      if (!state.currentSaveId) {
        showBanner("error", "‚ùå No save open");
        return;
      }
      if (!confirm("Reset this save's league?")) return;
      state.league = defaultLeague();
      state.league.meta.name = (await listSaves()).find(s => s.id === state.currentSaveId)?.name || "League";
      state.selectedTeamId = null;
      state.selectedPlayerId = null;
      await saveCurrentLeague();
      render();
      showBanner("success", "‚úì League reset");
    }

    async function homeLoadSave() {
      const saves = await listSaves();
      if (!saves.length) {
        showBanner("error", "‚ùå No saves found");
        return;
      }
      // For now, just navigate to sidebar - user can click in saves list
      // Alternatively, we can show a modal, but keeping it simple
      setRoute("dashboard");
    }

    function homeExport() {
      if (!state.league) {
        showBanner("error", "‚ùå No league to export");
        return;
      }
      exportCurrentLeague();
    }

    async function homeImport() {
      const newId = await importLeagueFromFile();
      if (newId) {
        const league = await loadSave(newId);
        if (league) {
          state.league = league;
          state.currentSaveId = newId;
          state.userTeamId = league.meta?.managedTeamId || null;
          setSaveStatus("Loaded");
          render();
          await refillSavesList();
        }
      }
    }

    async function homeNewSave() {
      const name = await promptFor("Save name:", "New League");
      if (!name) return;
      const id = await createSave(name);
      if (id) {
        state.league = defaultLeague();
        state.league.meta.name = name;
        state.currentSaveId = id;
        // Set managed team to first team
        if (state.league.teams && state.league.teams.length > 0) {
          state.userTeamId = state.league.teams[0].id;
        }
        setSaveStatus("Loaded");
        render();
        await refillSavesList();
      }
    }

    async function refillSavesList() {
      const savesList = document.getElementById("savesList");
      if (!savesList) return;
      const saves = await listSaves();
      if (!saves) return;
      saves.sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));

      savesList.innerHTML = saves.map(s => {
        const active = s.id === state.currentSaveId ? "active" : "";
        const date = s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : "?";
        return `
          <div class="save-item ${active}" data-save-id="${s.id}">
            <div class="save-item-name">${escapeHtml(s.name)}</div>
            <div class="save-item-info">${date}</div>
            <div class="save-item-actions">
              <button data-action="load" title="Load">üìÇ</button>
              <button data-action="dup" title="Duplicate">üìã</button>
              <button data-action="del" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join("");

      savesList.querySelectorAll(".save-item").forEach(item => {
        const saveId = item.dataset.saveId;
        item.querySelector("[data-action='load']").onclick = async (e) => {
          e.stopPropagation();
          const league = await loadSave(saveId);
          if (league) {
            state.league = league;
            state.currentSaveId = saveId;
            setSaveStatus("Loaded");
            render();
            refillSavesList();
          }
        };
        item.querySelector("[data-action='dup']").onclick = async (e) => {
          e.stopPropagation();
          const newId = await duplicateSave(saveId);
          if (newId) refillSavesList();
        };
        item.querySelector("[data-action='del']").onclick = async (e) => {
          e.stopPropagation();
          const ok = await deleteSave(saveId);
          if (ok) {
            if (state.currentSaveId === saveId) {
              state.currentSaveId = null;
              state.league = null;
              setSaveStatus("No save");
              render();
            }
            refillSavesList();
            await populateFrontOfficeSaves();
          }
        };
      });
    }

    // Populate Front Office saves with league metadata
    async function populateFrontOfficeSaves() {
      const preview = document.getElementById("foSavePreview");
      if (!preview) return;
      
      // Show loading state
      preview.innerHTML = '<div class="saves-list" style="text-align: center; color: var(--muted); padding: 20px;">Loading leagues‚Ä¶</div>';
      
      try {
        const saves = await listSaves();
        
        if (!saves || saves.length === 0) {
          preview.innerHTML = '<div style="margin-top: 20px; color: var(--muted); font-size: 14px;">No leagues yet. Create one to begin.</div>';
          // Hide Continue button
          const continueBtn = document.getElementById("foContinue");
          if (continueBtn) {
            continueBtn.style.display = "none";
          }
          return;
        }
        
        // Sort by updatedAt descending
        saves.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        
        // Build list HTML
        let html = '<div class="saves-list">';
        
        for (let i = 0; i < saves.length; i++) {
          const save = saves[i];
          const league = await loadSave(save.id);
          
          if (!league) continue;
          
          const isLatest = i === 0;
          const teamCount = league.teams ? league.teams.length : 0;
          const playerCount = league.players ? league.players.length : 0;
          const season = league.meta ? league.meta.season : "?";
          const day = league.meta ? league.meta.day : "?";
          const lastPlayedDate = save.lastOpenedAt 
            ? new Date(save.lastOpenedAt).toLocaleDateString()
            : (save.updatedAt ? new Date(save.updatedAt).toLocaleDateString() : "Never");
          
          html += `
            <div class="save-preview ${isLatest ? 'latest' : ''}" data-save-id="${save.id}" style="cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(save.name)}</div>
                <div style="font-size: 12px; color: var(--muted); line-height: 1.4; margin-bottom: 4px;">
                  Season ${season}, Day ${day} ‚Ä¢ ${teamCount} teams ‚Ä¢ ${playerCount} players
                </div>
                <div style="font-size: 11px; color: var(--muted);">Last played: ${lastPlayedDate}</div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <button class="mini-btn continue-btn" data-save-id="${save.id}" style="white-space: nowrap;">Load</button>
                <button class="mini-btn delete-btn" data-save-id="${save.id}" style="white-space: nowrap; background-color: #ef4444; color: #fff;">Delete</button>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        preview.innerHTML = html;
        
        // Attach event listeners to save items
        preview.querySelectorAll('.save-preview').forEach(item => {
          const saveId = item.dataset.saveId;
          
          // Make entire card clickable (excluding buttons)
          item.addEventListener('click', async (e) => {
            if (e.target.closest('.continue-btn') || e.target.closest('.delete-btn')) return;
            await loadSaveAndEnter(saveId);
          });
          
          // Load button handler
          item.querySelector('.continue-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await loadSaveAndEnter(saveId);
          });
          
          // Delete button handler
          const deleteBtn = item.querySelector('.delete-btn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const ok = await deleteSave(saveId);
              if (ok) {
                if (state.currentSaveId === saveId) {
                  state.currentSaveId = null;
                  state.league = null;
                  setSaveStatus("No save");
                }
                await populateFrontOfficeSaves();
              }
            });
          }
        });
        
        // Show Continue Latest button if leagues exist
        const continueBtn = document.getElementById("foContinue");
        if (continueBtn) {
          continueBtn.style.display = "block";
          continueBtn.disabled = false;
          continueBtn.textContent = "Continue Latest";
        }
        
      } catch (err) {
        console.error("Error populating front office saves:", err);
        preview.innerHTML = '<div style="margin-top: 20px; color: #ff6b6b; font-size: 14px;">‚ùå Error loading leagues</div>';
      }
    }

    // Helper to load save and enter app
    async function loadSaveAndEnter(saveId) {
      const league = await loadSave(saveId);
      if (league) {
        // Update lastOpenedAt timestamp
        const now = Date.now();
        if (db.saves && db.saves.update) {
          await db.saves.update(saveId, { lastOpenedAt: now });
        }

        state.league = league;
        state.currentSaveId = saveId;
        state.userTeamId = league.meta?.userTeamId || null;
        setSaveStatus("Loaded");
        hideAllMenus();
        setRoute("home");
        showBanner("success", `‚úì Loaded "${league.meta?.name || 'League'}"`);
      }
    }

    /**********************
     * 9) UI Events
     **********************/
    document.getElementById("nav").addEventListener("click", (e) => {
      const a = e.target.closest("a[data-route]");
      if (!a) return;
      e.preventDefault();
      setRoute(a.dataset.route);
      document.getElementById("sidebar").classList.remove("open");
    });

    document.getElementById("sim1").addEventListener("click", simDay);
    document.getElementById("sim7").addEventListener("click", () => { for (let i=0;i<7;i++) simDay(); });

    document.getElementById("newLeague").addEventListener("click", async () => {
      if (!state.currentSaveId) {
        showBanner("error", "‚ùå No save open");
        return;
      }
      if (!confirm("Reset this save's league?")) return;
      state.league = defaultLeague();
      state.league.meta.name = (await listSaves()).find(s => s.id === state.currentSaveId)?.name || "League";
      state.selectedTeamId = null;
      state.selectedPlayerId = null;
      await saveCurrentLeague();
      render();
      showBanner("success", "‚úì League reset");
    });

    document.getElementById("toggleSidebar").addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("open");
    });

    document.getElementById("btnNewSave").addEventListener("click", async () => {
      const name = await promptFor("Save name:", "New League");
      if (!name) return;
      const id = await createSave(name);
      if (id) {
        state.league = defaultLeague();
        state.league.meta.name = name;
        state.currentSaveId = id;
        setSaveStatus("Loaded");
        render();
        await refillSavesList();
      }
    });

    document.getElementById("btnExport").addEventListener("click", () => {
      if (!state.league) {
        showBanner("error", "‚ùå No save open");
        return;
      }
      exportCurrentLeague();
    });

    document.getElementById("btnImport").addEventListener("click", async () => {
      const newId = await importLeagueFromFile();
      if (newId) {
        const league = await loadSave(newId);
        if (league) {
          state.league = league;
          state.currentSaveId = newId;
          setSaveStatus("Loaded");
          render();
          await refillSavesList();
        }
      }
    });

    // Hash routing
    window.addEventListener("hashchange", () => {
      const route = (location.hash || "#home").replace("#","").trim();
      const known = ["home","dashboard","league","standings","teams","rotations","schedule","players"];
      setRoute(known.includes(route) ? route : "home");
    });

    // Title Screen Logic
    function hideTitleScreen() {
      const titleScreen = document.getElementById("titleScreen");
      if (titleScreen) {
        titleScreen.classList.add("hidden");
        setTimeout(() => {
          titleScreen.style.display = "none";
        }, 300);
      }
    }

    function hideAllMenus() {
      const titleElem = document.getElementById("titleScreen");
      const foElem = document.getElementById("frontOfficeMenu");
      const clElem = document.getElementById("createLeagueModal");
      
      [titleElem, foElem, clElem].forEach(elem => {
        if (elem) {
          elem.classList.add("hidden");
          elem.style.display = "none";
        }
      });
      
      const app = document.querySelector(".app");
      if (app) app.classList.remove("in-startup-menu");
    }

    function selectTeamForStandings(teamId) {
      state.selectedTeamId = teamId;
      setRoute("teams");
    }

    function setTeamSelection(teamId) {
      state.selectedTeamId = teamId;
      render();
    }

    function selectPlayerFromTeams(playerId) {
      state.selectedPlayerId = playerId;
      setRoute("players");
    }

    // Initialization
    (async () => {
      // Check if user wants to skip title screen
      const skipTitle = localStorage.getItem("hoops_skip_title") === "1";
      
      setSaveStatus("Loading...");
      await initDB();
      
      if (dbError) {
        showBanner("warning", dbErrorMsg);
      }

      // Try to load last opened save
      let lastId = localStorage.getItem("hoops_last_save_id");
      let saves = await listSaves();
      
      if (!saves.length) {
        // First run: create default save
        lastId = await createSave("My League");
      }

      if (lastId && saves.find(s => s.id === lastId)) {
        const league = await loadSave(lastId);
        if (league) {
          state.league = league;
          state.currentSaveId = lastId;
          state.userTeamId = league.meta?.userTeamId || null;
          setSaveStatus("Loaded");
        }
      } else if (saves.length > 0) {
        // Load the most recent save
        saves.sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        const league = await loadSave(saves[0].id);
        if (league) {
          state.league = league;
          state.currentSaveId = saves[0].id;
          state.userTeamId = league.meta?.userTeamId || null;
          setSaveStatus("Loaded");
        }
      }

      if (!state.league) {
        showBanner("error", "‚ùå Failed to load league");
        state.league = defaultLeague();
        setSaveStatus("Offline mode");
      }

      await refillSavesList();

      // Helper function to save skip preference
      function saveSkipPref() {
        const titleSkipCheckbox = document.getElementById("titleSkip");
        if (titleSkipCheckbox && titleSkipCheckbox.checked) {
          localStorage.setItem("hoops_skip_title", "1");
        } else {
          localStorage.removeItem("hoops_skip_title");
        }
      }

      // Handle Title Screen
      const titleEnter = document.getElementById("titleEnter");
      const titleSkipCheckbox = document.getElementById("titleSkip");
      const app = document.querySelector(".app");

      function showTitleScreen() {
        const elem = document.getElementById("titleScreen");
        if (elem) {
          elem.classList.remove("hidden");
          elem.style.display = "flex";
        }
        if (app) app.classList.add("in-startup-menu");
      }

      function hideTitleScreenAndShowMenu() {
        const titleElem = document.getElementById("titleScreen");
        if (titleElem) {
          titleElem.classList.add("hidden");
          setTimeout(() => { titleElem.style.display = "none"; }, 300);
        }
        showFrontOfficeMenu();
      }

      function showFrontOfficeMenu() {
        const elem = document.getElementById("frontOfficeMenu");
        if (elem) {
          elem.classList.remove("hidden");
          elem.style.display = "flex";
          updateFrontOfficePreview();
        }
        if (app) app.classList.add("in-startup-menu");
      }

      function hideFrontOfficeMenu() {
        const elem = document.getElementById("frontOfficeMenu");
        if (elem) {
          elem.classList.add("hidden");
          setTimeout(() => { elem.style.display = "none"; }, 300);
        }
      }

      function hideCreateLeagueModal() {
        const elem = document.getElementById("createLeagueModal");
        if (elem) {
          elem.classList.add("hidden");
          setTimeout(() => { elem.style.display = "none"; }, 300);
        }
        // Reset state for next time
        leagueSize = 30;
        selectedTeamIndices = new Set(Array.from({length: 30}, (_, i) => i));
        selectedManagedTeamId = null;
        
        // Reset UI to defaults
        const sizeButtons = document.querySelectorAll("#createLeagueModal .size-btn");
        sizeButtons.forEach(b => b.classList.remove("selected"));
        const btn30 = document.querySelector('#createLeagueModal .size-btn[data-size="30"]');
        if (btn30) btn30.classList.add("selected");
        
        const title = document.getElementById("teamSelectionTitle");
        if (title) title.textContent = "Select 30 Teams";
        
        const leagueSizeError = document.getElementById("leagueSizeError");
        if (leagueSizeError) leagueSizeError.style.display = "none";
      }

      function updateFrontOfficePreview() {
        populateFrontOfficeSaves();
      }

      // Title Screen: Enter Front Office
      if (titleEnter) {
        titleEnter.addEventListener("click", () => {
          saveSkipPref();
          hideTitleScreenAndShowMenu();
        });
      }

      // Front Office: Create League
      const foCreateLeague = document.getElementById("foCreateLeague");
      if (foCreateLeague) {
        foCreateLeague.addEventListener("click", () => {
          showCreateLeagueModal();
        });
      }

      // Front Office: Continue with current league (Continue Latest)
      const foContinue = document.getElementById("foContinue");
      if (foContinue) {
        foContinue.addEventListener("click", async () => {
          // Load the latest save
          const saves = await listSaves();
          if (saves && saves.length > 0) {
            saves.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
            const latestSave = saves[0];
            const league = await loadSave(latestSave.id);
            if (league) {
              // Update lastOpenedAt timestamp
              const now = Date.now();
              if (db.saves && db.saves.update) {
                await db.saves.update(latestSave.id, { lastOpenedAt: now });
              }

              state.league = league;
              state.currentSaveId = latestSave.id;
              state.userTeamId = league.meta?.userTeamId || null;
              setSaveStatus("Loaded");
              hideAllMenus();
              setRoute("home");
              showBanner("success", `‚úì Loaded "${latestSave.name}"`);
            }
          } else {
            showBanner("error", "‚ùå No league found");
          }
        });
      }

      // Front Office: Load League (go to home, user can click sidebar saves)
      const foLoadLeague = document.getElementById("foLoadLeague");
      if (foLoadLeague) {
        foLoadLeague.addEventListener("click", () => {
          hideAllMenus();
          setRoute("home");
        });
      }

      // Front Office: Import
      const foImport = document.getElementById("foImport");
      if (foImport) {
        foImport.addEventListener("click", async () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";
          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
              try {
                const data = JSON.parse(ev.target.result);
                let league = data.league || data;
                const fromV = data.schemaVersion || 0;
                league = migrateLeague(league, fromV);

                const saveName = await promptFor("Save name:", data.name || "Imported League");
                if (!saveName) return;

                const newId = await createSave(saveName);
                if (newId) {
                  const migrated = migrateLeague(data);
                  if (db.leagues && db.leagues.update) {
                    await db.leagues.update(newId, { blob: migrated, schemaVersion: CURRENT_SCHEMA_VERSION });
                  } else if (dbError) {
                    inMemoryLeagues[newId] = { id: newId, blob: migrated, schemaVersion: CURRENT_SCHEMA_VERSION };
                  }

                  // Update save metadata
                  const now = Date.now();
                  if (db.saves && db.saves.update) {
                    await db.saves.update(newId, { updatedAt: now });
                  }

                  state.league = migrated;
                  state.currentSaveId = newId;
                  state.userTeamId = migrated.meta?.userTeamId || null;
                  setSaveStatus("Loaded");
                  await refillSavesList();
                  await populateFrontOfficeSaves();
                  showBanner("success", "‚úì League imported");
                  updateFrontOfficePreview();
                }
              } catch (err) {
                console.error("Import error:", err);
                showBanner("error", "‚ùå Invalid file: " + err.message);
              }
            };
            reader.readAsText(file);
          };
          input.click();
        });
      }

      // Front Office: Export
      const foExport = document.getElementById("foExport");
      if (foExport) {
        foExport.addEventListener("click", () => {
          if (!state.league) {
            showBanner("error", "‚ùå No league to export");
            return;
          }
          exportCurrentLeague();
        });
      }

      // === CREATE LEAGUE MODAL STATE ===
      let leagueSize = 30;
      let selectedTeamIndices = new Set(Array.from({length: 30}, (_, i) => i)); // All selected by default
      let selectedManagedTeamId = null; // Team to manage (abbrev)

      function updateTeamCounter() {
        const counter = document.getElementById("teamCounter");
        if (counter) {
          const count = selectedTeamIndices.size;
          counter.textContent = `Selected: ${count}/${leagueSize}`;
        }
        
        // Update error message if selection doesn't match
        const leagueSizeError = document.getElementById("leagueSizeError");
        if (leagueSizeError) {
          if (selectedTeamIndices.size !== leagueSize) {
            leagueSizeError.textContent = `‚ö†Ô∏è Select ${leagueSize} teams (currently ${selectedTeamIndices.size})`;
            leagueSizeError.style.display = "block";
          } else {
            leagueSizeError.style.display = "none";
          }
        }
      }

      function renderTeamGrid() {
        const grid = document.getElementById("teamGrid");
        if (!grid) return;
        
        grid.innerHTML = "";
        FICTIONAL_TEAMS.forEach((team, idx) => {
          const card = document.createElement("div");
          card.className = "team-card";
          if (selectedTeamIndices.has(idx)) card.classList.add("selected");
          
          card.innerHTML = `
            <div class="team-logo">${generateTeamLogo(team.abbrev, team.color, 40)}</div>
            <div class="team-name">${team.name}</div>
            <div class="team-abbrev">${team.abbrev}</div>
            <div class="team-info">
              <span>${team.market_size}</span>
              <span>${team.division}</span>
              <span>${team.conference}</span>
            </div>
          `;
          
          card.addEventListener("click", () => {
            // Prevent exceeding league size when clicking
            if (selectedTeamIndices.has(idx)) {
              selectedTeamIndices.delete(idx);
            } else {
              if (selectedTeamIndices.size < leagueSize) {
                selectedTeamIndices.add(idx);
              }
            }
            updateTeamCounter();
            renderTeamGrid();
            renderManagedTeamGrid();
          });
          
          grid.appendChild(card);
        });
      }

      function renderManagedTeamGrid() {
        const grid = document.getElementById("managedTeamGrid");
        if (!grid) return;

        grid.innerHTML = "";
        const selectedTeams = Array.from(selectedTeamIndices).map(idx => FICTIONAL_TEAMS[idx]);
        
        selectedTeams.forEach(team => {
          const card = document.createElement("div");
          card.className = "managed-team-card";
          if (selectedManagedTeamId === team.abbrev) card.classList.add("selected");
          
          card.innerHTML = `
            <div class="managed-team-logo">${generateTeamLogo(team.abbrev, team.color, 36)}</div>
            <div class="managed-team-label">${team.name}</div>
            <div class="managed-team-abbrev">${team.abbrev}</div>
            <div class="managed-team-info">
              <span>${team.market_size}</span>
              <span>${team.division}</span>
              <span>${team.conference}</span>
            </div>
          `;
          
          card.addEventListener("click", () => {
            selectedManagedTeamId = selectedManagedTeamId === team.abbrev ? null : team.abbrev;
            renderManagedTeamGrid(); // Re-render to update selection state
          });
          
          grid.appendChild(card);
        });
      }

      function showCreateLeagueModal() {
        const elem = document.getElementById("createLeagueModal");
        if (elem) {
          elem.classList.remove("hidden");
          elem.style.display = "flex";
          document.getElementById("createLeagueName").focus();
          renderTeamGrid();
          updateTeamCounter();
          renderManagedTeamGrid();
        }
      }

      // Create League Modal: League Size Selector
      const sizeButtons = document.querySelectorAll("#createLeagueModal .size-btn");
      sizeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const newSize = parseInt(btn.dataset.size);
          leagueSize = newSize;
          
          // Update button active state
          sizeButtons.forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          
          // Reset selections to first N teams
          selectedTeamIndices = new Set(Array.from({length: leagueSize}, (_, i) => i));
          selectedManagedTeamId = null;
          
          // Update title
          const title = document.getElementById("teamSelectionTitle");
          if (title) title.textContent = `Select ${leagueSize} Teams`;
          
          // Re-render everything
          updateTeamCounter();
          renderTeamGrid();
          renderManagedTeamGrid();
        });
      });

      // Create League Modal: Team Selection
      const selectAllBtn = document.getElementById("selectAllTeams");
      const selectNoneBtn = document.getElementById("selectNoTeams");
      
      if (selectAllBtn) {
        selectAllBtn.addEventListener("click", () => {
          selectedTeamIndices = new Set(Array.from({length: leagueSize}, (_, i) => i));
          updateTeamCounter();
          renderTeamGrid();
          renderManagedTeamGrid();
        });
      }

      if (selectNoneBtn) {
        selectNoneBtn.addEventListener("click", () => {
          selectedTeamIndices = new Set();
          updateTeamCounter();
          renderTeamGrid();
          renderManagedTeamGrid();
        });
      }

      // Create League Modal: Create button
      const createLeagueBtn = document.getElementById("createLeagueBtn");
      if (createLeagueBtn) {
        createLeagueBtn.addEventListener("click", async () => {
          const name = document.getElementById("createLeagueName").value.trim();
          const year = parseInt(document.getElementById("createLeagueYear").value) || 2026;
          const errorMsg = document.getElementById("teamValidationError");
          
          // Validation
          if (!name) {
            showBanner("error", "‚ùå Please enter a league name");
            return;
          }
          
          if (isNaN(year) || year < 1900 || year > 2500) {
            showBanner("error", "‚ùå Season must be between 1900 and 2500");
            return;
          }
          
          if (selectedTeamIndices.size !== leagueSize) {
            if (errorMsg) errorMsg.style.display = "block";
            showBanner("error", `‚ùå Please select exactly ${leagueSize} teams (currently ${selectedTeamIndices.size})`);
            return;
          }
          
          // Validate managed team selection
          const managedTeamError = document.getElementById("managedTeamError");
          if (!selectedManagedTeamId) {
            if (managedTeamError) managedTeamError.style.display = "block";
            showBanner("error", "‚ùå You must select exactly 1 team to manage");
            return;
          }
          
          if (errorMsg) errorMsg.style.display = "none";
          if (managedTeamError) managedTeamError.style.display = "none";
          
          // Create league with selected teams
          const selectedTeams = Array.from(selectedTeamIndices)
            .sort((a, b) => a - b)
            .map((idx, teamIdx) => {
              const team = FICTIONAL_TEAMS[idx];
              // Assign East/West conferences: first half East, second half West
              const conf = teamIdx < Math.ceil(selectedTeamIndices.size / 2) ? "East" : "West";
              return {
                id: uuid(),
                name: team.name,
                abbrev: team.abbrev,
                color: team.color,
                market_size: team.market_size,
                conference: team.conference,
                division: team.division,
                wins: 0,
                losses: 0,
                cash: 50_000_000,
                conf: conf,
                confWins: 0,
                confLosses: 0,
                homeWins: 0,
                homeLosses: 0,
                roadWins: 0,
                roadLosses: 0,
                last10: [],
                streakType: "‚Äî",
                streakLen: 0
              };
            });

          // Generate players for teams (8 per team minimum)
          const playersPerTeam = Math.max(8, Math.floor(80 / selectedTeams.length)); // Distribute ~80 total evenly
          const players = generatePlayersForTeams(selectedTeams, playersPerTeam);
          
          // Ensure all generated players have valid identities (apply bio generation + names)
          players.forEach(p => {
            ensurePlayerIdentity(p, null, selectedTeams);
          });

          // Create save
          const newId = await createSave(name);
          if (newId) {
            // Find the managed team object
            const managedTeam = selectedTeams.find(t => t.abbrev === selectedManagedTeamId);
            
            // Build league with fictional teams and generated players
            state.league = {
              meta: {
                name: name,
                season: year,
                day: 1,
                phase: "REGULAR_SEASON",
                userTeamId: managedTeam ? managedTeam.id : null,
              },
              teams: selectedTeams,
              players: players,
              log: [`League "${name}" created in ${year}.`, `Now managing ${managedTeam.name} (${managedTeam.abbrev})`],
              schemaVersion: CURRENT_SCHEMA_VERSION
            };

            // Assign conferences/divisions and generate schedule
            assignConferencesAndDivisions(state.league);
            state.league.schedule = generateSchedule(state.league);

            // Initialize rotations for all teams
            state.league.rotations = {};
            selectedTeams.forEach(team => {
              state.league.rotations[team.id] = initializeRotations(team.id, players);
            });

            state.currentSaveId = newId;
            setSaveStatus("Created");

            // Save to Dexie
            if (db.leagues && db.leagues.update) {
              await db.leagues.update(newId, { blob: state.league, schemaVersion: CURRENT_SCHEMA_VERSION });
            } else if (dbError) {
              inMemoryLeagues[newId] = { id: newId, blob: state.league, schemaVersion: CURRENT_SCHEMA_VERSION };
            }

            // Update save metadata (updatedAt and lastOpenedAt)
            const now = Date.now();
            if (db.saves && db.saves.update) {
              await db.saves.update(newId, { updatedAt: now, lastOpenedAt: now });
            }

            await refillSavesList();
            await populateFrontOfficeSaves();
            hideAllMenus();
            state.userTeamId = managedTeam ? managedTeam.id : null;
            setRoute("dashboard");
            showBanner("success", `‚úì League "${name}" created with ${leagueSize} teams!`);
          }
        });
      }

      // Create League Modal: Cancel button
      const createLeagueCancel = document.getElementById("createLeagueCancel");
      if (createLeagueCancel) {
        createLeagueCancel.addEventListener("click", () => {
          hideCreateLeagueModal();
          showFrontOfficeMenu();
        });
      }

      // === Main App Initialization ===
      // Determine startup flow based on skip preference and current save
      function initializeAppFlow() {
        if (skipTitle) {
          // Skip directly to Front Office Menu
          document.getElementById("titleScreen").style.display = "none";
          showFrontOfficeMenu();
        } else {
          // Show Title Screen first
          showTitleScreen();
        }
      }

      // Start the app flow after DB initialization
      initializeAppFlow();

    })();
  </script>
</body>
</html>
